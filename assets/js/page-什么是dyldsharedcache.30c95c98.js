(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{484:function(e,a,r){"use strict";r.r(a);var t=r(1),s=Object(t.a)({},(function(){var e=this,a=e.$createElement,r=e._self._c||a;return r("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[r("h1",{attrs:{id:"什么是-dyld-shared-cache"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#什么是-dyld-shared-cache"}},[e._v("#")]),e._v(" 什么是 dyld_shared_cache")]),e._v(" "),r("h2",{attrs:{id:"背景"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[e._v("#")]),e._v(" 背景")]),e._v(" "),r("p",[e._v("在 iOS 应用开发过程中，必然会利用到系统提供的框架，如 UIKit、Foundation 及 GCD，这些框架都是以动态库的方式提供的，因此在应用启动的过程中，dyld 会负责将这些动态库文件加载到应用的进程空间中。在 iOS 3.1 后，为了加快应用的启动速度，dyld 将所有系统提供的框架都打包到了一个大的缓存文件中，在系统启动之后就会进行加载，这个文件就称为 "),r("code",[e._v("dyld_shared_cache")]),e._v("。之后，在加载任何 macho 镜像前，dyld 都会先尝试在 cache 里去查找，找不到的话再去进行完整的打开、映射和绑定过程。")]),e._v(" "),r("p",[e._v("在 OS X 中，也使用了 dyld_shared_cache，并且原始的二进制文件都存储在磁盘上，因此可以使用 "),r("code",[e._v("update_dyld_shared_cache")]),e._v(" 命令来更新这些文件。在 macOS 11 之后，"),r("code",[e._v("update_dyld_shared_cache")]),e._v(" 这个命令就被苹果废弃了，和 iOS 一样无法动态更新 cache 了。")]),e._v(" "),r("p",[e._v("我们可以利用这些缓存文件来逆向分析系统库的源码，了解系统库的执行过程。本文来介绍一下如何获取和使用这些缓存文件进行分析。")]),e._v(" "),r("h2",{attrs:{id:"获取-dyld-shared-cache"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#获取-dyld-shared-cache"}},[e._v("#")]),e._v(" 获取 dyld_shared_cache")]),e._v(" "),r("h3",{attrs:{id:"从-ipsw-中获取"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#从-ipsw-中获取"}},[e._v("#")]),e._v(" 从 ipsw 中获取")]),e._v(" "),r("p",[r("code",[e._v("dyld_shared_cache")]),e._v(" 能够从 ipsw 文件中提取。在 "),r("a",{attrs:{href:"https://ipsw.me/",target:"_blank",rel:"noopener noreferrer"}},[e._v("ipsw.me"),r("OutboundLink")],1),e._v(" 上可以下载各个型号 iPhone 的 ipsw 文件。下载之后，将该文件的后缀名改为 .zip，然后进行解压。在解压后的文件夹里，双击其中文件体积最大的 dmg 文件，然后进入 "),r("code",[e._v("/System/Library/Caches/com.apple.dyld/")]),e._v("，就可以将 "),r("code",[e._v("dyld_shared_cache")]),e._v(" 复制导出了。")]),e._v(" "),r("p",[r("img",{attrs:{src:"https://tamarous-blog-1256169911.cos.ap-chengdu.myqcloud.com/2021/12/04/16386267613890.jpg",alt:"16386267613890"}})]),e._v(" "),r("h2",{attrs:{id:"还原-dyld-shared-cache"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#还原-dyld-shared-cache"}},[e._v("#")]),e._v(" 还原 dyld_shared_cache")]),e._v(" "),r("p",[e._v("在导出后，还需要一些工具来将系统库从二进制文件中还原出来。苹果官方就提供了一个可用的工具："),r("a",{attrs:{href:"https://opensource.apple.com/source/dyld/dyld-433.5/launch-cache/",target:"_blank",rel:"noopener noreferrer"}},[e._v("dsc_extractor"),r("OutboundLink")],1),e._v("，不过这个工具是位于 dyld 源码中的，需要一些额外设置才能编译出来。")]),e._v(" "),r("p",[e._v("首先我们先从苹果开源网站上下载 dyld 的"),r("a",{attrs:{href:"https://opensource.apple.com/tarballs/dyld/",target:"_blank",rel:"noopener noreferrer"}},[e._v("代码"),r("OutboundLink")],1),e._v("，我这里选择的是较旧的 "),r("code",[e._v("dyld-519.2.2")]),e._v("，之所以不选最新的版本，是由于较新的版本在编译时，会有"),r("code",[e._v("CodeSigningTypes.h")]),e._v(" 和 "),r("code",[e._v("Diagnostics.h")]),e._v(" 两个头文件找不到的错误。下载解压后，进入 "),r("code",[e._v("launch-cache")]),e._v(" 目录，修改 "),r("code",[e._v("dsc_extractor.cpp")]),e._v(" main 函数之前的 "),r("code",[e._v("if 0")]),e._v(" 为 "),r("code",[e._v("if 1")]),e._v("，然后再用 clang 进行编译：")]),e._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("clang++ -o dsc_extractor ./dsc_extractor.cpp dsc_iterator.cpp\n")])]),e._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[e._v("1")]),r("br")])]),r("p",[e._v("编译出可执行文件后，我们就可以使用此可执行文件来从 dyld_shared_cache 中导出系统库：")]),e._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("./dsc_extractor dyld_shared_cache_arm64e ./frameworks\n")])]),e._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[e._v("1")]),r("br")])]),r("p",[r("img",{attrs:{src:"https://tamarous-blog-1256169911.cos.ap-chengdu.myqcloud.com/2021/12/04/16386332421419.jpg",alt:"16386332421419"}})]),e._v(" "),r("p",[e._v("除了上述苹果官方提供的工具外，"),r("a",{attrs:{href:"https://github.com/arandomdev/DyldExtractor",target:"_blank",rel:"noopener noreferrer"}},[e._v("DyldExtractor"),r("OutboundLink")],1),e._v(" 也是一个不错的工具：")]),e._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("python3 -m pip install dyldextractor\ndyldex_all dyld_shared_cache_arm64e\n")])]),e._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[e._v("1")]),r("br"),r("span",{staticClass:"line-number"},[e._v("2")]),r("br")])]),r("p",[e._v("在获取到系统库的二进制之后，就可以使用如 Hopper 及 IDA 这样的工具来进行逆向分析了。")])])}),[],!1,null,null,null);a.default=s.exports}}]);