<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SDWebImage æºä»£ç å‰–æ-å¤šçº¿ç¨‹ç­–ç•¥</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="manifest" href="/blog/manifest.webmanifest" crossorigin="use-credentials">
    <meta name="description" content="">
    <meta property="og:url" content="/blog/iOS/sdwebimage_multithread.html">
    <meta property="og:title" content="SDWebImage æºä»£ç å‰–æ-å¤šçº¿ç¨‹ç­–ç•¥">
    <meta property="og:description" content="SDWebImage æºä»£ç å‰–æ-å¤šçº¿ç¨‹ç­–ç•¥ å‰ä¸€ç¯‡æ–‡ç« ä»ç¼“å­˜ç­–ç•¥çš„è§’åº¦åˆ†æäº†SDWebImage çš„éƒ¨åˆ†ä»£ç ï¼Œä¸‹é¢ä»å¤šçº¿ç¨‹çš„è§’åº¦å¯¹å®ƒçš„å…¶ä»–æ¨¡å—è¿›è¡Œåˆ†æã€‚ è‹¹æœçš„å¤šçº¿ç¨‹è§£å†³æ–¹æ¡ˆæœ‰ä¸‰ç§ï¼š NSThread; GCD; NSOperation; åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¾€å¾€åªä½¿ç”¨GCD å’ŒNSOperationã€‚ å…³äºåº”è¯¥å¦‚ä½•åœ¨GCD å’ŒNSOperation ä¸­è¿›è¡Œ">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="en-US">
    <meta name="twitter:card" content="summary_large_image">
    <meta property="article:tag" content="æºç åˆ†æ">
    <meta name="theme-color" content="#46bd87">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    
    <link rel="preload" href="/blog/assets/css/0.styles.8b5d14a7.css" as="style"><link rel="preload" href="/blog/assets/js/app.df73a9a4.js" as="script"><link rel="preload" href="/blog/assets/js/vendors~layout-Layout.751f6b56.js" as="script"><link rel="preload" href="/blog/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.4f318220.js" as="script"><link rel="preload" href="/blog/assets/js/page-SDWebImageæºä»£ç å‰–æ-å¤šçº¿ç¨‹ç­–ç•¥.2154a0a5.js" as="script"><link rel="preload" href="/blog/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.335ce4c4.js" as="script"><link rel="prefetch" href="/blog/assets/js/52.b3a05f52.js"><link rel="prefetch" href="/blog/assets/js/layout-Blog.cd958aaa.js"><link rel="prefetch" href="/blog/assets/js/layout-Layout.54347a9b.js"><link rel="prefetch" href="/blog/assets/js/layout-NotFound.5814876d.js"><link rel="prefetch" href="/blog/assets/js/layout-Slide.7b34a4ba.js"><link rel="prefetch" href="/blog/assets/js/page-Aspectsæºç åˆ†æ.f472509c.js"><link rel="prefetch" href="/blog/assets/js/page-EasyTupleæºä»£ç åˆ†æ.dbf9e78d.js"><link rel="prefetch" href="/blog/assets/js/page-Hello!.21062866.js"><link rel="prefetch" href="/blog/assets/js/page-Home.b36aff0d.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-100-SameTreeåŠ572-SubtreeofAnotherTree.845a9f5d.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-101-SymmetricTree.fe2cc86c.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-112-PathSum.fa4b9369.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-113-PathSumâ…¡.4aad22d2.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-120-Triangle.712ef98c.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-191-Numberof1Bits.33046e6d.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-198-HouseRobber.07ab4a7e.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-2-AddTwoNumbers.bfb710bc.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-21-MergeTwoSortedLists.0da4fd95.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-234-PalindromeLinkedList.d1b72571.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-238-ProductofArrayExceptSelf.945dd596.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-28-ImplementstrStr().1f60c28a.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-347-TopKFrequentElements.7c94685f.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-437-PathSumâ…¢.fc74b8cc.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-48-RotateImage.4eb31875.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-494-TargetSum.54ed4fde.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-62-UniquePaths.3965e239.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-63-UniquePathsâ…¡.3397f865.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode.b7f07569.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCodeä¸Šå‡ é“ç»å…¸çš„æ’åˆ—ç»„åˆé¢˜.0df3c81a.js"><link rel="prefetch" href="/blog/assets/js/page-Masonryæºä»£ç å‰–æ.4dd591af.js"><link rel="prefetch" href="/blog/assets/js/page-SDWebImageæºä»£ç å‰–æ-ç¼“å­˜ç­–ç•¥.66c0b61c.js"><link rel="prefetch" href="/blog/assets/js/page-SDWebImageæºä»£ç å‰–æ-ç½‘ç»œéƒ¨åˆ†.8b4e1ac6.js"><link rel="prefetch" href="/blog/assets/js/page-ä¸é‡å¤æ‰“å°æ’åºæ•°ç»„ä¸­ç›¸åŠ å’Œä¸ºç»™å®šå€¼çš„æ‰€æœ‰äºŒå…ƒç»„ä¸‰å…ƒç»„.d34496f6.js"><link rel="prefetch" href="/blog/assets/js/page-äºŒå‰æ ‘çš„Morriséå†.0b3a52cc.js"><link rel="prefetch" href="/blog/assets/js/page-å‰ä¸­ååºéå†çš„éé€’å½’å®ç°.54cce868.js"><link rel="prefetch" href="/blog/assets/js/page-å•é“¾è¡¨é—®é¢˜æ€»ç»“.28a92876.js"><link rel="prefetch" href="/blog/assets/js/page-åœ¨å…¶ä»–æ•°å­—éƒ½å‡ºç°Kæ¬¡çš„æ•°ç»„ä¸­æ‰¾åˆ°åªå‡ºç°Mæ¬¡çš„æ•°å­—.a7e218e0.js"><link rel="prefetch" href="/blog/assets/js/page-åœ¨æ•°ç»„ä¸­æ‰¾åˆ°å‡ºç°æ¬¡æ•°å¤§äºNKçš„æ•°.a45a1fa0.js"><link rel="prefetch" href="/blog/assets/js/page-æŒ‰å±‚æ‰“å°äºŒå‰æ ‘.b6147bf9.js"><link rel="prefetch" href="/blog/assets/js/page-æ­å¼€Runtimeçš„ç¥ç§˜é¢çº±.fc2f7ce9.js"><link rel="prefetch" href="/blog/assets/js/page-æœ€å¤§å…¬çº¦æ•°å’Œæœ€å°å…¬å€æ•°.43bb0121.js"><link rel="prefetch" href="/blog/assets/js/page-æœ€å¤§å­åºåˆ—å’Œé—®é¢˜.e334cc90.js"><link rel="prefetch" href="/blog/assets/js/page-æºç åˆ†æ.3e7b7e99.js"><link rel="prefetch" href="/blog/assets/js/page-ç”±å‰åºå’Œä¸­åºéå†æ¢å¤äºŒå‰æ ‘ç»“æ„.76d27828.js"><link rel="prefetch" href="/blog/assets/js/page-è°ƒæ•´æ•°ç»„ä¸­å…ƒç´ çš„é¡ºåº.9ba9fdb6.js"><link rel="prefetch" href="/blog/assets/js/page-é€’å½’åœ¨äºŒå‰æ ‘ç›¸å…³é¢˜ç›®ä¸­çš„åº”ç”¨.efd4c29a.js"><link rel="prefetch" href="/blog/assets/js/vendors~photo-swipe.b7933859.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.8b5d14a7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container has-navbar has-anchor"><header class="navbar"><!----> <div class="content__navbar-start"></div> <button title="Sidebar Button" class="sidebar-button"><span class="icon"></span></button> <a href="/blog/" class="home-link router-link-active"></a> <!----> <div class="content__navbar-center"></div> <div class="links"><button tabindex="-1" aria-hidden="true" class="color-button"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="skin-icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4
        38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32
        51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0
        102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2
        6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4
        0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2
        9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224
        419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4
        470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0
        22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6
        12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128
        505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2
        16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8
        86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4
        80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6
        6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><ul class="themecolor-select"><label for="themecolor-select">Theme Color:</label> <li><span class="default-theme"></span></li> </ul> <div class="darkmode-toggle"><label for="darkmode-toggle" class="desc">Theme Mode:</label> <div class="darkmode-switch"><div class="item day"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon light-icon"><path d="M512 256a42.667 42.667 0 0 0 42.667-42.667V128a42.667 42.667 0 0 0-85.334 0v85.333A42.667 42.667 0 0 0 512 256zm384 213.333h-85.333a42.667 42.667 0 0 0 0 85.334H896a42.667 42.667 0 0 0 0-85.334zM256 512a42.667 42.667 0 0 0-42.667-42.667H128a42.667 42.667 0 0 0 0 85.334h85.333A42.667 42.667 0 0 0 256 512zm9.387-298.667a42.667 42.667 0 0 0-59.307 62.72l61.44 59.307a42.667 42.667 0 0 0 31.147 11.947 42.667 42.667 0 0 0 30.72-13.227 42.667 42.667 0 0 0 0-60.16zm459.946 133.974a42.667 42.667 0 0 0 29.44-11.947l61.44-59.307a42.667 42.667 0 0 0-57.6-62.72l-61.44 60.587a42.667 42.667 0 0 0 0 60.16 42.667 42.667 0 0 0 28.16 13.227zM512 768a42.667 42.667 0 0 0-42.667 42.667V896a42.667 42.667 0 0 0 85.334 0v-85.333A42.667 42.667 0 0 0 512 768zm244.48-79.36a42.667 42.667 0 0 0-59.307 61.44l61.44 60.587a42.667 42.667 0 0 0 29.44 11.946 42.667 42.667 0 0 0 30.72-12.8 42.667 42.667 0 0 0 0-60.586zm-488.96 0-61.44 59.307a42.667 42.667 0 0 0 0 60.586 42.667 42.667 0 0 0 30.72 12.8 42.667 42.667 0 0 0 28.587-10.666l61.44-59.307a42.667 42.667 0 0 0-59.307-61.44zM512 341.333A170.667 170.667 0 1 0 682.667 512 170.667 170.667 0 0 0 512 341.333z" fill="currentColor"></path></svg></div> <div class="item auto active"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon auto-icon"><path d="M460.864 539.072H564.8L510.592 376l-49.728 163.072zM872 362.368V149.504H659.648L510.528 0l-149.12 149.504H149.12v212.928L0 511.872l149.12 149.504v212.928h212.352l149.12 149.504 149.12-149.504h212.352V661.376l149.12-149.504L872 362.368zM614.464 693.12l-31.616-90.624H438.272l-31.616 90.624h-85.888l144.576-407.68h90.368l144.576 407.68h-85.824zm0 0" fill="currentColor"></path></svg></div> <div class="item night"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon dark-icon"><path d="M935.539 630.402c-11.43-11.432-28.674-14.739-43.531-8.354-46.734 20.103-96.363 30.297-147.508 30.297-99.59 0-193.221-38.784-263.64-109.203-108.637-108.637-139.61-270.022-78.908-411.148a39.497 39.497 0 0 0-51.886-51.887c-52.637 22.64-100.017 54.81-140.826 95.616-85.346 85.346-132.346 198.821-132.346 319.52 0 120.7 47.001 234.172 132.347 319.519S408.063 947.11 528.76 947.11c120.7 0 234.172-47.003 319.52-132.351 40.809-40.81 72.978-88.19 95.616-140.826a39.497 39.497 0 0 0-8.356-43.532z" fill="currentColor"></path></svg></div></div> <!----></div></div></div></button> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active"><!---->
  Home
</a></div><div class="nav-item"><a href="/blog/iOS/" class="nav-link router-link-active active"><!---->
  iOS
</a></div><div class="nav-item"><a href="/blog/Algorithms/" class="nav-link"><!---->
  Algorithms
</a></div></nav> <!----> <a rel="noopener noreferrer" href="https://github.com/tamarous/blog" target="_blank" class="repo-link can-hide">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <!----> <div class="content__navbar-end"></div></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!----> <!----> <div class="content__sidebar-top"></div> <nav class="sidebar-nav-links"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active"><!---->
  Home
</a></div><div class="nav-item"><a href="/blog/iOS/" class="nav-link router-link-active active"><!---->
  iOS
</a></div><div class="nav-item"><a href="/blog/Algorithms/" class="nav-link"><!---->
  Algorithms
</a></div> <a rel="noopener noreferrer" href="https://github.com/tamarous/blog" target="_blank" class="repo-link">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <!----> <div class="content__sidebar-center"></div> <!----> <!----> <div class="content__sidebar-bottom"></div> <!----></aside> <main class="page"><nav class="breadcrumb"><ol vocab="https://schema.org/" typeof="BreadcrumbList"><li property="itemListElement" typeof="ListItem"><a href="/blog/iOS/" property="item" typeof="WebPage" class="router-link-active"><!----> <span property="name">æºç åˆ†æ</span></a> <meta property="position" content="1"></li><li property="itemListElement" typeof="ListItem" class="is-active"><a href="/blog/iOS/sdwebimage_multithread/" aria-current="page" property="item" typeof="WebPage" class="router-link-exact-active router-link-active"><!----> <span property="name">SDWebImage æºä»£ç å‰–æ-å¤šçº¿ç¨‹ç­–ç•¥</span></a> <meta property="position" content="2"></li></ol></nav> <!----> <div class="content__page-top"></div> <div vocab="https://schema.org/" typeof="Article" class="page-title"><h1><!----> <span property="headline">SDWebImage æºä»£ç å‰–æ-å¤šçº¿ç¨‹ç­–ç•¥</span></h1> <div class="page-info"><!----> <!----><!----><span aria-label="Writing DateğŸ“…" data-balloon-pos="down" class="time-info"><svg viewBox="0 0 1030 1024" xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H180.6A134.314 134.314 0 0 0 46.66 277.595v535.756A134.314 134.314 0 0 0 180.6 947.289h669.74a134.36 134.36 0 0 0 133.94-133.938V277.595a134.314 134.314 0 0 0-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 0 1-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 0 1-33.472 33.473z" fill="currentColor"></path></svg> <span property="datePublished">2021-8-29</span></span><span role="navigation" aria-label="CategoryğŸŒˆ" data-balloon-pos="down" class="category-info enable"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon category-icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zm-.854 446.486H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zm446.371-446.486h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zm136.293 813.51H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z" fill="currentColor"></path></svg> <span property="articleSection">IOS</span></span><span aria-label="TagsğŸ·" data-balloon-pos="down"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon tag-icon"><path d="M939.902 458.563 910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 0 0 0 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z" fill="currentColor"></path></svg> <ul class="tags-wrapper"><li class="tag clickable tag0"><span role="navigation">æºç åˆ†æ</span></li></ul> <meta property="keywords" content="æºç åˆ†æ"></span><span aria-label="Reading TimeâŒ›" data-balloon-pos="down" class="reading-time-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon timer-icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z" fill="currentColor"></path></svg> <span>About 11 min</span> <meta property="timeRequired" content="PT11M"></span></div> <!----> <hr></div> <div class="anchor-place-holder"><aside id="anchor"><div class="anchor-wrapper"><ul class="anchor-list"><li class="anchor"><a href="/blog/iOS/sdwebimage_multithread/#nsoperation" class="anchor-link heading2"><div>NSOperation</div></a></li><li class="anchor"><a href="/blog/iOS/sdwebimage_multithread/#å®ç°è‡ªå®šä¹‰çš„nsoperation-å­ç±»" class="anchor-link heading3"><div>å®ç°è‡ªå®šä¹‰çš„NSOperation å­ç±»</div></a></li><li class="anchor"><a href="/blog/iOS/sdwebimage_multithread/#è‡ªå®šä¹‰operation-å¯¹è±¡çš„æ‰§è¡Œè¡Œä¸º" class="anchor-link heading3"><div>è‡ªå®šä¹‰operation å¯¹è±¡çš„æ‰§è¡Œè¡Œä¸º</div></a></li><li class="anchor"><a href="/blog/iOS/sdwebimage_multithread/#æ‰§è¡Œoperations" class="anchor-link heading3"><div>æ‰§è¡Œoperations</div></a></li><li class="anchor"><a href="/blog/iOS/sdwebimage_multithread/#sdwebimage-ä¸­çš„å®ç°" class="anchor-link heading2"><div>SDWebImage ä¸­çš„å®ç°</div></a></li><li class="anchor"><a href="/blog/iOS/sdwebimage_multithread/#sdwebimagedownloader" class="anchor-link heading3"><div>SDWebImageDownloader</div></a></li></ul></div></aside></div> <!----> <div class="content__content-top"></div> <div class="theme-default-content content__default"><h1 id="sdwebimage-æºä»£ç å‰–æ-å¤šçº¿ç¨‹ç­–ç•¥"><a href="#sdwebimage-æºä»£ç å‰–æ-å¤šçº¿ç¨‹ç­–ç•¥" class="header-anchor">#</a> SDWebImage æºä»£ç å‰–æ-å¤šçº¿ç¨‹ç­–ç•¥</h1> <p>å‰ä¸€ç¯‡<a href="/blog/iOS/sdwebimage_cache.html">æ–‡ç« </a>ä»ç¼“å­˜ç­–ç•¥çš„è§’åº¦åˆ†æäº†<code>SDWebImage</code> çš„éƒ¨åˆ†ä»£ç ï¼Œä¸‹é¢ä»å¤šçº¿ç¨‹çš„è§’åº¦å¯¹å®ƒçš„å…¶ä»–æ¨¡å—è¿›è¡Œåˆ†æã€‚</p> <p>è‹¹æœçš„å¤šçº¿ç¨‹è§£å†³æ–¹æ¡ˆæœ‰ä¸‰ç§ï¼š</p> <ul><li>NSThread</li> <li>GCD</li> <li>NSOperation</li></ul> <p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¾€å¾€åªä½¿ç”¨GCD å’ŒNSOperationã€‚
å…³äºåº”è¯¥å¦‚ä½•åœ¨GCD å’ŒNSOperation ä¸­è¿›è¡Œé€‰æ‹©ï¼ŒStackOverflow ä¸Šå·²ç»æœ‰å¾ˆå¤šè¯¦ç»†å’Œæ·±å…¥çš„<a href="http://stackoverflow.com/a/10375616/6552680" target="_blank" rel="noopener noreferrer">è®¨è®º<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ã€‚æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬åªä»‹ç» NSOperation ã€‚</p> <h2 id="nsoperation"><a href="#nsoperation" class="header-anchor">#</a> NSOperation</h2> <p>NSOperation å®šä¹‰åœ¨Foundation æ¡†æ¶ä¸­ï¼Œè¡¨ç¤ºä¸€ä¸ªç”¨æ¥å®ŒæˆæŸé¡¹å·¥ä½œçš„æ“ä½œã€‚å®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå› æ­¤åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œå¿…é¡»è®©ä¸€ä¸ªç±»ç»§æ‰¿å®ƒï¼Œç„¶åå®ç°æŸäº›æ–¹æ³•ã€‚Foundation ä¸ºæˆ‘ä»¬äº‹å…ˆå®šä¹‰å¥½äº†ä¸¤ä¸ªå­ç±»ï¼Œåˆ†åˆ«æ˜¯<code>NSInvocationOperation</code> å’Œ<code>NSBlockOperation</code>ï¼Œè¿™ä¸¤ä¸ªç±»å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œä½†æ˜¯å®ƒä»¬çš„é€‚ç”¨åœºæ™¯æ˜¯ä¸åŒçš„ï¼š</p> <table><thead><tr><th>ç±»</th> <th>æè¿°</th></tr></thead> <tbody><tr><td>NSInvocationOperation</td> <td>A class you use as-is to create an operation object based on an object and selector from your application. You can use this class in cases where you have an existing method that already performs the needed task.</td></tr> <tr><td>NSBlockOperation</td> <td>A class you use as-is to execute one or more block objects concurrently. Because it can execute more than one block, a block operation object operates using a group semantic; only when all of the associated blocks have finished executing is the operation itself considered finished.</td></tr></tbody></table> <h3 id="å®ç°è‡ªå®šä¹‰çš„nsoperation-å­ç±»"><a href="#å®ç°è‡ªå®šä¹‰çš„nsoperation-å­ç±»" class="header-anchor">#</a> å®ç°è‡ªå®šä¹‰çš„NSOperation å­ç±»</h3> <p>å¦‚æœè¯´ä¸Šé¢æåˆ°çš„ä¸¤ä¸ªå­ç±»ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è‡ªå·±å»å®ç°ä¸€ä¸ªNSOperation çš„å­ç±»ã€‚
å¦‚æœä½ çš„è¿™ä¸ªå­ç±»æ˜¯éå¹¶è¡Œçš„ï¼Œé‚£å¾ˆå¥½åŠï¼Œåªè¦å®ç°ä¸‹é¢ä¸¤ä¸ªæ–¹æ³•ï¼ŒåŠ ä¸Šå¯¹å–æ¶ˆæ“ä½œçš„å“åº”å³å¯ï¼›å¦‚æœå­ç±»æ˜¯å¹¶è¡Œçš„ï¼Œé‚£ç¨å¾®å¤æ‚ä¸€äº›ï¼Œè¿˜éœ€è¦é‡è½½NSOperation ä¸­çš„æŸäº›æ–¹æ³•ã€‚
æˆ‘ä»¬å…ˆçœ‹ä¸‹å¹¶è¡Œå’Œä¸²è¡Œå­ç±»éƒ½å¿…é¡»å®ç°çš„å‡ ä¸ªæ–¹æ³•ã€‚</p> <h4 id="æ¯ä¸ªoperation-å¯¹è±¡éƒ½åº”è¯¥å®ç°çš„æ–¹æ³•"><a href="#æ¯ä¸ªoperation-å¯¹è±¡éƒ½åº”è¯¥å®ç°çš„æ–¹æ³•" class="header-anchor">#</a> æ¯ä¸ªoperation å¯¹è±¡éƒ½åº”è¯¥å®ç°çš„æ–¹æ³•</h4> <ul><li>ä¸€ä¸ªè‡ªå®šä¹‰<code>initialization</code> æ–¹æ³•</li> <li><code>main</code> æ–¹æ³•</li></ul> <p><code>initialization</code> ç”¨äºå¯¹operation å¯¹è±¡è¿›è¡Œåˆå§‹åŒ–è®¾ç½®ï¼Œ<code>main</code>ç”¨äºæ‰§è¡Œå…·ä½“çš„ä»»åŠ¡ã€‚</p> <p>å…¶ä»–çš„æ–¹æ³•åˆ™å¯ä»¥æ ¹æ®éœ€è¦æ¥å®ç°ï¼Œæ¯”å¦‚è¯´ï¼š</p> <ul><li>ç”¨äºåœ¨<code>main</code> ä¸­è°ƒç”¨çš„è¾…åŠ©æ–¹æ³•</li> <li>ç”¨äºè®¾ç½®å’Œè·å–operation å¯¹è±¡çš„æ•°æ®çš„<code>accessor</code>æ–¹æ³•</li> <li>ç”¨äºåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„NSCoding åè®®ä¸­çš„æŸäº›æ–¹æ³•</li></ul> <p>ä¸‹é¢æ˜¯ä¸€ä¸ªNSOperation å­ç±»å¯èƒ½çš„æ ·å­ï¼š</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@interface MyNonConcurrentOperation : NSOperation
@property id (strong) myData;
-(id)initWithData:(id)data;
@end
 
@implementation MyNonConcurrentOperation
- (id)initWithData:(id)data {
   if (self = [super init])
      myData = data;
   return self;
}
 
-(void)main {
   @try {
      // Do some work on myData and report the results.
   }
   @catch(...) {
      // Do not rethrow exceptions.
   }
}
@end
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="å¯¹å–æ¶ˆæ“ä½œåšå‡ºå“åº”"><a href="#å¯¹å–æ¶ˆæ“ä½œåšå‡ºå“åº”" class="header-anchor">#</a> å¯¹å–æ¶ˆæ“ä½œåšå‡ºå“åº”</h4> <p>æ³¨æ„ï¼Œä¸Šé¢çš„é‚£ä¸ªä¾‹å­æ²¡æœ‰å®ç°å¯¹å–æ¶ˆæ“ä½œçš„å“åº”ã€‚è€Œäº‹å®ä¸Šï¼Œå¯¹å–æ¶ˆäº‹ä»¶ä½œå‡ºå“åº”æ˜¯operation å¯¹è±¡çš„ä¸€ä¸ªé‡è¦å·¥ä½œã€‚å½“ä¸€ä¸ªoperation å¯¹è±¡è¢«æ‰§è¡Œåï¼Œå®ƒä¼šä¸€ç›´è¿è¡Œï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆæˆ–è€…æ˜¯æ“ä½œè¢«å–æ¶ˆï¼Œè€Œå–æ¶ˆæ“ä½œç”šè‡³å¯èƒ½å‘ç”Ÿåœ¨ä»»åŠ¡å¼€å§‹æ‰§è¡Œä¹‹å‰ã€‚å½“æ“ä½œè¢«å–æ¶ˆçš„æ—¶å€™ï¼Œoperation å¯¹è±¡éœ€è¦å›æ”¶å·²ç»è¢«åˆ†é…çš„èµ„æºï¼Œå¹¶ä¸”ä¼˜é›…åœ°é€€å‡ºã€‚</p> <p>ä¸ºäº†èƒ½å¯¹å–æ¶ˆæ“ä½œä½œå‡ºååº”ï¼Œåœ¨ä»£ç ä¸­åº”è¯¥å‘¨æœŸæ€§åœ°è°ƒç”¨operation å¯¹è±¡çš„<code>isCancelled</code> æ–¹æ³•ã€‚æ›´è¿›ä¸€æ­¥åœ°è¯´ï¼Œåº”è¯¥æ˜¯åœ¨å¦‚ä¸‹å‡ ä¸ªåœºæ™¯å¤„è°ƒç”¨æ­¤æ–¹æ³•ï¼š</p> <ul><li>å½“è¿›è¡Œä»»ä½•å®é™…æ€§çš„å·¥ä½œæ—¶ã€‚</li> <li>åœ¨æ¯æ¬¡å¾ªç¯ä¸­è‡³å°‘è°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚æœæ¯æ¬¡å¾ªç¯çš„æ—¶é—´å¾ˆä¹…ï¼Œåˆ™å¯ä»¥åœ¨ä¸€æ¬¡å¾ªç¯ä¸­å¤šæ¬¡è°ƒç”¨ã€‚è¿™ä¸ªæ–¹æ³•æœ¬èº«çš„å¼€é”€å¾ˆå°ï¼Œå› æ­¤ä¸å¿…æ‹…å¿ƒå¤šæ¬¡è°ƒç”¨ä¼šå¸¦æ¥æ€§èƒ½ä¸Šçš„ä¸‹é™ã€‚</li> <li>å½“å–æ¶ˆæ“ä½œå¾ˆå¯èƒ½å‘ç”Ÿçš„æ—¶å€™ã€‚</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>- (void)main {
   @try {
      BOOL isDone = NO;
 
      while (![self isCancelled] &amp;&amp; !isDone) {
          // Do some work and set isDone to YES when finished
      }
   }
   @catch(...) {
      // Do not rethrow exceptions.
   }
}

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="å¹¶è¡Œoperation-å¯¹è±¡çš„é…ç½®"><a href="#å¹¶è¡Œoperation-å¯¹è±¡çš„é…ç½®" class="header-anchor">#</a> å¹¶è¡Œoperation å¯¹è±¡çš„é…ç½®</h4> <blockquote><p>Operation objects execute in a synchronous manner by defaultâ€”that is, they perform their task in the thread that calls their start method.</p></blockquote> <p>ä¸‹é¢è¿™å¼ è¡¨åˆ—å‡ºäº†å¹¶è¡Œoperation å¯¹è±¡æ‰€éœ€è¦é‡è½½çš„ä¸€äº›æ–¹æ³•ã€‚</p> <table><thead><tr><th>æ–¹æ³•</th> <th>ç±»å‹</th> <th>æè¿°</th></tr></thead> <tbody><tr><td>start</td> <td>å¿…é¡»å®ç°</td> <td>é€šå¸¸åœ¨è¿™ä¸ªæ–¹æ³•ä¸­æ¥è®¾ç½®å¹¶è¡Œä»»åŠ¡çš„æ‰§è¡Œç¯å¢ƒï¼Œå¦‚å…·ä½“çš„çº¿ç¨‹ç­‰ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯operation å¯¹è±¡çš„èµ·å§‹ç‚¹ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ä¸å¯ä»¥è°ƒç”¨super çš„æ–¹æ³•ã€‚</td></tr> <tr><td>main</td> <td>å¯é€‰çš„</td> <td>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å®ç°å…·ä½“è¦å®Œæˆçš„ä»»åŠ¡ã€‚è™½ç„¶å®ç°ä¹Ÿå¯ä»¥æ”¾åœ¨start æ–¹æ³•ä¸­æ¥åšï¼Œä½†æ˜¯æ”¾åœ¨main æ–¹æ³•ä¸­å¯ä»¥ä½¿å¾—è®¾ç½®å’Œæ‰§è¡Œåˆ†ç¦»ï¼Œä½¿å¾—ä»£ç çš„é€»è¾‘æ›´åŠ æ¸…æ™°ã€‚</td></tr> <tr><td>isExecuting, isFinished</td> <td>å¿…é¡»å®ç°</td> <td>è¿™ä¸¤ä¸ªæ–¹æ³•ç”¨æ¥å‘å¤–éƒ¨å¯¹è±¡æŠ¥å‘Šoperation å¯¹è±¡çš„è¿è¡ŒçŠ¶æ€ã€‚ è¿™ä¸¤ä¸ªæ–¹æ³•çš„å®ç°å¿…é¡»æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</td></tr> <tr><td>isConcurrent</td> <td>å¿…é¡»å®ç°</td> <td>ä¸ºäº†ç¡®è®¤ä¸€ä¸ªoperation å¯¹è±¡æ˜¯å¦æ˜¯å¹¶è¡Œçš„ï¼Œéœ€è¦é‡è½½è¿™ä¸ªæ–¹æ³•ï¼Œè®©å®ƒè¿”å›YESã€‚</td></tr></tbody></table> <p>æœ‰äº†ä»¥ä¸ŠçŸ¥è¯†ä½œé“ºå«ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ä¸€ä¸ªå¹¶è¡Œoperation å¯¹è±¡åº”è¯¥æ€ä¹ˆå®Œæ•´åœ°å®ç°ï¼š</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@interface MyOperation : NSOperation {
    BOOL        executing;
    BOOL        finished;
}
- (void)completeOperation;
@end
 
@implementation MyOperation
- (id)init {
    self = [super init];
    if (self) {
        executing = NO;
        finished = NO;
    }
    return self;
}
 
- (void)start {
   // Always check for cancellation before launching the task.
   if ([self isCancelled])
   {
      // Must move the operation to the finished state if it is canceled.
      [self willChangeValueForKey:@&quot;isFinished&quot;];
      finished = YES;
      [self didChangeValueForKey:@&quot;isFinished&quot;];
      return;
   }
 
   // If the operation is not canceled, begin executing the task.
   [self willChangeValueForKey:@&quot;isExecuting&quot;];
   
   // åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸Šæ‰§è¡Œmain æ–¹æ³•
   [NSThread detachNewThreadSelector:@selector(main) toTarget:self withObject:nil];
   executing = YES;
   [self didChangeValueForKey:@&quot;isExecuting&quot;];
}

- (void)main {
   @try {
 
       // Do the main work of the operation here.
 
       [self completeOperation];
   }
   @catch(...) {
      // Do not rethrow exceptions.
   }
}
 
- (void)completeOperation {
    [self willChangeValueForKey:@&quot;isFinished&quot;];
    [self willChangeValueForKey:@&quot;isExecuting&quot;];
 
    executing = NO;
    finished = YES;
 
    [self didChangeValueForKey:@&quot;isExecuting&quot;];
    [self didChangeValueForKey:@&quot;isFinished&quot;];
}
 
 
- (BOOL)isConcurrent {
    return YES;
}


- (BOOL)isExecuting {
    return executing;
}
 
- (BOOL)isFinished {
    return finished;
}

@end

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div><p>æ³¨æ„ï¼šå³ä½¿operation å¯¹è±¡æ˜¯è¢«å–æ¶ˆçš„ï¼Œä¹Ÿéœ€è¦é€šçŸ¥è¿™ä¸ªå¯¹è±¡çš„è§‚å¯Ÿè€…å®ƒå·²ç»å®Œæˆäº†ã€‚å› ä¸ºå¦‚æœä¸€ä¸ªoperation å¯¹è±¡ä¾èµ–äºå…¶ä»–å¯¹è±¡ï¼Œé‚£ä¹ˆå®ƒä¼šè§‚å¯Ÿå…¶ä»–å¯¹è±¡çš„<code>isFinished</code>å±æ€§ï¼Œåªæœ‰å½“å®ƒæ‰€ä¾èµ–çš„å¯¹è±¡éƒ½å·²ç»å‘å‡ºäº†å®Œæˆçš„ä¿¡å·åï¼Œè¿™ä¸ªå¯¹è±¡æ‰ä¼šå¼€å§‹è¿è¡Œã€‚æ‰€ä»¥å¦‚æœå¿˜è®°å‘å‡ºå®Œæˆé€šçŸ¥ï¼Œé‚£ä¹ˆå¯èƒ½å°±æœ‰ä¸€ä¸ªoperation å¯¹è±¡æ°¸è¿œéƒ½æ— æ³•æ‰§è¡Œã€‚</p> <h3 id="è‡ªå®šä¹‰operation-å¯¹è±¡çš„æ‰§è¡Œè¡Œä¸º"><a href="#è‡ªå®šä¹‰operation-å¯¹è±¡çš„æ‰§è¡Œè¡Œä¸º" class="header-anchor">#</a> è‡ªå®šä¹‰operation å¯¹è±¡çš„æ‰§è¡Œè¡Œä¸º</h3> <h4 id="é…ç½®å¯¹è±¡é—´çš„ä¾èµ–å…³ç³»"><a href="#é…ç½®å¯¹è±¡é—´çš„ä¾èµ–å…³ç³»" class="header-anchor">#</a> é…ç½®å¯¹è±¡é—´çš„ä¾èµ–å…³ç³»</h4> <p>å‰é¢å¤šæ¬¡æåˆ°ï¼Œä¸€ä¸ªoperation å¯¹è±¡å¯èƒ½ä¾èµ–äºå¦å¤–å‡ ä¸ªoperation å¯¹è±¡ã€‚åœ¨å®ƒæ‰€ä¾èµ–çš„ä¸€ä¸ªoperation å¯¹è±¡éƒ½è¿è¡Œå®Œæˆåï¼Œè¿™ä¸ªoperation å¯¹è±¡æ‰å¯ä»¥å¼€å§‹è¿è¡Œã€‚</p> <p>ä¸ºä¸€ä¸ªoperation å¯¹è±¡é…ç½®ä¾èµ–çš„æ“ä½œå¾ˆç®€å•ï¼Œåªéœ€è¦è°ƒç”¨ä¸‹é¢è¿™ä¸ªå‡½æ•°ï¼š</p> <div class="language- extra-class"><pre><code>- (void) addDependency:(NSOperation *)op;
</code></pre></div><h4 id="æ”¹å˜operation-å¯¹è±¡çš„æ‰§è¡Œä¼˜å…ˆçº§"><a href="#æ”¹å˜operation-å¯¹è±¡çš„æ‰§è¡Œä¼˜å…ˆçº§" class="header-anchor">#</a> æ”¹å˜operation å¯¹è±¡çš„æ‰§è¡Œä¼˜å…ˆçº§</h4> <p>å¯¹äºé˜Ÿåˆ—ä¸­çš„operation å¯¹è±¡ï¼Œå®ƒä»¬çš„æ‰§è¡Œé¡ºåºå–å†³äºå®ƒä»¬å„è‡ªçš„ä¼˜å…ˆçº§ã€‚æ›´å‡†ç¡®çš„è¯´ï¼Œå¯¹äºé‚£äº›å·²ç»ready çš„operation å¯¹è±¡æ¥è¯´ï¼Œä¼˜å…ˆçº§é«˜çš„å…ˆæ‰§è¡Œï¼Œä¼˜å…ˆçº§ä½çš„åæ‰§è¡Œã€‚</p> <p>operation å¯¹è±¡çš„ä¼˜å…ˆçº§ç”¨è¿™ä¸ªå‡½æ•°æ¥è®¾ç½®ï¼š</p> <div class="language- extra-class"><pre><code>- (void) setQueuePriority:(NSOperationQueuePriority) priority;
</code></pre></div><p>priority çš„å¯èƒ½å–å€¼æœ‰è¿™å‡ ä¸ªï¼š</p> <ul><li>NSOperationQueuePriorityVeryLow</li> <li>NSOperationQueuePriorityLow</li> <li>NSOperationQueuePriorityNormal</li> <li>NSOperationQueuePriorityHigh</li> <li>NSOperationQueuePriorityVeryHigh</li></ul> <h4 id="è®¾ç½®å®Œæˆæ—¶çš„block"><a href="#è®¾ç½®å®Œæˆæ—¶çš„block" class="header-anchor">#</a> è®¾ç½®å®Œæˆæ—¶çš„block</h4> <p>å½“operation å¯¹è±¡æ‰§è¡Œå®Œå®ƒçš„ä»»åŠ¡åï¼Œå¯ä»¥ç”¨<code>setCompletionBlock:</code> è¿™ä¸ªå‡½æ•°æ¥è®¾ç½®æ¥ä¸‹æ¥çš„å·¥ä½œã€‚</p> <div class="language- extra-class"><pre><code>- (void) setCompletionBlock:(void ^(void))block
</code></pre></div><h3 id="æ‰§è¡Œoperations"><a href="#æ‰§è¡Œoperations" class="header-anchor">#</a> æ‰§è¡Œoperations</h3> <p>å½“å®Œæˆäº†å¯¹operation å¯¹è±¡çš„é…ç½®åï¼Œå°±å¯ä»¥æ‰§è¡Œäº†ã€‚</p> <h4 id="ä½¿ç”¨operationqueue"><a href="#ä½¿ç”¨operationqueue" class="header-anchor">#</a> ä½¿ç”¨OperationQueue</h4> <p>æ‰§è¡ŒOperation çš„æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨<code>NSOperationQueue</code> ã€‚å®ƒä¹Ÿæ˜¯æˆ‘ä»¬åˆ†æ<code>SDWebImage</code> æ—¶æ‰€å…³æ³¨çš„ä¸€ä¸ªæ ¸å¿ƒç±»ã€‚</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>NSOperationQueue* aQueue = [[NSOperationQueue alloc] init];

[aQueue addOperation:anOp]; // Add a single operation
[aQueue addOperations:anArrayOfOps waitUntilFinished:NO]; // Add multiple operations
[aQueue addOperationWithBlock:^{
   /* Do something. */
}];
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p>Never modify an operation object after it has been added to a queue. While waiting in a queue, the operation could start executing at any time, so changing its dependencies or the data it contains could have adverse effects. If you want to know the status of an operation, you can use the methods of the NSOperation class to determine if the operation is running, waiting to run, or already finished.</p></blockquote> <p>å¦‚æœä½¿ç”¨<code>setMaxConcurrentOperationCount:</code> å°†ä¸€ä¸ªoperationQueue çš„æœ€å¤§å¯å¹¶è¡Œoperation æ•°è®¾ç½®ä¸º1ï¼Œ é‚£ä¹ˆè¿™ä¸ªé˜Ÿåˆ—ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªoperationã€‚</p> <h4 id="å–æ¶ˆoperations"><a href="#å–æ¶ˆoperations" class="header-anchor">#</a> å–æ¶ˆoperations</h4> <p><code>cancelAllOperations</code> å¯ä»¥ç”¨æ¥å–æ¶ˆä¸€ä¸ªoperationQueue å†…çš„æ‰€æœ‰operationã€‚</p> <div class="language- extra-class"><pre><code>[operationQueue cancelAllOperations];
</code></pre></div><h4 id="ç­‰å¾…operations-å®Œæˆ"><a href="#ç­‰å¾…operations-å®Œæˆ" class="header-anchor">#</a> ç­‰å¾…operations å®Œæˆ</h4> <p>åœ¨ä¸€ä¸ªoperation å®ä¾‹ä¸Šè°ƒç”¨<code>waitUntilFinished</code>å¯ä»¥çŸ­æš‚åœ°é˜»å¡è¿™ä¸ªoperationï¼Œç›´åˆ°æ­¤opeartion æ‰§è¡Œå®Œã€‚ä½†æ˜¯é€šå¸¸åº”è¯¥é¿å…è¿™æ ·åšã€‚å°¤å…¶æ˜¯ä¸è¦åœ¨ä¸»çº¿ç¨‹ä¸Šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå¦åˆ™å¯èƒ½é˜»å¡ä¸»çº¿ç¨‹ï¼Œå¯¼è‡´ç¨‹åºå¤±å»å“åº”ã€‚</p> <h4 id="é˜»å¡operation"><a href="#é˜»å¡operation" class="header-anchor">#</a> é˜»å¡operation</h4> <p>åœ¨operationQueue ä¸Šè°ƒç”¨<code>setSuspended</code> å¯ä»¥é˜»å¡é‚£äº›è¿˜æ²¡æœ‰æ‰§è¡Œçš„operationï¼Œä½†æ˜¯ä¸ä¼šå½±å“é‚£äº›æ­£åœ¨æ‰§è¡Œçš„å’Œå·²ç»æ‰§è¡Œçš„operationã€‚</p> <h2 id="sdwebimage-ä¸­çš„å®ç°"><a href="#sdwebimage-ä¸­çš„å®ç°" class="header-anchor">#</a> SDWebImage ä¸­çš„å®ç°</h2> <p><code>SDWebImage</code> ä¸­ï¼Œä½¿ç”¨NSOperation å¯¹è±¡å’ŒGCD çš„åœ°æ–¹ä¸»è¦æœ‰ä¸¤å¤„ï¼Œä¸€å¤„æ˜¯åœ¨<code>SDWebImageDownloader</code> ä¸­ä½¿ç”¨<code>SDWebImageDownloaderOperation</code> æ¥å®Œæˆå›¾ç‰‡çš„<strong>ä¸‹è½½</strong>ä»»åŠ¡ï¼›ä¸€å¤„æ˜¯åœ¨<code>SDWebImageManager</code> ä½¿ç”¨<code>SDWebImageCombinedOperation</code>æ¥å®Œæˆä¸‹è½½åå›¾ç‰‡çš„<strong>ç¼“å­˜</strong>ä»»åŠ¡ã€‚æˆ‘ä»¬åªåˆ†æ<code>SDWebImageDownloader</code> ä¸­çš„å¤šçº¿ç¨‹ç­–ç•¥ã€‚</p> <h3 id="sdwebimagedownloader"><a href="#sdwebimagedownloader" class="header-anchor">#</a> SDWebImageDownloader</h3> <p>åœ¨è¿™ä¸ªç±»çš„ç±»æ‰©å±•ä¸­ï¼Œæœ‰å‡ ä¸ªå±æ€§æ˜¯ä¸Operation å’ŒOperationQueue å¯¹è±¡æœ‰è”ç³»çš„ï¼š</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@property (strong, nonatomic, nonnull) NSOperationQueue *downloadQueue;
@property (weak, nonatomic, nullable) NSOperation *lastAddedOperation;

// This queue is used to serialize the handling of the network responses of all the download operation in a single queue
@property (SDDispatchQueueSetterSementics, nonatomic, nullable) dispatch_queue_t barrierQueue;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>ä»åå­—å’Œæ³¨é‡Šä¸­ä¸éš¾çŒœæµ‹åˆ°å®ƒä»¬å„è‡ªçš„ä½œç”¨ï¼š</p> <ul><li>downloadQueueï¼šç”¨æ¥ç®¡ç† download æ“ä½œçš„é˜Ÿåˆ—ã€‚</li> <li>lastAddedOperationï¼šä¸Šä¸€ä¸ªè¢«æ·»åŠ è¿›é˜Ÿåˆ—çš„ operationã€‚</li> <li>barrierQueueï¼šè¿™æ˜¯ä¸€ä¸ªdispatch_queue_t ç±»å‹çš„å±æ€§ï¼Œä½œç”¨æ˜¯ä¸²è¡Œåœ°å¤„ç†æ‰€æœ‰ download æ“ä½œçš„ç½‘ç»œå“åº”ã€‚</li></ul> <h4 id="sdwebimagedownloaderoperation"><a href="#sdwebimagedownloaderoperation" class="header-anchor">#</a> SDWebImageDownloaderOperation</h4> <p><code>SDWebImageDownloaderOperation</code> æ˜¯<code>NSOperation</code> çš„å­ç±»ï¼Œæ˜¯<code>SDWebImage</code> ä¸­å®Œæˆä¸‹è½½ä»»åŠ¡çš„operation å¯¹è±¡ã€‚è¿™ä¸ªoperation å¯¹è±¡çš„è®¾è®¡ï¼Œç¬¦åˆæˆ‘ä»¬åœ¨ã€å®ç°è‡ªå®šä¹‰çš„NSOperation å­ç±»ã€ä¸€èŠ‚ä¸­ä»‹ç»çš„å„ç§è¦æ±‚ã€‚å¯¹äºå®ƒçš„start å’Œå…¶ä»–æ–¹æ³•ï¼Œç”±äºæ˜¯å¯¹ç½‘ç»œè¯·æ±‚éƒ¨åˆ†çš„å…·ä½“å®ç°ï¼Œä¸æœ¬æ–‡ä¸»é¢˜æ— å…³ï¼Œå› æ­¤æš‚æ—¶ä¸åšä»‹ç»ï¼ˆæ—¥åè‹¥æœ‰æ—¶é—´ï¼Œæˆ‘å°†ä¸“é—¨å†™ä¸€ç¯‡åšå®¢æ¥ä»‹ç»<code>SDWebImage</code> ä¸­çš„ç½‘ç»œéƒ¨åˆ†ï¼‰ã€‚</p> <h4 id="downloadqueue"><a href="#downloadqueue" class="header-anchor">#</a> downloadQueue</h4> <p>åœ¨<code>downloadImageWithURL:options:progress:completed:</code>è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œ<code>SDWebImageDownloader</code> ä¸ºæ¯ä¸€ä¸ªä¸‹è½½å›¾ç‰‡çš„è¯·æ±‚åˆ›å»ºä¸€ä¸ª<code>SDWebImageDownloaderOperation</code> ï¼Œå¹¶å°†è¿™ä¸ª<code>SDWebImageDownloaderOperation</code> åŠ å…¥downloadQueue ä¸­ã€‚</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>SDWebImageDownloaderOperation *operation = [[sself.operationClass alloc] initWithRequest: request inSession: sself.session options: options];


// æ ¹æ®ä¼ å…¥çš„SDWebImageDownloaderOptions æ¥è®¾ç½®å½“å‰operation çš„ä¼˜å…ˆçº§
if (options &amp; SDWebImageDownloaderHighPriority) {
    operation.queuePriority = NSOperationQueuePriorityHigh;
} else if (options &amp; SDWebImageDownloaderLowPriority) {
    operation.queuePriority = NSOperationQueuePriorityLow;
}

[sself.downloadQueue addOperation:operation];
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>åœ¨å°†operation æ·»åŠ è¿›downloadQueue åï¼Œè¿˜å¯ä»¥è®¾ç½®operation å¯¹è±¡åœ¨è¿™ä¸ªé˜Ÿåˆ—ä¸­çš„æ‰§è¡Œé¡ºåºï¼š</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>if (sself.executionOrder == SDWebImageDownloaderLIFOExecutionOrder) {
    [sself.lastAddedOperation addDependency:operation];
    sself.lastAddedOperation = operation;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>downloadQueue çš„é»˜è®¤æ‰§è¡Œé¡ºåºæ˜¯</p> <ul><li><code>SDWebImageDownloaderFIFOExecutionOrder</code>ï¼Œä¹Ÿå°±æ˜¯å…ˆå…¥å…ˆå‡ºï¼Œå…¶è¡Œä¸ºç±»ä¼¼äºä¸€ä¸ªé˜Ÿåˆ—ï¼›</li></ul> <p>å½“æ‰§è¡Œé¡ºåºæ”¹ä¸º</p> <ul><li><code>SDWebImageDownloaderLIFOExecutionOrder</code> æ—¶ï¼Œåˆ™æ˜¯åå…¥å…ˆå‡ºï¼Œå…¶è¡Œä¸ºç±»ä¼¼äºä¸€ä¸ªæ ˆã€‚<code>lastAddedOperation</code> å°±æ˜¯ç”¨æ¥è®°å½•å½“å‰æ ˆé¡¶çš„é‚£ä¸ªoperation çš„ï¼Œå½“æœ‰æ–°çš„operation è¦è¿›æ ˆæ—¶ï¼Œå°±æŠŠè¿™ä¸ªæ–°çš„operation è®¾ç½®ä¸º<code>lastAddedOperation</code> çš„ä¾èµ–ï¼Œè¿™æ ·çš„è¯ï¼Œåªæœ‰æ–°çš„operation æ‰§è¡Œå®Œæ¯•ï¼Œ<code>lastAddedOperation</code> æ‰èƒ½å¼€å§‹æ‰§è¡Œï¼Œå› æ­¤å°±å®ç°äº†åå…¥å…ˆå‡ºçš„æ•ˆæœã€‚</li></ul> <h4 id="barrierqueue"><a href="#barrierqueue" class="header-anchor">#</a> barrierQueue</h4> <p>å‰é¢æåˆ°ï¼Œ<code>barrierQueue</code> æ˜¯ç”¨æ¥ä¸²è¡Œåœ°å¤„ç†æ‰€æœ‰çš„download æ“ä½œçš„ç½‘ç»œå“åº”çš„ã€‚å…³äº<code>dispatch_queue_t</code> å’Œ<code>NSOperation</code> çš„å¯¹æ¯”ï¼Œå¯ä»¥å‚è§<a href="http://stackoverflow.com/questions/10373331/nsoperation-vs-grand-central-dispatch" target="_blank" rel="noopener noreferrer">è¿™å„¿<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ã€‚
æˆ‘ä»¬æ¥çœ‹ä¸‹å…·ä½“çš„æ“ä½œè¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·å­çš„ã€‚</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>- (nullable SDWebImageDownloadToken *)addProgressCallback:(SDWebImageDownloaderProgressBlock)progressBlock
                                           completedBlock:(SDWebImageDownloaderCompletedBlock)completedBlock
                                                   forURL:(nullable NSURL *)url
                                           createCallback:(SDWebImageDownloaderOperation *(^)())createCallback {
    // The URL will be used as the key to the callbacks dictionary so it cannot be nil. If it is nil immediately call the completed block with no image or data.
    if (url == nil) {
        if (completedBlock != nil) {
            completedBlock(nil, nil, nil, NO);
        }
        return nil;
    }

    __block SDWebImageDownloadToken *token = nil;

    dispatch_barrier_sync(self.barrierQueue, ^{
        SDWebImageDownloaderOperation *operation = self.URLOperations[url];
        if (!operation) {
            operation = createCallback();
            self.URLOperations[url] = operation;

            __weak SDWebImageDownloaderOperation *woperation = operation;
            operation.completionBlock = ^{
              SDWebImageDownloaderOperation *soperation = woperation;
              if (!soperation) return;
              if (self.URLOperations[url] == soperation) {
                  [self.URLOperations removeObjectForKey:url];
              };
            };
        }
        id downloadOperationCancelToken = [operation addHandlersForProgress:progressBlock completed:completedBlock];

        token = [SDWebImageDownloadToken new];
        token.url = url;
        token.downloadOperationCancelToken = downloadOperationCancelToken;
    });

    return token;
}


- (void)cancel:(nullable SDWebImageDownloadToken *)token {
    dispatch_barrier_async(self.barrierQueue, ^{
        SDWebImageDownloaderOperation *operation = self.URLOperations[token.url];
        BOOL canceled = [operation cancel:token.downloadOperationCancelToken];
        if (canceled) {
            [self.URLOperations removeObjectForKey:token.url];
        }
    });
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>è¿™æ®µä»£ç ä¸­ï¼Œ<code>SDWebImageDownloader</code> ç»´æŠ¤äº†ä¸€ä¸ªNSDictionary ç”¨ä»¥å°†url å’Œurl å¯¹åº”çš„operation è”ç³»èµ·æ¥ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨å‰ä¸€ä¸ªæ–¹æ³•ä¸­ï¼Œä½¿ç”¨äº†<code>dispatch_barrier_async</code>ï¼Œåœ¨åä¸€ä¸ªæ–¹æ³•ä¸­ï¼Œåˆ™ä½¿ç”¨äº†<code>dispatch_barrier_sync</code>ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªå‡½æ•°ç©¶ç«Ÿæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</p> <p>æˆ‘ä»¬çŸ¥é“<code>dispatch_barrier_async</code> å’Œ<code>dispatch_barrier_sync</code>éƒ½æ˜¯ä¸ºäº†è§£å†³ç«äº‰é—®é¢˜è€Œæå‡ºæ¥çš„ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œç°åœ¨æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ä¸€ä¸ªæ•°æ®åº“ï¼Œé‚£ä¹ˆå¯¹æ•°æ®åº“çš„æ“ä½œå°±æœ‰è¯»å’Œå†™ä¸¤ç§æ“ä½œã€‚å‡è®¾æˆ‘ä»¬éœ€è¦å…ˆè¯»ä¸¤æ¬¡æ•°æ®åº“ï¼Œç„¶åå†å†™å…¥ä¸€ä¸ªæ•°æ®ï¼Œç„¶åå†è¯»å‡ºä¸¤ä¸ªæ•°æ®ï¼Œé‚£ä¹ˆæ˜¾ç„¶è¯»å’Œå†™çš„æ“ä½œæ˜¯ä¸èƒ½åŒæ—¶å‘ç”Ÿçš„ï¼Œå¦‚æœåŒæ—¶å‘ç”Ÿï¼Œå°±æœ‰å¯èƒ½é€ æˆæ•°æ®é”™è¯¯ã€‚</p> <p>ä½¿ç”¨<code>dispatch_barrier_(a)sync</code>ï¼Œä¸Šè¿°ä»»åŠ¡å¯ä»¥è¿™æ ·å®ç°ï¼š</p> <div class="language- extra-class"><pre><code>dispatch_async(queue, blk1_read);
dispatch_async(queue, blk2_read);
dispatch_async(queue, blk3_read);
dispatch_barrier_async(queue, blk_write);
dispatch_async(queue, blk4_read);
dispatch_async(queue, blk5_read);
</code></pre></div><p><code>dispatch_barrier_(a)sync</code> å°±åƒæ˜¯ä¸€ä¸ªå±éšœä¸€æ ·ï¼Œå®ƒç¡®ä¿blk_write ä¸€å®šä¼šç­‰åˆ°blk1ï¼Œblk2ï¼Œblk3 å…¨éƒ¨æ‰§è¡Œå®Œæ¯•æ‰å¼€å§‹æ‰§è¡Œï¼Œåœ¨blk_write æ‰§è¡Œå®Œæ¯•åï¼Œblk4 å’Œblk5 åˆæ­£å¸¸åœ°å¹¶è¡Œè¿è¡Œã€‚</p> <p><code>sync</code> å’Œ<code>async</code> çš„åŒºåˆ«ä½“ç°åœ¨ï¼šå°†block è¿½åŠ åˆ°æŒ‡å®šçš„queue ä¸­æ˜¯å¦æ˜¯åŒæ­¥çš„ã€‚å¦‚æœæ˜¯<code>async</code> çš„ï¼Œé‚£ä¹ˆ<code>dispatch_barrier_async</code> ä¸ä¼šç­‰å¾…è¿½åŠ æ“ä½œç»“æŸï¼Œå½“å‰è¿›ç¨‹ä¼šç»§ç»­è¿›è¡Œï¼›å¦‚æœæ˜¯<code>sync</code> çš„ï¼Œé‚£ä¹ˆ<code>dispatch_barrier_async</code> ä¼šç­‰å¾…ä¸€ç›´è¿½åŠ æ“ä½œç»“æŸï¼Œå½“å‰è¿›ç¨‹ä¼šå› æ­¤é˜»å¡ã€‚</p> <p>ç”¨ä¾‹å­æ¥è§£é‡Šï¼š</p> <div class="language- extra-class"><pre><code>// A
// step1
dispatch_barrier_async(queue, ^{
    step2
});
// step3

// B
// step4
dispatch_barrier_sync(queue, ^{
    // step5
});
// step6
</code></pre></div><p>åœ¨A ä¸­ï¼Œstep1 å…ˆæ‰§è¡Œï¼Œä½†æ˜¯step3 å¯èƒ½ä¼šåœ¨step2 ä¹‹å‰æ‰§è¡Œå®Œï¼Œå› æ­¤æ‰§è¡Œé¡ºåºå¯èƒ½æ˜¯<code>step1-&gt;step2-&gt;step3</code>ï¼Œä¹Ÿå¯èƒ½æ˜¯<code>step1-&gt;step3-&gt;step2</code>ï¼›åœ¨B ä¸­ï¼Œæ‰§è¡Œçš„é¡ºåºåˆ™ä¸€å®šæ˜¯<code>step4-&gt;step5-&gt;step6</code>ã€‚</p> <p>åœ¨<code>addProgressCallback:</code>æ–¹æ³•ä¸­ï¼Œå› ä¸ºéœ€è¦è¿”å›ä¸€ä¸ªtokenï¼Œè€Œè¿™ä¸ªtoken æ˜¯åœ¨block ä¸­è®¡ç®—çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€å®šè¦ç­‰åˆ°block çš„è¿½åŠ æ“ä½œå®Œæˆæ‰å¯ä»¥è¿”å›ï¼Œå¦åˆ™å°±ä¼šå¾—åˆ°nilï¼Œå› æ­¤éœ€è¦ä½¿ç”¨<code>dispatch_barrier_sync</code>ï¼›è€Œåœ¨<code>cancel:</code> æ–¹æ³•ä¸­ï¼Œä¸éœ€è¦ç­‰å¾…ï¼Œå› æ­¤ä½¿ç”¨<code>dispatch_barrier_async</code> å°±å¯ä»¥äº†ã€‚</p></div> <!----> <div class="content__content-bottom"></div> <footer class="page-meta"><div class="edit-link"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon edit-icon"><path d="M117.953 696.992 64.306 959.696l265.931-49.336 450.204-452.505-212.284-213.376-450.204 452.513zm496.384-296.326L219.039 797.993l-46.108-46.34L568.233 354.33l46.104 46.335zm345.357-122.99-114.45 115.04-212.288-213.377 114.45-115.035 212.288 213.371zm0 0" fill="currentColor"></path></svg> <a href="https://github.com/tamarous/blog/edit/master/docs/iOS/sdwebimage_multithread.md" target="_blank" rel="noopener noreferrer">Edit this page</a></div> <div class="meta-item update-time"><span class="label">Last update:</span> <span class="info">August 29, 2021 11:41</span></div> <!----></footer> <!----> <!----> <!----> <div class="content__page-bottom"></div></main> <!----></div><div class="global-ui"><!----><!----><div id="pwa-install"><!----> <div id="install-modal-wrapper" style="display:none;"><div class="background"></div> <div class="install-modal"><div class="header"><button aria-label="Close" class="close-button"><svg width="23" height="22" xmlns="http://www.w3.org/2000/svg" class="icon close-icon"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.12.358a1.224 1.224 0 011.729 0l8.92 8.914L20.686.358a1.224 1.224 0 011.73 1.728L13.497 11l8.92 8.913a1.222 1.222 0 11-1.73 1.729l-8.919-8.913-8.92 8.913a1.224 1.224 0 01-1.729-1.729L10.04 11l-8.92-8.914a1.222 1.222 0 010-1.728z" fill="currentColor"></path></svg></button> <div class="logo"><!----> <div class="title"><h1></h1> <p class="desc">This app can be installed on your PC or mobile device.  This will allow this web app to look and behave like any other installed app.  You will find it in your app lists and be able to pin it to your home screen, start menus or task bars.  This installed web app will also be able to safely interact with other apps and your operating system. </p></div></div></div> <div class="content"><div class="highlight"><!----> <!----></div> <div class="description"><h3>Description</h3> <p></p></div></div> <div class="button-wrapper"><button class="install-button">
        Install <span></span></button> <button class="cancel-button">
        Cancel
      </button></div></div></div></div><div tabindex="-1" role="dialog" aria-hidden="true" class="pswp"><div class="pswp__bg"></div> <div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div></div> <div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button class="pswp__button pswp__button--close"></button> <button class="pswp__button pswp__button--share"></button> <button class="pswp__button pswp__button--fs"></button> <button class="pswp__button pswp__button--zoom"></button> <div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button class="pswp__button pswp__button--arrow--left"></button> <button class="pswp__button pswp__button--arrow--right"></button> <div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div></div></div>
    <script src="/blog/assets/js/app.df73a9a4.js" defer></script><script src="/blog/assets/js/vendors~layout-Layout.751f6b56.js" defer></script><script src="/blog/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.4f318220.js" defer></script><script src="/blog/assets/js/page-SDWebImageæºä»£ç å‰–æ-å¤šçº¿ç¨‹ç­–ç•¥.2154a0a5.js" defer></script><script src="/blog/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.335ce4c4.js" defer></script>
  </body>
</html>
