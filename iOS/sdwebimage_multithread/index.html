<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SDWebImage 源代码剖析-多线程策略</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="manifest" href="/blog/manifest.webmanifest" crossorigin="use-credentials">
    <meta name="description" content="">
    <meta property="og:url" content="/blog/iOS/sdwebimage_multithread.html">
    <meta property="og:title" content="SDWebImage 源代码剖析-多线程策略">
    <meta property="og:description" content="SDWebImage 源代码剖析-多线程策略 前一篇文章从缓存策略的角度分析了SDWebImage 的部分代码，下面从多线程的角度对它的其他模块进行分析。 苹果的多线程解决方案有三种： NSThread; GCD; NSOperation; 在实际开发中，我们往往只使用GCD 和NSOperation。 关于应该如何在GCD 和NSOperation 中进行">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="en-US">
    <meta name="twitter:card" content="summary_large_image">
    <meta property="article:tag" content="源码分析">
    <meta name="theme-color" content="#46bd87">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    
    <link rel="preload" href="/blog/assets/css/0.styles.8b5d14a7.css" as="style"><link rel="preload" href="/blog/assets/js/app.df73a9a4.js" as="script"><link rel="preload" href="/blog/assets/js/vendors~layout-Layout.751f6b56.js" as="script"><link rel="preload" href="/blog/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.4f318220.js" as="script"><link rel="preload" href="/blog/assets/js/page-SDWebImage源代码剖析-多线程策略.2154a0a5.js" as="script"><link rel="preload" href="/blog/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.335ce4c4.js" as="script"><link rel="prefetch" href="/blog/assets/js/52.b3a05f52.js"><link rel="prefetch" href="/blog/assets/js/layout-Blog.cd958aaa.js"><link rel="prefetch" href="/blog/assets/js/layout-Layout.54347a9b.js"><link rel="prefetch" href="/blog/assets/js/layout-NotFound.5814876d.js"><link rel="prefetch" href="/blog/assets/js/layout-Slide.7b34a4ba.js"><link rel="prefetch" href="/blog/assets/js/page-Aspects源码分析.f472509c.js"><link rel="prefetch" href="/blog/assets/js/page-EasyTuple源代码分析.dbf9e78d.js"><link rel="prefetch" href="/blog/assets/js/page-Hello!.21062866.js"><link rel="prefetch" href="/blog/assets/js/page-Home.b36aff0d.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-100-SameTree及572-SubtreeofAnotherTree.845a9f5d.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-101-SymmetricTree.fe2cc86c.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-112-PathSum.fa4b9369.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-113-PathSumⅡ.4aad22d2.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-120-Triangle.712ef98c.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-191-Numberof1Bits.33046e6d.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-198-HouseRobber.07ab4a7e.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-2-AddTwoNumbers.bfb710bc.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-21-MergeTwoSortedLists.0da4fd95.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-234-PalindromeLinkedList.d1b72571.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-238-ProductofArrayExceptSelf.945dd596.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-28-ImplementstrStr().1f60c28a.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-347-TopKFrequentElements.7c94685f.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-437-PathSumⅢ.fc74b8cc.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-48-RotateImage.4eb31875.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-494-TargetSum.54ed4fde.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-62-UniquePaths.3965e239.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode-63-UniquePathsⅡ.3397f865.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode.b7f07569.js"><link rel="prefetch" href="/blog/assets/js/page-LeetCode上几道经典的排列组合题.0df3c81a.js"><link rel="prefetch" href="/blog/assets/js/page-Masonry源代码剖析.4dd591af.js"><link rel="prefetch" href="/blog/assets/js/page-SDWebImage源代码剖析-缓存策略.66c0b61c.js"><link rel="prefetch" href="/blog/assets/js/page-SDWebImage源代码剖析-网络部分.8b4e1ac6.js"><link rel="prefetch" href="/blog/assets/js/page-不重复打印排序数组中相加和为给定值的所有二元组三元组.d34496f6.js"><link rel="prefetch" href="/blog/assets/js/page-二叉树的Morris遍历.0b3a52cc.js"><link rel="prefetch" href="/blog/assets/js/page-前中后序遍历的非递归实现.54cce868.js"><link rel="prefetch" href="/blog/assets/js/page-单链表问题总结.28a92876.js"><link rel="prefetch" href="/blog/assets/js/page-在其他数字都出现K次的数组中找到只出现M次的数字.a7e218e0.js"><link rel="prefetch" href="/blog/assets/js/page-在数组中找到出现次数大于NK的数.a45a1fa0.js"><link rel="prefetch" href="/blog/assets/js/page-按层打印二叉树.b6147bf9.js"><link rel="prefetch" href="/blog/assets/js/page-揭开Runtime的神秘面纱.fc2f7ce9.js"><link rel="prefetch" href="/blog/assets/js/page-最大公约数和最小公倍数.43bb0121.js"><link rel="prefetch" href="/blog/assets/js/page-最大子序列和问题.e334cc90.js"><link rel="prefetch" href="/blog/assets/js/page-源码分析.3e7b7e99.js"><link rel="prefetch" href="/blog/assets/js/page-由前序和中序遍历恢复二叉树结构.76d27828.js"><link rel="prefetch" href="/blog/assets/js/page-调整数组中元素的顺序.9ba9fdb6.js"><link rel="prefetch" href="/blog/assets/js/page-递归在二叉树相关题目中的应用.efd4c29a.js"><link rel="prefetch" href="/blog/assets/js/vendors~photo-swipe.b7933859.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.8b5d14a7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container has-navbar has-anchor"><header class="navbar"><!----> <div class="content__navbar-start"></div> <button title="Sidebar Button" class="sidebar-button"><span class="icon"></span></button> <a href="/blog/" class="home-link router-link-active"></a> <!----> <div class="content__navbar-center"></div> <div class="links"><button tabindex="-1" aria-hidden="true" class="color-button"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="skin-icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4
        38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32
        51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0
        102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2
        6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4
        0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2
        9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224
        419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4
        470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0
        22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6
        12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128
        505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2
        16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8
        86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4
        80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6
        6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><ul class="themecolor-select"><label for="themecolor-select">Theme Color:</label> <li><span class="default-theme"></span></li> </ul> <div class="darkmode-toggle"><label for="darkmode-toggle" class="desc">Theme Mode:</label> <div class="darkmode-switch"><div class="item day"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon light-icon"><path d="M512 256a42.667 42.667 0 0 0 42.667-42.667V128a42.667 42.667 0 0 0-85.334 0v85.333A42.667 42.667 0 0 0 512 256zm384 213.333h-85.333a42.667 42.667 0 0 0 0 85.334H896a42.667 42.667 0 0 0 0-85.334zM256 512a42.667 42.667 0 0 0-42.667-42.667H128a42.667 42.667 0 0 0 0 85.334h85.333A42.667 42.667 0 0 0 256 512zm9.387-298.667a42.667 42.667 0 0 0-59.307 62.72l61.44 59.307a42.667 42.667 0 0 0 31.147 11.947 42.667 42.667 0 0 0 30.72-13.227 42.667 42.667 0 0 0 0-60.16zm459.946 133.974a42.667 42.667 0 0 0 29.44-11.947l61.44-59.307a42.667 42.667 0 0 0-57.6-62.72l-61.44 60.587a42.667 42.667 0 0 0 0 60.16 42.667 42.667 0 0 0 28.16 13.227zM512 768a42.667 42.667 0 0 0-42.667 42.667V896a42.667 42.667 0 0 0 85.334 0v-85.333A42.667 42.667 0 0 0 512 768zm244.48-79.36a42.667 42.667 0 0 0-59.307 61.44l61.44 60.587a42.667 42.667 0 0 0 29.44 11.946 42.667 42.667 0 0 0 30.72-12.8 42.667 42.667 0 0 0 0-60.586zm-488.96 0-61.44 59.307a42.667 42.667 0 0 0 0 60.586 42.667 42.667 0 0 0 30.72 12.8 42.667 42.667 0 0 0 28.587-10.666l61.44-59.307a42.667 42.667 0 0 0-59.307-61.44zM512 341.333A170.667 170.667 0 1 0 682.667 512 170.667 170.667 0 0 0 512 341.333z" fill="currentColor"></path></svg></div> <div class="item auto active"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon auto-icon"><path d="M460.864 539.072H564.8L510.592 376l-49.728 163.072zM872 362.368V149.504H659.648L510.528 0l-149.12 149.504H149.12v212.928L0 511.872l149.12 149.504v212.928h212.352l149.12 149.504 149.12-149.504h212.352V661.376l149.12-149.504L872 362.368zM614.464 693.12l-31.616-90.624H438.272l-31.616 90.624h-85.888l144.576-407.68h90.368l144.576 407.68h-85.824zm0 0" fill="currentColor"></path></svg></div> <div class="item night"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon dark-icon"><path d="M935.539 630.402c-11.43-11.432-28.674-14.739-43.531-8.354-46.734 20.103-96.363 30.297-147.508 30.297-99.59 0-193.221-38.784-263.64-109.203-108.637-108.637-139.61-270.022-78.908-411.148a39.497 39.497 0 0 0-51.886-51.887c-52.637 22.64-100.017 54.81-140.826 95.616-85.346 85.346-132.346 198.821-132.346 319.52 0 120.7 47.001 234.172 132.347 319.519S408.063 947.11 528.76 947.11c120.7 0 234.172-47.003 319.52-132.351 40.809-40.81 72.978-88.19 95.616-140.826a39.497 39.497 0 0 0-8.356-43.532z" fill="currentColor"></path></svg></div></div> <!----></div></div></div></button> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active"><!---->
  Home
</a></div><div class="nav-item"><a href="/blog/iOS/" class="nav-link router-link-active active"><!---->
  iOS
</a></div><div class="nav-item"><a href="/blog/Algorithms/" class="nav-link"><!---->
  Algorithms
</a></div></nav> <!----> <a rel="noopener noreferrer" href="https://github.com/tamarous/blog" target="_blank" class="repo-link can-hide">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <!----> <div class="content__navbar-end"></div></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!----> <!----> <div class="content__sidebar-top"></div> <nav class="sidebar-nav-links"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active"><!---->
  Home
</a></div><div class="nav-item"><a href="/blog/iOS/" class="nav-link router-link-active active"><!---->
  iOS
</a></div><div class="nav-item"><a href="/blog/Algorithms/" class="nav-link"><!---->
  Algorithms
</a></div> <a rel="noopener noreferrer" href="https://github.com/tamarous/blog" target="_blank" class="repo-link">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <!----> <div class="content__sidebar-center"></div> <!----> <!----> <div class="content__sidebar-bottom"></div> <!----></aside> <main class="page"><nav class="breadcrumb"><ol vocab="https://schema.org/" typeof="BreadcrumbList"><li property="itemListElement" typeof="ListItem"><a href="/blog/iOS/" property="item" typeof="WebPage" class="router-link-active"><!----> <span property="name">源码分析</span></a> <meta property="position" content="1"></li><li property="itemListElement" typeof="ListItem" class="is-active"><a href="/blog/iOS/sdwebimage_multithread/" aria-current="page" property="item" typeof="WebPage" class="router-link-exact-active router-link-active"><!----> <span property="name">SDWebImage 源代码剖析-多线程策略</span></a> <meta property="position" content="2"></li></ol></nav> <!----> <div class="content__page-top"></div> <div vocab="https://schema.org/" typeof="Article" class="page-title"><h1><!----> <span property="headline">SDWebImage 源代码剖析-多线程策略</span></h1> <div class="page-info"><!----> <!----><!----><span aria-label="Writing Date📅" data-balloon-pos="down" class="time-info"><svg viewBox="0 0 1030 1024" xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H180.6A134.314 134.314 0 0 0 46.66 277.595v535.756A134.314 134.314 0 0 0 180.6 947.289h669.74a134.36 134.36 0 0 0 133.94-133.938V277.595a134.314 134.314 0 0 0-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 0 1-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 0 1-33.472 33.473z" fill="currentColor"></path></svg> <span property="datePublished">2021-8-29</span></span><span role="navigation" aria-label="Category🌈" data-balloon-pos="down" class="category-info enable"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon category-icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zm-.854 446.486H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zm446.371-446.486h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zm136.293 813.51H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z" fill="currentColor"></path></svg> <span property="articleSection">IOS</span></span><span aria-label="Tags🏷" data-balloon-pos="down"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon tag-icon"><path d="M939.902 458.563 910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 0 0 0 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z" fill="currentColor"></path></svg> <ul class="tags-wrapper"><li class="tag clickable tag0"><span role="navigation">源码分析</span></li></ul> <meta property="keywords" content="源码分析"></span><span aria-label="Reading Time⌛" data-balloon-pos="down" class="reading-time-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon timer-icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z" fill="currentColor"></path></svg> <span>About 11 min</span> <meta property="timeRequired" content="PT11M"></span></div> <!----> <hr></div> <div class="anchor-place-holder"><aside id="anchor"><div class="anchor-wrapper"><ul class="anchor-list"><li class="anchor"><a href="/blog/iOS/sdwebimage_multithread/#nsoperation" class="anchor-link heading2"><div>NSOperation</div></a></li><li class="anchor"><a href="/blog/iOS/sdwebimage_multithread/#实现自定义的nsoperation-子类" class="anchor-link heading3"><div>实现自定义的NSOperation 子类</div></a></li><li class="anchor"><a href="/blog/iOS/sdwebimage_multithread/#自定义operation-对象的执行行为" class="anchor-link heading3"><div>自定义operation 对象的执行行为</div></a></li><li class="anchor"><a href="/blog/iOS/sdwebimage_multithread/#执行operations" class="anchor-link heading3"><div>执行operations</div></a></li><li class="anchor"><a href="/blog/iOS/sdwebimage_multithread/#sdwebimage-中的实现" class="anchor-link heading2"><div>SDWebImage 中的实现</div></a></li><li class="anchor"><a href="/blog/iOS/sdwebimage_multithread/#sdwebimagedownloader" class="anchor-link heading3"><div>SDWebImageDownloader</div></a></li></ul></div></aside></div> <!----> <div class="content__content-top"></div> <div class="theme-default-content content__default"><h1 id="sdwebimage-源代码剖析-多线程策略"><a href="#sdwebimage-源代码剖析-多线程策略" class="header-anchor">#</a> SDWebImage 源代码剖析-多线程策略</h1> <p>前一篇<a href="/blog/iOS/sdwebimage_cache.html">文章</a>从缓存策略的角度分析了<code>SDWebImage</code> 的部分代码，下面从多线程的角度对它的其他模块进行分析。</p> <p>苹果的多线程解决方案有三种：</p> <ul><li>NSThread</li> <li>GCD</li> <li>NSOperation</li></ul> <p>在实际开发中，我们往往只使用GCD 和NSOperation。
关于应该如何在GCD 和NSOperation 中进行选择，StackOverflow 上已经有很多详细和深入的<a href="http://stackoverflow.com/a/10375616/6552680" target="_blank" rel="noopener noreferrer">讨论<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。本文中，我们只介绍 NSOperation 。</p> <h2 id="nsoperation"><a href="#nsoperation" class="header-anchor">#</a> NSOperation</h2> <p>NSOperation 定义在Foundation 框架中，表示一个用来完成某项工作的操作。它是一个抽象类，因此在实际使用时，必须让一个类继承它，然后实现某些方法。Foundation 为我们事先定义好了两个子类，分别是<code>NSInvocationOperation</code> 和<code>NSBlockOperation</code>，这两个类可以直接使用，但是它们的适用场景是不同的：</p> <table><thead><tr><th>类</th> <th>描述</th></tr></thead> <tbody><tr><td>NSInvocationOperation</td> <td>A class you use as-is to create an operation object based on an object and selector from your application. You can use this class in cases where you have an existing method that already performs the needed task.</td></tr> <tr><td>NSBlockOperation</td> <td>A class you use as-is to execute one or more block objects concurrently. Because it can execute more than one block, a block operation object operates using a group semantic; only when all of the associated blocks have finished executing is the operation itself considered finished.</td></tr></tbody></table> <h3 id="实现自定义的nsoperation-子类"><a href="#实现自定义的nsoperation-子类" class="header-anchor">#</a> 实现自定义的NSOperation 子类</h3> <p>如果说上面提到的两个子类不能满足我们的需求，我们还可以自己去实现一个NSOperation 的子类。
如果你的这个子类是非并行的，那很好办，只要实现下面两个方法，加上对取消操作的响应即可；如果子类是并行的，那稍微复杂一些，还需要重载NSOperation 中的某些方法。
我们先看下并行和串行子类都必须实现的几个方法。</p> <h4 id="每个operation-对象都应该实现的方法"><a href="#每个operation-对象都应该实现的方法" class="header-anchor">#</a> 每个operation 对象都应该实现的方法</h4> <ul><li>一个自定义<code>initialization</code> 方法</li> <li><code>main</code> 方法</li></ul> <p><code>initialization</code> 用于对operation 对象进行初始化设置，<code>main</code>用于执行具体的任务。</p> <p>其他的方法则可以根据需要来实现，比如说：</p> <ul><li>用于在<code>main</code> 中调用的辅助方法</li> <li>用于设置和获取operation 对象的数据的<code>accessor</code>方法</li> <li>用于序列化和反序列化的NSCoding 协议中的某些方法</li></ul> <p>下面是一个NSOperation 子类可能的样子：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@interface MyNonConcurrentOperation : NSOperation
@property id (strong) myData;
-(id)initWithData:(id)data;
@end
 
@implementation MyNonConcurrentOperation
- (id)initWithData:(id)data {
   if (self = [super init])
      myData = data;
   return self;
}
 
-(void)main {
   @try {
      // Do some work on myData and report the results.
   }
   @catch(...) {
      // Do not rethrow exceptions.
   }
}
@end
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="对取消操作做出响应"><a href="#对取消操作做出响应" class="header-anchor">#</a> 对取消操作做出响应</h4> <p>注意，上面的那个例子没有实现对取消操作的响应。而事实上，对取消事件作出响应是operation 对象的一个重要工作。当一个operation 对象被执行后，它会一直运行，直到任务完成或者是操作被取消，而取消操作甚至可能发生在任务开始执行之前。当操作被取消的时候，operation 对象需要回收已经被分配的资源，并且优雅地退出。</p> <p>为了能对取消操作作出反应，在代码中应该周期性地调用operation 对象的<code>isCancelled</code> 方法。更进一步地说，应该是在如下几个场景处调用此方法：</p> <ul><li>当进行任何实际性的工作时。</li> <li>在每次循环中至少调用一次，如果每次循环的时间很久，则可以在一次循环中多次调用。这个方法本身的开销很小，因此不必担心多次调用会带来性能上的下降。</li> <li>当取消操作很可能发生的时候。</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>- (void)main {
   @try {
      BOOL isDone = NO;
 
      while (![self isCancelled] &amp;&amp; !isDone) {
          // Do some work and set isDone to YES when finished
      }
   }
   @catch(...) {
      // Do not rethrow exceptions.
   }
}

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="并行operation-对象的配置"><a href="#并行operation-对象的配置" class="header-anchor">#</a> 并行operation 对象的配置</h4> <blockquote><p>Operation objects execute in a synchronous manner by default—that is, they perform their task in the thread that calls their start method.</p></blockquote> <p>下面这张表列出了并行operation 对象所需要重载的一些方法。</p> <table><thead><tr><th>方法</th> <th>类型</th> <th>描述</th></tr></thead> <tbody><tr><td>start</td> <td>必须实现</td> <td>通常在这个方法中来设置并行任务的执行环境，如具体的线程等。这个方法是operation 对象的起始点。在这个方法中不可以调用super 的方法。</td></tr> <tr><td>main</td> <td>可选的</td> <td>在这个方法中实现具体要完成的任务。虽然实现也可以放在start 方法中来做，但是放在main 方法中可以使得设置和执行分离，使得代码的逻辑更加清晰。</td></tr> <tr><td>isExecuting, isFinished</td> <td>必须实现</td> <td>这两个方法用来向外部对象报告operation 对象的运行状态。 这两个方法的实现必须是线程安全的。</td></tr> <tr><td>isConcurrent</td> <td>必须实现</td> <td>为了确认一个operation 对象是否是并行的，需要重载这个方法，让它返回YES。</td></tr></tbody></table> <p>有了以上知识作铺垫，我们来看下一个并行operation 对象应该怎么完整地实现：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@interface MyOperation : NSOperation {
    BOOL        executing;
    BOOL        finished;
}
- (void)completeOperation;
@end
 
@implementation MyOperation
- (id)init {
    self = [super init];
    if (self) {
        executing = NO;
        finished = NO;
    }
    return self;
}
 
- (void)start {
   // Always check for cancellation before launching the task.
   if ([self isCancelled])
   {
      // Must move the operation to the finished state if it is canceled.
      [self willChangeValueForKey:@&quot;isFinished&quot;];
      finished = YES;
      [self didChangeValueForKey:@&quot;isFinished&quot;];
      return;
   }
 
   // If the operation is not canceled, begin executing the task.
   [self willChangeValueForKey:@&quot;isExecuting&quot;];
   
   // 在另一个线程上执行main 方法
   [NSThread detachNewThreadSelector:@selector(main) toTarget:self withObject:nil];
   executing = YES;
   [self didChangeValueForKey:@&quot;isExecuting&quot;];
}

- (void)main {
   @try {
 
       // Do the main work of the operation here.
 
       [self completeOperation];
   }
   @catch(...) {
      // Do not rethrow exceptions.
   }
}
 
- (void)completeOperation {
    [self willChangeValueForKey:@&quot;isFinished&quot;];
    [self willChangeValueForKey:@&quot;isExecuting&quot;];
 
    executing = NO;
    finished = YES;
 
    [self didChangeValueForKey:@&quot;isExecuting&quot;];
    [self didChangeValueForKey:@&quot;isFinished&quot;];
}
 
 
- (BOOL)isConcurrent {
    return YES;
}


- (BOOL)isExecuting {
    return executing;
}
 
- (BOOL)isFinished {
    return finished;
}

@end

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div><p>注意：即使operation 对象是被取消的，也需要通知这个对象的观察者它已经完成了。因为如果一个operation 对象依赖于其他对象，那么它会观察其他对象的<code>isFinished</code>属性，只有当它所依赖的对象都已经发出了完成的信号后，这个对象才会开始运行。所以如果忘记发出完成通知，那么可能就有一个operation 对象永远都无法执行。</p> <h3 id="自定义operation-对象的执行行为"><a href="#自定义operation-对象的执行行为" class="header-anchor">#</a> 自定义operation 对象的执行行为</h3> <h4 id="配置对象间的依赖关系"><a href="#配置对象间的依赖关系" class="header-anchor">#</a> 配置对象间的依赖关系</h4> <p>前面多次提到，一个operation 对象可能依赖于另外几个operation 对象。在它所依赖的一个operation 对象都运行完成后，这个operation 对象才可以开始运行。</p> <p>为一个operation 对象配置依赖的操作很简单，只需要调用下面这个函数：</p> <div class="language- extra-class"><pre><code>- (void) addDependency:(NSOperation *)op;
</code></pre></div><h4 id="改变operation-对象的执行优先级"><a href="#改变operation-对象的执行优先级" class="header-anchor">#</a> 改变operation 对象的执行优先级</h4> <p>对于队列中的operation 对象，它们的执行顺序取决于它们各自的优先级。更准确的说，对于那些已经ready 的operation 对象来说，优先级高的先执行，优先级低的后执行。</p> <p>operation 对象的优先级用这个函数来设置：</p> <div class="language- extra-class"><pre><code>- (void) setQueuePriority:(NSOperationQueuePriority) priority;
</code></pre></div><p>priority 的可能取值有这几个：</p> <ul><li>NSOperationQueuePriorityVeryLow</li> <li>NSOperationQueuePriorityLow</li> <li>NSOperationQueuePriorityNormal</li> <li>NSOperationQueuePriorityHigh</li> <li>NSOperationQueuePriorityVeryHigh</li></ul> <h4 id="设置完成时的block"><a href="#设置完成时的block" class="header-anchor">#</a> 设置完成时的block</h4> <p>当operation 对象执行完它的任务后，可以用<code>setCompletionBlock:</code> 这个函数来设置接下来的工作。</p> <div class="language- extra-class"><pre><code>- (void) setCompletionBlock:(void ^(void))block
</code></pre></div><h3 id="执行operations"><a href="#执行operations" class="header-anchor">#</a> 执行operations</h3> <p>当完成了对operation 对象的配置后，就可以执行了。</p> <h4 id="使用operationqueue"><a href="#使用operationqueue" class="header-anchor">#</a> 使用OperationQueue</h4> <p>执行Operation 的最简单的方法是使用<code>NSOperationQueue</code> 。它也是我们分析<code>SDWebImage</code> 时所关注的一个核心类。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>NSOperationQueue* aQueue = [[NSOperationQueue alloc] init];

[aQueue addOperation:anOp]; // Add a single operation
[aQueue addOperations:anArrayOfOps waitUntilFinished:NO]; // Add multiple operations
[aQueue addOperationWithBlock:^{
   /* Do something. */
}];
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p>Never modify an operation object after it has been added to a queue. While waiting in a queue, the operation could start executing at any time, so changing its dependencies or the data it contains could have adverse effects. If you want to know the status of an operation, you can use the methods of the NSOperation class to determine if the operation is running, waiting to run, or already finished.</p></blockquote> <p>如果使用<code>setMaxConcurrentOperationCount:</code> 将一个operationQueue 的最大可并行operation 数设置为1， 那么这个队列一次只能执行一个operation。</p> <h4 id="取消operations"><a href="#取消operations" class="header-anchor">#</a> 取消operations</h4> <p><code>cancelAllOperations</code> 可以用来取消一个operationQueue 内的所有operation。</p> <div class="language- extra-class"><pre><code>[operationQueue cancelAllOperations];
</code></pre></div><h4 id="等待operations-完成"><a href="#等待operations-完成" class="header-anchor">#</a> 等待operations 完成</h4> <p>在一个operation 实例上调用<code>waitUntilFinished</code>可以短暂地阻塞这个operation，直到此opeartion 执行完。但是通常应该避免这样做。尤其是不要在主线程上调用这个方法，否则可能阻塞主线程，导致程序失去响应。</p> <h4 id="阻塞operation"><a href="#阻塞operation" class="header-anchor">#</a> 阻塞operation</h4> <p>在operationQueue 上调用<code>setSuspended</code> 可以阻塞那些还没有执行的operation，但是不会影响那些正在执行的和已经执行的operation。</p> <h2 id="sdwebimage-中的实现"><a href="#sdwebimage-中的实现" class="header-anchor">#</a> SDWebImage 中的实现</h2> <p><code>SDWebImage</code> 中，使用NSOperation 对象和GCD 的地方主要有两处，一处是在<code>SDWebImageDownloader</code> 中使用<code>SDWebImageDownloaderOperation</code> 来完成图片的<strong>下载</strong>任务；一处是在<code>SDWebImageManager</code> 使用<code>SDWebImageCombinedOperation</code>来完成下载后图片的<strong>缓存</strong>任务。我们只分析<code>SDWebImageDownloader</code> 中的多线程策略。</p> <h3 id="sdwebimagedownloader"><a href="#sdwebimagedownloader" class="header-anchor">#</a> SDWebImageDownloader</h3> <p>在这个类的类扩展中，有几个属性是与Operation 和OperationQueue 对象有联系的：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@property (strong, nonatomic, nonnull) NSOperationQueue *downloadQueue;
@property (weak, nonatomic, nullable) NSOperation *lastAddedOperation;

// This queue is used to serialize the handling of the network responses of all the download operation in a single queue
@property (SDDispatchQueueSetterSementics, nonatomic, nullable) dispatch_queue_t barrierQueue;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>从名字和注释中不难猜测到它们各自的作用：</p> <ul><li>downloadQueue：用来管理 download 操作的队列。</li> <li>lastAddedOperation：上一个被添加进队列的 operation。</li> <li>barrierQueue：这是一个dispatch_queue_t 类型的属性，作用是串行地处理所有 download 操作的网络响应。</li></ul> <h4 id="sdwebimagedownloaderoperation"><a href="#sdwebimagedownloaderoperation" class="header-anchor">#</a> SDWebImageDownloaderOperation</h4> <p><code>SDWebImageDownloaderOperation</code> 是<code>NSOperation</code> 的子类，是<code>SDWebImage</code> 中完成下载任务的operation 对象。这个operation 对象的设计，符合我们在『实现自定义的NSOperation 子类』一节中介绍的各种要求。对于它的start 和其他方法，由于是对网络请求部分的具体实现，与本文主题无关，因此暂时不做介绍（日后若有时间，我将专门写一篇博客来介绍<code>SDWebImage</code> 中的网络部分）。</p> <h4 id="downloadqueue"><a href="#downloadqueue" class="header-anchor">#</a> downloadQueue</h4> <p>在<code>downloadImageWithURL:options:progress:completed:</code>这个方法中，<code>SDWebImageDownloader</code> 为每一个下载图片的请求创建一个<code>SDWebImageDownloaderOperation</code> ，并将这个<code>SDWebImageDownloaderOperation</code> 加入downloadQueue 中。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>SDWebImageDownloaderOperation *operation = [[sself.operationClass alloc] initWithRequest: request inSession: sself.session options: options];


// 根据传入的SDWebImageDownloaderOptions 来设置当前operation 的优先级
if (options &amp; SDWebImageDownloaderHighPriority) {
    operation.queuePriority = NSOperationQueuePriorityHigh;
} else if (options &amp; SDWebImageDownloaderLowPriority) {
    operation.queuePriority = NSOperationQueuePriorityLow;
}

[sself.downloadQueue addOperation:operation];
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>在将operation 添加进downloadQueue 后，还可以设置operation 对象在这个队列中的执行顺序：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>if (sself.executionOrder == SDWebImageDownloaderLIFOExecutionOrder) {
    [sself.lastAddedOperation addDependency:operation];
    sself.lastAddedOperation = operation;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>downloadQueue 的默认执行顺序是</p> <ul><li><code>SDWebImageDownloaderFIFOExecutionOrder</code>，也就是先入先出，其行为类似于一个队列；</li></ul> <p>当执行顺序改为</p> <ul><li><code>SDWebImageDownloaderLIFOExecutionOrder</code> 时，则是后入先出，其行为类似于一个栈。<code>lastAddedOperation</code> 就是用来记录当前栈顶的那个operation 的，当有新的operation 要进栈时，就把这个新的operation 设置为<code>lastAddedOperation</code> 的依赖，这样的话，只有新的operation 执行完毕，<code>lastAddedOperation</code> 才能开始执行，因此就实现了后入先出的效果。</li></ul> <h4 id="barrierqueue"><a href="#barrierqueue" class="header-anchor">#</a> barrierQueue</h4> <p>前面提到，<code>barrierQueue</code> 是用来串行地处理所有的download 操作的网络响应的。关于<code>dispatch_queue_t</code> 和<code>NSOperation</code> 的对比，可以参见<a href="http://stackoverflow.com/questions/10373331/nsoperation-vs-grand-central-dispatch" target="_blank" rel="noopener noreferrer">这儿<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。
我们来看下具体的操作过程是什么样子的。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>- (nullable SDWebImageDownloadToken *)addProgressCallback:(SDWebImageDownloaderProgressBlock)progressBlock
                                           completedBlock:(SDWebImageDownloaderCompletedBlock)completedBlock
                                                   forURL:(nullable NSURL *)url
                                           createCallback:(SDWebImageDownloaderOperation *(^)())createCallback {
    // The URL will be used as the key to the callbacks dictionary so it cannot be nil. If it is nil immediately call the completed block with no image or data.
    if (url == nil) {
        if (completedBlock != nil) {
            completedBlock(nil, nil, nil, NO);
        }
        return nil;
    }

    __block SDWebImageDownloadToken *token = nil;

    dispatch_barrier_sync(self.barrierQueue, ^{
        SDWebImageDownloaderOperation *operation = self.URLOperations[url];
        if (!operation) {
            operation = createCallback();
            self.URLOperations[url] = operation;

            __weak SDWebImageDownloaderOperation *woperation = operation;
            operation.completionBlock = ^{
              SDWebImageDownloaderOperation *soperation = woperation;
              if (!soperation) return;
              if (self.URLOperations[url] == soperation) {
                  [self.URLOperations removeObjectForKey:url];
              };
            };
        }
        id downloadOperationCancelToken = [operation addHandlersForProgress:progressBlock completed:completedBlock];

        token = [SDWebImageDownloadToken new];
        token.url = url;
        token.downloadOperationCancelToken = downloadOperationCancelToken;
    });

    return token;
}


- (void)cancel:(nullable SDWebImageDownloadToken *)token {
    dispatch_barrier_async(self.barrierQueue, ^{
        SDWebImageDownloaderOperation *operation = self.URLOperations[token.url];
        BOOL canceled = [operation cancel:token.downloadOperationCancelToken];
        if (canceled) {
            [self.URLOperations removeObjectForKey:token.url];
        }
    });
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>这段代码中，<code>SDWebImageDownloader</code> 维护了一个NSDictionary 用以将url 和url 对应的operation 联系起来。值得注意的是，在前一个方法中，使用了<code>dispatch_barrier_async</code>，在后一个方法中，则使用了<code>dispatch_barrier_sync</code>，那么这两个函数究竟有什么区别呢？</p> <p>我们知道<code>dispatch_barrier_async</code> 和<code>dispatch_barrier_sync</code>都是为了解决竞争问题而提出来的。举例来说，现在我们在项目中使用一个数据库，那么对数据库的操作就有读和写两种操作。假设我们需要先读两次数据库，然后再写入一个数据，然后再读出两个数据，那么显然读和写的操作是不能同时发生的，如果同时发生，就有可能造成数据错误。</p> <p>使用<code>dispatch_barrier_(a)sync</code>，上述任务可以这样实现：</p> <div class="language- extra-class"><pre><code>dispatch_async(queue, blk1_read);
dispatch_async(queue, blk2_read);
dispatch_async(queue, blk3_read);
dispatch_barrier_async(queue, blk_write);
dispatch_async(queue, blk4_read);
dispatch_async(queue, blk5_read);
</code></pre></div><p><code>dispatch_barrier_(a)sync</code> 就像是一个屏障一样，它确保blk_write 一定会等到blk1，blk2，blk3 全部执行完毕才开始执行，在blk_write 执行完毕后，blk4 和blk5 又正常地并行运行。</p> <p><code>sync</code> 和<code>async</code> 的区别体现在：将block 追加到指定的queue 中是否是同步的。如果是<code>async</code> 的，那么<code>dispatch_barrier_async</code> 不会等待追加操作结束，当前进程会继续进行；如果是<code>sync</code> 的，那么<code>dispatch_barrier_async</code> 会等待一直追加操作结束，当前进程会因此阻塞。</p> <p>用例子来解释：</p> <div class="language- extra-class"><pre><code>// A
// step1
dispatch_barrier_async(queue, ^{
    step2
});
// step3

// B
// step4
dispatch_barrier_sync(queue, ^{
    // step5
});
// step6
</code></pre></div><p>在A 中，step1 先执行，但是step3 可能会在step2 之前执行完，因此执行顺序可能是<code>step1-&gt;step2-&gt;step3</code>，也可能是<code>step1-&gt;step3-&gt;step2</code>；在B 中，执行的顺序则一定是<code>step4-&gt;step5-&gt;step6</code>。</p> <p>在<code>addProgressCallback:</code>方法中，因为需要返回一个token，而这个token 是在block 中计算的，所以我们一定要等到block 的追加操作完成才可以返回，否则就会得到nil，因此需要使用<code>dispatch_barrier_sync</code>；而在<code>cancel:</code> 方法中，不需要等待，因此使用<code>dispatch_barrier_async</code> 就可以了。</p></div> <!----> <div class="content__content-bottom"></div> <footer class="page-meta"><div class="edit-link"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon edit-icon"><path d="M117.953 696.992 64.306 959.696l265.931-49.336 450.204-452.505-212.284-213.376-450.204 452.513zm496.384-296.326L219.039 797.993l-46.108-46.34L568.233 354.33l46.104 46.335zm345.357-122.99-114.45 115.04-212.288-213.377 114.45-115.035 212.288 213.371zm0 0" fill="currentColor"></path></svg> <a href="https://github.com/tamarous/blog/edit/master/docs/iOS/sdwebimage_multithread.md" target="_blank" rel="noopener noreferrer">Edit this page</a></div> <div class="meta-item update-time"><span class="label">Last update:</span> <span class="info">August 29, 2021 11:41</span></div> <!----></footer> <!----> <!----> <!----> <div class="content__page-bottom"></div></main> <!----></div><div class="global-ui"><!----><!----><div id="pwa-install"><!----> <div id="install-modal-wrapper" style="display:none;"><div class="background"></div> <div class="install-modal"><div class="header"><button aria-label="Close" class="close-button"><svg width="23" height="22" xmlns="http://www.w3.org/2000/svg" class="icon close-icon"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.12.358a1.224 1.224 0 011.729 0l8.92 8.914L20.686.358a1.224 1.224 0 011.73 1.728L13.497 11l8.92 8.913a1.222 1.222 0 11-1.73 1.729l-8.919-8.913-8.92 8.913a1.224 1.224 0 01-1.729-1.729L10.04 11l-8.92-8.914a1.222 1.222 0 010-1.728z" fill="currentColor"></path></svg></button> <div class="logo"><!----> <div class="title"><h1></h1> <p class="desc">This app can be installed on your PC or mobile device.  This will allow this web app to look and behave like any other installed app.  You will find it in your app lists and be able to pin it to your home screen, start menus or task bars.  This installed web app will also be able to safely interact with other apps and your operating system. </p></div></div></div> <div class="content"><div class="highlight"><!----> <!----></div> <div class="description"><h3>Description</h3> <p></p></div></div> <div class="button-wrapper"><button class="install-button">
        Install <span></span></button> <button class="cancel-button">
        Cancel
      </button></div></div></div></div><div tabindex="-1" role="dialog" aria-hidden="true" class="pswp"><div class="pswp__bg"></div> <div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div></div> <div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button class="pswp__button pswp__button--close"></button> <button class="pswp__button pswp__button--share"></button> <button class="pswp__button pswp__button--fs"></button> <button class="pswp__button pswp__button--zoom"></button> <div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button class="pswp__button pswp__button--arrow--left"></button> <button class="pswp__button pswp__button--arrow--right"></button> <div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div></div></div>
    <script src="/blog/assets/js/app.df73a9a4.js" defer></script><script src="/blog/assets/js/vendors~layout-Layout.751f6b56.js" defer></script><script src="/blog/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.4f318220.js" defer></script><script src="/blog/assets/js/page-SDWebImage源代码剖析-多线程策略.2154a0a5.js" defer></script><script src="/blog/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.335ce4c4.js" defer></script>
  </body>
</html>
