<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>EasyTuple 源代码分析 | Tamarous&#39; blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="manifest" href="/blog/manifest.webmanifest" crossorigin="use-credentials">
    <meta name="description" content="">
    <meta property="og:url" content="/blog/iOS/easytuple_source_probe.html">
    <meta property="og:site_name" content="Tamarous' blog">
    <meta property="og:title" content="EasyTuple 源代码分析">
    <meta property="og:description" content="EasyTuple 源代码分析 EasyTuple是由美团开源的一个第三方库，它给Objective-C 添加了元组的能力，可以将几个对象包裹在一个对象中，这样我们就可以从一个函数中返回多个值。它的使用非常简单，比如我们想创建一个由两个元素组成的元组，那么可以这样写： 如果使用 Xcode 辅助编辑器查看预编译后的代码，那么上面的例子在预编译后，会被展开为 ">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="en-US">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image:alt" content="Tamarous' blog">
    <meta property="article:tag" content="源码分析">
    <meta name="theme-color" content="#46bd87">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    
    <link rel="preload" href="/blog/assets/css/0.styles.8b5d14a7.css" as="style"><link rel="preload" href="/blog/assets/js/app.a5fc5e5c.js" as="script"><link rel="preload" href="/blog/assets/js/vendors~layout-Layout.7e998ec2.js" as="script"><link rel="preload" href="/blog/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.4f318220.js" as="script"><link rel="preload" href="/blog/assets/js/page-EasyTuple源代码分析.2cf181b1.js" as="script"><link rel="preload" href="/blog/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.335ce4c4.js" as="script"><link rel="prefetch" href="/blog/assets/js/20.d0f2ea0a.js"><link rel="prefetch" href="/blog/assets/js/layout-Blog.cd958aaa.js"><link rel="prefetch" href="/blog/assets/js/layout-Layout.54347a9b.js"><link rel="prefetch" href="/blog/assets/js/layout-NotFound.5814876d.js"><link rel="prefetch" href="/blog/assets/js/layout-Slide.7b34a4ba.js"><link rel="prefetch" href="/blog/assets/js/page-Aspects源码分析.412f48d7.js"><link rel="prefetch" href="/blog/assets/js/page-Go语言精进之路学习笔记.f76e5743.js"><link rel="prefetch" href="/blog/assets/js/page-Home.60a9dfd0.js"><link rel="prefetch" href="/blog/assets/js/page-Masonry源代码剖析.cbf7490b.js"><link rel="prefetch" href="/blog/assets/js/page-SDWebImage源代码剖析-缓存策略.d1da4df3.js"><link rel="prefetch" href="/blog/assets/js/page-Stinger源码分析.18886dc7.js"><link rel="prefetch" href="/blog/assets/js/page-iOS知识总结.6be13718.js"><link rel="prefetch" href="/blog/assets/js/page-后端精进之路.51ae3f6b.js"><link rel="prefetch" href="/blog/assets/js/page-如何分析iOS系统库的实现.1038afd5.js"><link rel="prefetch" href="/blog/assets/js/vendors~photo-swipe.1934d3ab.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.8b5d14a7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container has-navbar has-anchor"><header class="navbar"><!----> <div class="content__navbar-start"></div> <button title="Sidebar Button" class="sidebar-button"><span class="icon"></span></button> <a href="/blog/" class="home-link router-link-active"><!----> <!----> <span class="site-name can-hide">Tamarous' blog</span></a> <!----> <div class="content__navbar-center"></div> <div class="links"><button tabindex="-1" aria-hidden="true" class="color-button"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="skin-icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4
        38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32
        51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0
        102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2
        6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4
        0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2
        9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224
        419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4
        470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0
        22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6
        12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128
        505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2
        16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8
        86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4
        80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6
        6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><ul class="themecolor-select"><label for="themecolor-select">Theme Color:</label> <li><span class="default-theme"></span></li> </ul> <div class="darkmode-toggle"><label for="darkmode-toggle" class="desc">Theme Mode:</label> <div class="darkmode-switch"><div class="item day"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon light-icon"><path d="M512 256a42.667 42.667 0 0 0 42.667-42.667V128a42.667 42.667 0 0 0-85.334 0v85.333A42.667 42.667 0 0 0 512 256zm384 213.333h-85.333a42.667 42.667 0 0 0 0 85.334H896a42.667 42.667 0 0 0 0-85.334zM256 512a42.667 42.667 0 0 0-42.667-42.667H128a42.667 42.667 0 0 0 0 85.334h85.333A42.667 42.667 0 0 0 256 512zm9.387-298.667a42.667 42.667 0 0 0-59.307 62.72l61.44 59.307a42.667 42.667 0 0 0 31.147 11.947 42.667 42.667 0 0 0 30.72-13.227 42.667 42.667 0 0 0 0-60.16zm459.946 133.974a42.667 42.667 0 0 0 29.44-11.947l61.44-59.307a42.667 42.667 0 0 0-57.6-62.72l-61.44 60.587a42.667 42.667 0 0 0 0 60.16 42.667 42.667 0 0 0 28.16 13.227zM512 768a42.667 42.667 0 0 0-42.667 42.667V896a42.667 42.667 0 0 0 85.334 0v-85.333A42.667 42.667 0 0 0 512 768zm244.48-79.36a42.667 42.667 0 0 0-59.307 61.44l61.44 60.587a42.667 42.667 0 0 0 29.44 11.946 42.667 42.667 0 0 0 30.72-12.8 42.667 42.667 0 0 0 0-60.586zm-488.96 0-61.44 59.307a42.667 42.667 0 0 0 0 60.586 42.667 42.667 0 0 0 30.72 12.8 42.667 42.667 0 0 0 28.587-10.666l61.44-59.307a42.667 42.667 0 0 0-59.307-61.44zM512 341.333A170.667 170.667 0 1 0 682.667 512 170.667 170.667 0 0 0 512 341.333z" fill="currentColor"></path></svg></div> <div class="item auto active"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon auto-icon"><path d="M460.864 539.072H564.8L510.592 376l-49.728 163.072zM872 362.368V149.504H659.648L510.528 0l-149.12 149.504H149.12v212.928L0 511.872l149.12 149.504v212.928h212.352l149.12 149.504 149.12-149.504h212.352V661.376l149.12-149.504L872 362.368zM614.464 693.12l-31.616-90.624H438.272l-31.616 90.624h-85.888l144.576-407.68h90.368l144.576 407.68h-85.824zm0 0" fill="currentColor"></path></svg></div> <div class="item night"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon dark-icon"><path d="M935.539 630.402c-11.43-11.432-28.674-14.739-43.531-8.354-46.734 20.103-96.363 30.297-147.508 30.297-99.59 0-193.221-38.784-263.64-109.203-108.637-108.637-139.61-270.022-78.908-411.148a39.497 39.497 0 0 0-51.886-51.887c-52.637 22.64-100.017 54.81-140.826 95.616-85.346 85.346-132.346 198.821-132.346 319.52 0 120.7 47.001 234.172 132.347 319.519S408.063 947.11 528.76 947.11c120.7 0 234.172-47.003 319.52-132.351 40.809-40.81 72.978-88.19 95.616-140.826a39.497 39.497 0 0 0-8.356-43.532z" fill="currentColor"></path></svg></div></div> <!----></div></div></div></button> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active"><!---->
  Home
</a></div><div class="nav-item"><a href="/blog/iOS/" class="nav-link router-link-active active"><!---->
  iOS
</a></div><div class="nav-item"><a href="/blog/Backend.html" class="nav-link"><!---->
  Backend
</a></div></nav> <!----> <a rel="noopener noreferrer" href="https://github.com/tamarous/blog" target="_blank" class="repo-link can-hide">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <!----> <div class="content__navbar-end"></div></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!----> <!----> <div class="content__sidebar-top"></div> <nav class="sidebar-nav-links"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active"><!---->
  Home
</a></div><div class="nav-item"><a href="/blog/iOS/" class="nav-link router-link-active active"><!---->
  iOS
</a></div><div class="nav-item"><a href="/blog/Backend.html" class="nav-link"><!---->
  Backend
</a></div> <a rel="noopener noreferrer" href="https://github.com/tamarous/blog" target="_blank" class="repo-link">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <!----> <div class="content__sidebar-center"></div> <!----> <!----> <div class="content__sidebar-bottom"></div> <!----></aside> <main class="page"><nav class="breadcrumb"><ol vocab="https://schema.org/" typeof="BreadcrumbList"><li property="itemListElement" typeof="ListItem"><a href="/blog/iOS/" property="item" typeof="WebPage" class="router-link-active"><!----> <span property="name">iOS 知识总结</span></a> <meta property="position" content="1"></li><li property="itemListElement" typeof="ListItem" class="is-active"><a href="/blog/iOS/easytuple_source_probe/" aria-current="page" property="item" typeof="WebPage" class="router-link-exact-active router-link-active"><!----> <span property="name">EasyTuple 源代码分析</span></a> <meta property="position" content="2"></li></ol></nav> <!----> <div class="content__page-top"></div> <div vocab="https://schema.org/" typeof="Article" class="page-title"><h1><!----> <span property="headline">EasyTuple 源代码分析</span></h1> <div class="page-info"><!----> <!----><!----><span aria-label="Writing Date📅" data-balloon-pos="down" class="time-info"><svg viewBox="0 0 1030 1024" xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H180.6A134.314 134.314 0 0 0 46.66 277.595v535.756A134.314 134.314 0 0 0 180.6 947.289h669.74a134.36 134.36 0 0 0 133.94-133.938V277.595a134.314 134.314 0 0 0-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 0 1-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 0 1-33.472 33.473z" fill="currentColor"></path></svg> <span property="datePublished">2024-2-24</span></span><span role="navigation" aria-label="Category🌈" data-balloon-pos="down" class="category-info enable"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon category-icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zm-.854 446.486H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zm446.371-446.486h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zm136.293 813.51H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z" fill="currentColor"></path></svg> <span property="articleSection">IOS</span></span><span aria-label="Tags🏷" data-balloon-pos="down"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon tag-icon"><path d="M939.902 458.563 910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 0 0 0 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z" fill="currentColor"></path></svg> <ul class="tags-wrapper"><li class="tag clickable tag0"><span role="navigation">源码分析</span></li></ul> <meta property="keywords" content="源码分析"></span><span aria-label="Reading Time⌛" data-balloon-pos="down" class="reading-time-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon timer-icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z" fill="currentColor"></path></svg> <span>About 13 min</span> <meta property="timeRequired" content="PT13M"></span></div> <!----> <hr></div> <div class="anchor-place-holder"><aside id="anchor"><div class="anchor-wrapper"><ul class="anchor-list"><li class="anchor"><a href="/blog/iOS/easytuple_source_probe/#eztuple" class="anchor-link heading2"><div>EZTuple</div></a></li><li class="anchor"><a href="/blog/iOS/easytuple_source_probe/#ez-concat" class="anchor-link heading3"><div>EZ_CONCAT</div></a></li><li class="anchor"><a href="/blog/iOS/easytuple_source_probe/#ez-arg-count" class="anchor-link heading3"><div>EZARGCOUNT</div></a></li><li class="anchor"><a href="/blog/iOS/easytuple_source_probe/#ez-arg-head" class="anchor-link heading3"><div>EZARGHEAD</div></a></li><li class="anchor"><a href="/blog/iOS/easytuple_source_probe/#ez-for-each" class="anchor-link heading3"><div>EZFOREACH</div></a></li><li class="anchor"><a href="/blog/iOS/easytuple_source_probe/#ez-tuple-classes-def" class="anchor-link heading2"><div>EZTUPLECLASSES_DEF</div></a></li><li class="anchor"><a href="/blog/iOS/easytuple_source_probe/#ez-for-comma" class="anchor-link heading3"><div>EZFORCOMMA</div></a></li><li class="anchor"><a href="/blog/iOS/easytuple_source_probe/#ez-generic-type-index" class="anchor-link heading3"><div>EZGENERICTYPE(index)</div></a></li><li class="anchor"><a href="/blog/iOS/easytuple_source_probe/#ez-for-recursive" class="anchor-link heading3"><div>EZFORRECURSIVE</div></a></li><li class="anchor"><a href="/blog/iOS/easytuple_source_probe/#ez-property-def-index" class="anchor-link heading3"><div>EZPROPERTYDEF(index)</div></a></li><li class="anchor"><a href="/blog/iOS/easytuple_source_probe/#ez-for-space" class="anchor-link heading3"><div>EZFORSPACE</div></a></li><li class="anchor"><a href="/blog/iOS/easytuple_source_probe/#小结" class="anchor-link heading2"><div>小结</div></a></li><li class="anchor"><a href="/blog/iOS/easytuple_source_probe/#参考资料" class="anchor-link heading2"><div>参考资料：</div></a></li></ul></div></aside></div> <!----> <div class="content__content-top"></div> <div class="theme-default-content content__default"><h1 id="easytuple-源代码分析"><a href="#easytuple-源代码分析" class="header-anchor">#</a> EasyTuple 源代码分析</h1> <p><a href="https://github.com/meituan/EasyTuple" target="_blank" rel="noopener noreferrer"><code>EasyTuple</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是由美团开源的一个第三方库，它给Objective-C 添加了元组的能力，可以将几个对象包裹在一个对象中，这样我们就可以从一个函数中返回多个值。它的使用非常简单，比如我们想创建一个由两个元素组成的元组，那么可以这样写：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZTuple2&lt;NSNumber *, NSString *&gt; *tuple = EZTuple(@1, @&quot;string&quot;);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果使用 Xcode 辅助编辑器查看预编译后的代码，那么上面的例子在预编译后，会被展开为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZTuple2&lt;NSNumber *, NSString *&gt; *tuple = [[EZTuple2 alloc] initWithFirst:@1 second:@&quot;string&quot;];
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以看到原来的宏的写法会自动被转换成 Objective-C 中的类的创建语法了，那么这个转换过程是怎样发生的呢？下面让我们一步步地去分析这个转换的过程。</p> <h2 id="eztuple"><a href="#eztuple" class="header-anchor">#</a> EZTuple</h2> <p>右边这个看起来像函数的<code>EZTuple</code>，其实是一个宏：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define EZTuple(...) EZTupleAs(EZ_CONCAT(EZTuple, EZ_ARG_COUNT(__VA_ARGS__)), __VA_ARGS__)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="ez-concat"><a href="#ez-concat" class="header-anchor">#</a> EZ_CONCAT</h3> <p>我们遇到的第一个宏就是 <code>EZ_CONCAT</code>，它的定义如下</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define EZ_CONCAT(A, B) EZ_CONCAT_(A, B)
#define EZ_CONCAT_(A, B) A ## B
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>作用是把 A 和 B 两个字符串连接到一起，比如
<code>EZ_CONCAT(hello, world)</code>的结果就是<code>helloworld</code>。</p> <h3 id="ez-arg-count"><a href="#ez-arg-count" class="header-anchor">#</a> EZ_ARG_COUNT</h3> <p><code>EZ_ARG_COUNT</code>是我们遇到的第二个宏，它的定义有些复杂：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define EZ_ARG_COUNT(...)   _EZ_ARG_COUNT(__VA_ARGS__)
#define _EZ_ARG_COUNT(...)  EZ_ARG_AT(20, ##__VA_ARGS__, 20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0)

#define EZ_ARG_AT(N, ...)                                    EZ_ARG_AT_(N, __VA_ARGS__)
#define EZ_ARG_AT_(N, ...)                                   EZ_CONCAT(EZ_ARG_AT, N)(__VA_ARGS__)
#define EZ_ARG_AT0(...)                                      EZ_ARG_HEAD(__VA_ARGS__)
#define EZ_ARG_AT1(_0, ...)                                  EZ_ARG_HEAD(__VA_ARGS__)
#define EZ_ARG_AT2(_0, _1, ...)                              EZ_ARG_HEAD(__VA_ARGS__)
#define EZ_ARG_AT3(_0, _1, _2, ...)                          EZ_ARG_HEAD(__VA_ARGS__)
#define EZ_ARG_AT4(_0, _1, _2, _3, ...)                      EZ_ARG_HEAD(__VA_ARGS__)
#define EZ_ARG_AT5(_0, _1, _2, _3, _4, ...)                  EZ_ARG_HEAD(__VA_ARGS__)
#define EZ_ARG_AT6(_0, _1, _2, _3, _4, _5, ...)              EZ_ARG_HEAD(__VA_ARGS__)
#define EZ_ARG_AT7(_0, _1, _2, _3, _4, _5, _6, ...)          EZ_ARG_HEAD(__VA_ARGS__)
#define EZ_ARG_AT8(_0, _1, _2, _3, _4, _5, _6, _7, ...)      EZ_ARG_HEAD(__VA_ARGS__)
#define EZ_ARG_AT9(_0, _1, _2, _3, _4, _5, _6, _7, _8, ...)  EZ_ARG_HEAD(__VA_ARGS__)
#define EZ_ARG_AT10(_0, _1, _2, _3, _4, _5, _6, _7, _8, _9, ...)                                                                \
    EZ_ARG_HEAD(__VA_ARGS__)
#define EZ_ARG_AT11(_0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, ...)                                                           \
    EZ_ARG_HEAD(__VA_ARGS__)
#define EZ_ARG_AT12(_0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, _11, ...)                                                      \
    EZ_ARG_HEAD(__VA_ARGS__)
#define EZ_ARG_AT13(_0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, _11, _12, ...)                                                 \
    EZ_ARG_HEAD(__VA_ARGS__)
#define EZ_ARG_AT14(_0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, _11, _12, _13, ...)                                            \
    EZ_ARG_HEAD(__VA_ARGS__)
#define EZ_ARG_AT15(_0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, _11, _12, _13, _14, ...)                                       \
    EZ_ARG_HEAD(__VA_ARGS__)
#define EZ_ARG_AT16(_0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, _11, _12, _13, _14, _15, ...)                                  \
    EZ_ARG_HEAD(__VA_ARGS__)
#define EZ_ARG_AT17(_0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, _11, _12, _13, _14, _15, _16, ...)                             \
    EZ_ARG_HEAD(__VA_ARGS__)
#define EZ_ARG_AT18(_0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, _11, _12, _13, _14, _15, _16, _17, ...)                        \
    EZ_ARG_HEAD(__VA_ARGS__)
#define EZ_ARG_AT19(_0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, _11, _12, _13, _14, _15, _16, _17, _18, ...)                   \
    EZ_ARG_HEAD(__VA_ARGS__)
#define EZ_ARG_AT20(_0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, _11, _12, _13, _14, _15, _16, _17, _18, _19, ...)              \
    EZ_ARG_HEAD(__VA_ARGS__)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p><code>EZ_ARG_COUNT</code>是对<code>_EZ_ARG_COUNT</code>的一个包装。它会被展开为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_ARG_AT(20,##__VA_ARGS__, 20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>根据</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define EZ_ARG_AT(N, ...)   EZ_ARG_AT_(N, __VA_ARGS__)
#define EZ_ARG_AT_(N, ...)  EZ_CONCAT(EZ_ARG_AT, N)(__VA_ARGS__)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>上面这个宏就是<code>EZ_CONCAT(EZ_ARG_AT, 20)(__VA_ARGS__)</code>，而<code>EZ_CONCAT(EZ_ARG_AT, 20)</code>也就是<code>EZ_ARG_AT20</code>，因此这个宏进而就等同于</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_ARG_AT20(##__VA_ARGS__, 20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>也就是说我们在使用<code>EZ_ARG_COUNT(...)</code>这个宏的时候，它会被最终展开为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_ARG_AT20(##__VA_ARGS__, 20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>现在假设有这么一行代码<code>EZ_ARG_COUNT(1,2,3)</code>，那么它就会展开为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_ARG_AT20(1, 2, 3, 20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们注意到</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define EZ_ARG_AT20(_0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, _11, _12, _13, _14, _15, _16, _17, _18, _19, ...)              \
    EZ_ARG_HEAD(__VA_ARGS__)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>1占据了_0的位置，2占据了_1的位置，3占据了_3的位置，20，19，18，...，4依次占据了
_4、_5、_6、... _19的位置，剩下的3，2，1，0被当做参数传入了 <code>EZ_ARG_HEAD</code>中，
因此<code>EZ_ARG_COUNT(1,2,3)</code>会被展开为 <code>EZ_ARG_HEAD(3,2,1,0)</code>。</p> <h3 id="ez-arg-head"><a href="#ez-arg-head" class="header-anchor">#</a> EZ_ARG_HEAD</h3> <p><code>EZ_ARG_HEAD</code>的定义如下</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define EZ_ARG_HEAD(FIRST, ...)             FIRST
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>它的作用是取出宏的第一个参数，因此</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_ARG_HEAD(3,2,1,0) = 3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>也就是</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_ARG_COUNT(1,2,3) = 3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>因此<code>EZ_ARG_COUNT</code>的作用就是<strong>获得输入的参数的个数</strong>。</p> <p>由以上三个宏的定义，<code>EZTuple(@1, @&quot;string&quot;)</code>会被展开为<code>EZTupleAs(EZTuple2, @1, @&quot;string&quot;)</code>。</p> <p>进而，根据<code>EZTupleAs</code>的定义</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define EZTupleAs(_Class_, ...) [[_Class_ alloc] EZ_CONCAT(initWith, EZ_FOR_EACH(EZ_INIT_PARAM_CALL, ,__VA_ARGS__))]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>EZTupleAs(EZTuple2, @1, @&quot;string&quot;)</code>会被展开为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[[EZTuple2 alloc] EZ_CONCAT(initWith, EZ_FOR_EACH(EZ_INIT_PARAM_CALL, ,@1, @&quot;string&quot;))]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="ez-for-each"><a href="#ez-for-each" class="header-anchor">#</a> EZ_FOR_EACH</h3> <p><code>EZ_FOR_EACH</code>的定义如下</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define EZ_FOR_EACH(...)    _EZ_FOR_EACH(__VA_ARGS__)
#define _EZ_FOR_EACH(MACRO, SEP, ...)   EZ_FOR_EACH_CTX(EZ_FOR_EACH_ITER_, SEP, MACRO, ##__VA_ARGS__)

#define EZ_FOR_EACH_CTX(MACRO, SEP, CTX, ...)                EZ_CONCAT(EZ_FOR_EACH_CTX, EZ_ARG_COUNT(__VA_ARGS__))(MACRO, SEP, CTX, ##__VA_ARGS__)
#define EZ_FOR_EACH_CTX0(MACRO, SEP, CTX)
#define EZ_FOR_EACH_CTX1(MACRO, SEP, CTX, _0) MACRO(0, _0, CTX)
#define EZ_FOR_EACH_CTX2(MACRO, SEP, CTX, _0, _1) \
    EZ_FOR_EACH_CTX1(MACRO, SEP, CTX, _0) SEP MACRO(1, _1, CTX)
#define EZ_FOR_EACH_CTX3(MACRO, SEP, CTX, _0, _1, _2) \
    EZ_FOR_EACH_CTX2(MACRO, SEP, CTX, _0, _1) SEP MACRO(2, _2, CTX)
#define EZ_FOR_EACH_CTX4(MACRO, SEP, CTX, _0, _1, _2, _3) \
    EZ_FOR_EACH_CTX3(MACRO, SEP, CTX, _0, _1, _2) SEP MACRO(3, _3, CTX)
#define EZ_FOR_EACH_CTX5(MACRO, SEP, CTX, _0, _1, _2, _3, _4) \
    EZ_FOR_EACH_CTX4(MACRO, SEP, CTX, _0, _1, _2, _3) SEP MACRO(4, _4, CTX)
// 中间定义都是类似的，为了节省篇幅就不列出了
    EZ_FOR_EACH_CTX18(MACRO, SEP, CTX, _0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, _11, _12, _13, _14, _15, _16, _17) SEP MACRO(18, _18, CTX)
#define EZ_FOR_EACH_CTX20(MACRO, SEP, CTX, _0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, _11, _12, _13, _14, _15, _16, _17, _18, _19) \
    EZ_FOR_EACH_CTX19(MACRO, SEP, CTX, _0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, _11, _12, _13, _14, _15, _16, _17, _18) SEP MACRO(19, _19, CTX)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>对于<code>EZTupleAs(EZTuple2, @1, @&quot;string&quot;)</code>展开的结果中的<code>EZ_FOR_EACH(EZ_INIT_PARAM_CALL, ,@1, @&quot;string&quot;)</code>而言，<code>MACRO</code>为<code>EZ_INIT_PARAM_CALL</code>，<code>SEP</code>为空，<code>...</code>为<code>@1, @&quot;string&quot;</code>，所以
它会被展开为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_FOR_EACH_CTX(EZ_FOR_EACH_ITER_, , EZ_INIT_PARAM_CALL, @1, @&quot;string&quot;)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>根据</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define EZ_FOR_EACH_CTX(MACRO, SEP, CTX, ...)   EZ_CONCAT(EZ_FOR_EACH_CTX, EZ_ARG_COUNT(__VA_ARGS__))(MACRO, SEP, CTX, ##__VA_ARGS__)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>那么对于<code>EZ_FOR_EACH_CTX(EZ_FOR_EACH_ITER_, , EZ_INIT_PARAM_CALL, @1, @&quot;string&quot;)</code>，<code>MACRO</code>为<code>EZ_FOR_EACH_ITER_</code>，<code>SEP</code>为空，<code>CTX</code>为<code>EZ_INIT_PARAM_CALL</code>，所以它会被展开为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_FOR_EACH_CTX2(EZ_FOR_EACH_ITER_,,EZ_INIT_PARAM_CALL,@1, @&quot;string&quot;)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>再根据</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define EZ_FOR_EACH_CTX1(MACRO, SEP, CTX, _0) MACRO(0, _0, CTX)
#define EZ_FOR_EACH_CTX2(MACRO, SEP, CTX, _0, _1) \
    EZ_FOR_EACH_CTX1(MACRO, SEP, CTX, _0) SEP MACRO(1, _1, CTX)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>MACRO</code>为<code>EZ_FOR_EACH_ITER_</code>，<code>SEP</code>为空，<code>CTX</code>为<code>EZ_INIT_PARAM_CALL</code>，_0为@1，_1为@&quot;string&quot;，所以上式首先会被展开为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_FOR_EACH_CTX1(EZ_FOR_EACH_ITER_, , EZ_INIT_PARAM_CALL, @1) EZ_FOR_EACH_ITER_(1, @&quot;string&quot;, EZ_INIT_PARAM_CALL)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_FOR_EACH_CTX1(EZ_FOR_EACH_ITER_, ,EZ_INIT_PARAM_CALL, @1)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>中，<code>MACRO</code>为<code>EZ_FOR_EACH_ITER_</code>，<code>SEP</code>为空，<code>CTX</code>为<code>EZ_INIT_PARAM_CALL</code>，_0为@1，所以它会被展开成</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_FOR_EACH_ITER_(0,@1,EZ_INIT_PARAM_CALL)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>所以</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_FOR_EACH_CTX2(EZ_FOR_EACH_ITER_,,EZ_INIT_PARAM_CALL,@1, @&quot;string&quot;)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被展开为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_FOR_EACH_ITER_(0, @1, EZ_INIT_PARAM_CALL) EZ_FOR_EACH_ITER_(1, @&quot;string&quot;, EZ_INIT_PARAM_CALL)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>也就是说，最一开始的</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_FOR_EACH(EZ_INIT_PARAM_CALL, ,@1, @&quot;string&quot;)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>被展开为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_FOR_EACH_ITER_(0, @1, EZ_INIT_PARAM_CALL) EZ_FOR_EACH_ITER_(1, @&quot;string&quot;, EZ_INIT_PARAM_CALL)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们先关注<code>EZ_FOR_EACH_ITER_(0, @1, EZ_INIT_PARAM_CALL)</code>的展开情况。<code>EZ_FOR_EACH_ITER_(1, @&quot;string&quot;, EZ_INIT_PARAM_CALL)</code>和它是类似的。
根据</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define EZ_FOR_EACH_ITER_(INDEX, PARAM, MACRO)               MACRO(INDEX, PARAM)
#define _EZ_INIT_PARAM_CALL_FIRST(index, param)              EZ_ORDINAL_CAP_AT(index):param
#define _EZ_INIT_PARAM_CALL(index, param)                    EZ_ORDINAL_AT(index):param
#define EZ_INIT_PARAM_CALL(index, param)                     EZ_IF_EQ(0, index)(_EZ_INIT_PARAM_CALL_FIRST(index, param))(_EZ_INIT_PARAM_CALL(index, param))
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>那么<code>EZ_FOR_EACH_ITER_(0, @1, EZ_INIT_PARAM_CALL)</code>会被展开为<code>EZ_INIT_PARAM_CALL(0, @1)</code>，进而被展开为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_IF_EQ(0, 0)(_EZ_INIT_PARAM_CALL_FIRST(0, @1))(_EZ_INIT_PARAM_CALL(0, @1))
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>EZ_IF_EQ</code>这个宏的定义如下</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define EZ_IF_EQ(A, B)                                       EZ_CONCAT(EZ_IF_EQ, A)(B)

#define EZ_CONSUME_(...)
#define EZ_EXPAND_(...)                                      __VA_ARGS__

#define EZ_IF_EQ0(VALUE)                                     EZ_CONCAT(EZ_IF_EQ0_, VALUE)
#define EZ_IF_EQ0_0(...)                                     __VA_ARGS__ EZ_CONSUME_
#define EZ_IF_EQ0_1(...)                                     EZ_EXPAND_
#define EZ_IF_EQ0_2(...)                                     EZ_EXPAND_
#define EZ_IF_EQ0_3(...)                                     EZ_EXPAND_
#define EZ_IF_EQ0_4(...)                                     EZ_EXPAND_
#define EZ_IF_EQ0_5(...)                                     EZ_EXPAND_
// 中间定义都是类似的，为了节省篇幅就不列出了
#define EZ_IF_EQ0_18(...)                                    EZ_EXPAND_
#define EZ_IF_EQ0_19(...)                                    EZ_EXPAND_
#define EZ_IF_EQ0_20(...)                                    EZ_EXPAND_

#define EZ_IF_EQ1(VALUE)                                        EZ_IF_EQ0(EZ_DEC(VALUE))
#define EZ_IF_EQ2(VALUE)                                     EZ_IF_EQ1(EZ_DEC(VALUE))
#define EZ_IF_EQ3(VALUE)                                     EZ_IF_EQ2(EZ_DEC(VALUE))
#define EZ_IF_EQ4(VALUE)                                     EZ_IF_EQ3(EZ_DEC(VALUE))
#define EZ_IF_EQ5(VALUE)                                     EZ_IF_EQ4(EZ_DEC(VALUE))
// 中间定义都是类似的，为了节省篇幅就不列出了
#define EZ_IF_EQ18(VALUE)                                    EZ_IF_EQ17(EZ_DEC(VALUE))
#define EZ_IF_EQ19(VALUE)                                    EZ_IF_EQ18(EZ_DEC(VALUE))
#define EZ_IF_EQ20(VALUE)                                    EZ_IF_EQ19(EZ_DEC(VALUE))
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>那么<code>EZ_IF_EQ(0, 0)</code>会被展开为<code>EZ_IF_EQ0(0)</code>，<code>EZ_IF_EQ0(0)</code>会被展开为<code>EZ_IF_EQ0_0</code>，所以</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_IF_EQ(0, 0)(_EZ_INIT_PARAM_CALL_FIRST(0, @1))(_EZ_INIT_PARAM_CALL(0, @1))
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被展开为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_IF_EQ0_0(_EZ_INIT_PARAM_CALL_FIRST(0, @1))(_EZ_INIT_PARAM_CALL(0, @1))
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>_EZ_INIT_PARAM_CALL_FIRST(0, @1)</code>会被展开为<code>EZ_ORDINAL_CAP_AT(0):@1</code>，<code>_EZ_INIT_PARAM_CALL(0, @1)</code>会被展开为<code>EZ_ORDINAL_AT(0):@1</code>。
<code>EZ_ORDINAL_CAP_AT</code>和<code>EZ_ORDINAL_AT</code>的定义如下</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define EZ_ORDINAL_AT(N)    EZ_ARG_AT(N, EZ_ORDINAL_NUMBERS)
#define EZ_ORDINAL_CAP_AT(N) EZ_ARG_AT(N, EZ_ORDINAL_CAP_NUMBERS)
#define EZ_ORDINAL_NUMBERS  first, second, third, fourth, fifth, sixth, seventh, eighth, ninth, tenth, eleventh, twelfth, thirteenth, fourteenth, fifteenth, sixteenth, seventeenth, eighteenth, nineteenth, twentieth
#define EZ_ORDINAL_CAP_NUMBERS  First, Second, Third, Fourth, Fifth, Sixth, Seventh, Eighth, Ninth, Tenth, Eleventh, Twelfth, Thirteenth, Fourteenth, Fifteenth, Sixteenth, Seventeenth, Eighteenth, Nineteenth, Twentieth
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>而 <code>EZ_ARG_AT(N, EZ_ORDINAL_NUMBERS)</code>这个宏是取<code>EZ_ORDINAL_NUMBERS</code>中的第 N 个参数，因此<code>EZ_ORDINAL_CAP_AT(0):@1</code>也就是<code>First:@1</code>，<code>EZ_ORDINAL_AT(0):@1</code>也就是<code>first:@1</code>。
所以</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_IF_EQ0_0(_EZ_INIT_PARAM_CALL_FIRST(0, @1))(_EZ_INIT_PARAM_CALL(0, @1))
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>也就是</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_IF_EQ0_0(First:@1)(first:@1)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>由</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define EZ_IF_EQ0_0(...)    __VA_ARGS__ EZ_CONSUME_
#define EZ_CONSUME_(...)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>可知，</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_IF_EQ0_0(First:@1)(first:@1)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被展开为<code>First:@1 EZ_CONSUME_(first:@1)</code>，进而展开为<code>First:@1</code>。
同理</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_FOR_EACH_ITER_(1, @&quot;string&quot;, EZ_INIT_PARAM_CALL)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>展开后得到<code>Second:@&quot;string&quot;</code>。
那么，</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_FOR_EACH(EZ_INIT_PARAM_CALL, ,@1, @&quot;string&quot;)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>最终被展开的结果就是<code>First:@1 Second:@&quot;string&quot;</code>，所以</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_CONCAT(initWith, EZ_FOR_EACH(EZ_INIT_PARAM_CALL, ,@1, @&quot;string&quot;))
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>展开的结果就是<code>initWithFirst:@1 Second:@&quot;string&quot;</code>。</p> <p>因此<code>EZTupleAs(EZTuple2, @1, @&quot;string&quot;)</code>就是</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[[EZTuple2 alloc] initWithFirst:@1 Second:@&quot;string&quot;]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>所以最开始的<code>EZTuple(@1,@&quot;string&quot;)</code>就被转换为了 Objective-C 中的类的创建语法。</p> <h2 id="ez-tuple-classes-def"><a href="#ez-tuple-classes-def" class="header-anchor">#</a> EZ_TUPLE_CLASSES_DEF</h2> <p>回到最开始的声明：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZTuple2&lt;NSNumber *, NSString *&gt; *tuple = EZTuple(@1, @&quot;string&quot;);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>左边的<code>EZTuple2</code>是一个类的名字，但是如果通过Xcode 中的<code>Go To Definition</code>来查看这个类的定义的话，会发现 Xcode 将这个类的定义定位到了一个文件中，这个文件里除了头文件外只有一行宏定义：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// EZTupleSubClasses.h
#import &lt;Foundation/Foundation.h&gt;
#import &lt;EasyTuple/EZMetaMacros.h&gt;
EZ_TUPLE_CLASSES_DEF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>EZ_TUPLE_CLASSES_DEF</code>这个宏的定义如下</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define EZ_TUPLE_CLASSES_DEF    EZ_FOR(20, EZ_TUPLE_DEF_FOREACH, ;)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>而 <code>EZ_FOR</code>的定义则是</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define EZ_FOR(COUNT, MARCO, SEP)                            EZ_CONCAT(EZ_FOR, COUNT)(MARCO, SEP)
#define EZ_FOR0(MARCO, SEP)
#define EZ_FOR1(MARCO, SEP)                                  MARCO(0)
#define EZ_FOR2(MARCO, SEP)                                  EZ_FOR1(MARCO, SEP) SEP MARCO(1)
#define EZ_FOR3(MARCO, SEP)                                  EZ_FOR2(MARCO, SEP) SEP MARCO(2)
#define EZ_FOR4(MARCO, SEP)                                  EZ_FOR3(MARCO, SEP) SEP MARCO(3)
#define EZ_FOR5(MARCO, SEP)                                  EZ_FOR4(MARCO, SEP) SEP MARCO(4)
// 中间定义都是类似的，为了节省篇幅就不列出了
#define EZ_FOR19(MARCO, SEP)                                 EZ_FOR18(MARCO, SEP) SEP MARCO(18)
#define EZ_FOR20(MARCO, SEP)                                 EZ_FOR19(MARCO, SEP) SEP MARCO(19)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>对于<code>EZ_FOR(20, EZ_TUPLE_DEF_FOREACH, ;)</code>，<code>COUNT</code>为20，<code>MACRO</code>为<code>EZ_TUPLE_DEF_FOREACH</code>，<code>SEP</code>为<code>;</code>，因此它会被展开为<code>EZ_CONCAT(EZ_FOR, COUNT)(MARCO, SEP)</code>，即<code>EZ_FOR20(EZ_TUPLE_DEF_FOREACH,;)</code>。而<code>EZ_FOR20(EZ_TUPLE_DEF_FOREACH,;)</code>展开后得到</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_FOR19(EZ_TUPLE_DEF_FOREACH,;) ; EZ_TUPLE_DEF_FOREACH(19)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>EZ_FOR19(EZ_TUPLE_DEF_FOREACH,;)</code>展开后得到</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_FOR18(EZ_TUPLE_DEF_FOREACH,;) ; EZ_TUPLE_DEF_FOREACH(18) ; EZ_TUPLE_DEF_FOREACH(18)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这样一层层展开，最终的结果为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_TUPLE_DEF_FOREACH(0) ; EZ_TUPLE_DEF_FOREACH(1) ; EZ_TUPLE_DEF_FOREACH(2) ; ... EZ_TUPLE_DEF_FOREACH(18); EZ_TUPLE_DEF_FOREACH(19)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>EZ_TUPLE_DEF_FOREACH(index)</code>的定义如下</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define EZ_TUPLE_DEF_FOREACH(index) EZ_TUPLE_DEF(EZ_INC(index))
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>内层的<code>EZ_INC(index)</code>会对index进行加1操作，那么<code>EZ_TUPLE_CLASSES_DEF</code>就会展开为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_TUPLE_DEF(1) ; EZ_TUPLE_DEF(2) ; ... EZ_TUPLE_DEF(18) ; EZ_TUPLE_DEF(19) ; EZ_TUPLE_DEF(20)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>接下来我们再看一下 <code>EZ_TUPLE_DEF(i)</code>的定义：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define EZ_TUPLE_DEF(i)                                                                                                         \
@interface EZ_CONCAT(EZTuple, i)&lt;EZ_FOR_COMMA(i, EZ_GENERIC_TYPE)&gt; :EZTupleBase                                                     \
                                                                                                                               \
EZ_FOR_RECURSIVE(i, EZ_PROPERTY_DEF, ;);                                                                                         \
                                                                                                                               \
@property (nonatomic, strong) EZ_CHARS_AT(EZ_DEC(i)) last;                                                                       \
                                                                                                                               \
- (instancetype)EZ_CONCAT(initWith, EZ_FOR_SPACE(i, EZ_INIT_PARAM));                                                              \
                                                                                                                               \
@end
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>可以看出<code>EZ_TUPLE_DEF(i)</code>展开后是一个类的定义，并且这个类的定义明显地可以分为三部分：第一部分是拼接出来的类名，该类继承自<code>EZTupleBase</code>，第二部分是通过<code>EZ_FOR_RECURSIVE</code>生成的属性，第三部分是拼接出来的初始化方法。</p> <h3 id="ez-for-comma"><a href="#ez-for-comma" class="header-anchor">#</a> EZ_FOR_COMMA</h3> <p>这个宏出现在类名中，</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define EZ_FOR_COMMA(COUNT, MARCO)                           EZ_CONCAT(EZ_FOR_COMMA, COUNT)(MARCO)
#define EZ_FOR_COMMA0(MARCO)
#define EZ_FOR_COMMA1(MARCO)                                 MARCO(0)
#define EZ_FOR_COMMA2(MARCO)                                 EZ_FOR_COMMA1(MARCO), MARCO(1)
#define EZ_FOR_COMMA3(MARCO)                                 EZ_FOR_COMMA2(MARCO), MARCO(2)
#define EZ_FOR_COMMA4(MARCO)                                 EZ_FOR_COMMA3(MARCO), MARCO(3)
#define EZ_FOR_COMMA5(MARCO)                                 EZ_FOR_COMMA4(MARCO), MARCO(4)
// 中间定义都是类似的，为了节省篇幅就不列出了
#define EZ_FOR_COMMA18(MARCO)                                EZ_FOR_COMMA17(MARCO), MARCO(17)
#define EZ_FOR_COMMA19(MARCO)                                EZ_FOR_COMMA18(MARCO), MARCO(18)
#define EZ_FOR_COMMA20(MARCO)                                EZ_FOR_COMMA19(MARCO), MARCO(19)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这个宏和上面提过的<code>EZ_FOR</code>非常类似，所以展开的结果也是类似的。那么对于<code>EZ_FOR_COMMA(2, EZ_GENERIC_TYPE)</code>，展开的结果为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_GENERIC_TYPE(0), EZ_GENERIC_TYPE(1)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="ez-generic-type-index"><a href="#ez-generic-type-index" class="header-anchor">#</a> EZ_GENERIC_TYPE(index)</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define EZ_GENERIC_TYPE(index)                               __covariant EZ_CHARS_AT(index): id

#define EZ_CHARS_AT(N)  EZ_ARG_AT(N, EZ_CHARS)

#define EZ_CHARS    A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S, T, U, V, W, X, Y, Z
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><code>EZ_CHARS_AT(N)</code>的作用是从<code>EZ_CHARS</code>取出第 N 位的字符，因此<code>EZ_GENERIC_TYPE(0)</code>会被展开为<code>__covariant A: id</code>，<code>EZ_GENERIC_TYPE(1)</code>会被展开为<code>__covariant B: id</code>，</p> <p>所以</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_FOR_COMMA(i, EZ_GENERIC_TYPE)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被展开为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>__covariant A: id, __covariant B: id
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>__covariant</code>这个关键字表示协变性，即子类型可以强转到父类型，是Objective-C 新出现的一个用来表达泛型能力的关键字，与它一同出现的另一个关键字是<code>____contravariant</code>，表示逆变性，即父类型可以强转到子类型。对这两个关键字的更详细介绍，可以看一下 sunnyxx 老师的博文<a href="https://blog.sunnyxx.com/2015/06/12/objc-new-features-in-2015/" target="_blank" rel="noopener noreferrer">《2015 Objective-C 新特性》<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>回到类的接口定义，根据上面的分析，</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@interface EZ_CONCAT(EZTuple, i)&lt;EZ_FOR_COMMA(i, EZ_GENERIC_TYPE)&gt; :EZTupleBase
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被展开为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@interface EZTuple2&lt;__covariant A: id, __covariant B: id)&gt; :EZTupleBase
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="ez-for-recursive"><a href="#ez-for-recursive" class="header-anchor">#</a> EZ_FOR_RECURSIVE</h3> <p>这个宏被用于类定义的第二部分，即类的属性的生成中。它的定义和<code>EZ_FOR</code>也是类似的：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define EZ_FOR_RECURSIVE(COUNT, MARCO, SEP)                  EZ_CONCAT(EZ_FOR_RECURSIVE, COUNT)(MARCO, SEP)
#define EZ_FOR_RECURSIVE0(MARCO, SEP)
#define EZ_FOR_RECURSIVE1(MARCO, SEP)                        MARCO(0)
#define EZ_FOR_RECURSIVE2(MARCO, SEP)                        EZ_FOR_RECURSIVE1(MARCO, SEP) SEP MARCO(1)
#define EZ_FOR_RECURSIVE3(MARCO, SEP)                        EZ_FOR_RECURSIVE2(MARCO, SEP) SEP MARCO(2)
#define EZ_FOR_RECURSIVE4(MARCO, SEP)                        EZ_FOR_RECURSIVE3(MARCO, SEP) SEP MARCO(3)
#define EZ_FOR_RECURSIVE5(MARCO, SEP)                        EZ_FOR_RECURSIVE4(MARCO, SEP) SEP MARCO(4)
// 中间定义都是类似的，为了节省篇幅就不列出了
#define EZ_FOR_RECURSIVE19(MARCO, SEP)                       EZ_FOR_RECURSIVE18(MARCO, SEP) SEP MARCO(18)
#define EZ_FOR_RECURSIVE20(MARCO, SEP)                       EZ_FOR_RECURSIVE19(MARCO, SEP) SEP MARCO(19)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>所以</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_FOR_RECURSIVE(2, EZ_PROPERTY_DEF, ;)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>就会被展开为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_PROPERTY_DEF(0) ; EZ_PROPERTY_DEF(1)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="ez-property-def-index"><a href="#ez-property-def-index" class="header-anchor">#</a> EZ_PROPERTY_DEF(index)</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define EZ_PROPERTY_DEF(index)  @property (nonatomic, strong) EZ_CHARS_AT(index) EZ_ORDINAL_AT(index)

#define EZ_ORDINAL_NUMBERS  first, second, third, fourth, fifth, sixth, seventh, eighth, ninth, tenth, eleventh, twelfth, thirteenth, fourteenth, fifteenth, sixteenth, seventeenth, eighteenth, nineteenth, twentieth

#define EZ_ORDINAL_AT(N)    EZ_ARG_AT(N, EZ_ORDINAL_NUMBERS)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>所以</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_FOR_RECURSIVE(2, EZ_PROPERTY_DEF, ;)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>首先被展开为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_PROPERTY_DEF(0) ; EZ_PROPERTY_DEF(1)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>进而被展开为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@property (nonatomic, strong) A first;
@property (nonatomic, strong) B second;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="ez-for-space"><a href="#ez-for-space" class="header-anchor">#</a> EZ_FOR_SPACE</h3> <p>这个宏的名字和<code>EZ_FOR_COMMA</code>类似，定义也类似，因此它的作用也是类似的，这里就不浪费篇幅了。<code>EZ_FOR_SPACE(2, EZ_INIT_PARAM)</code>会被展开为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_INIT_PARAM(0) EZ_INIT_PARAM(1)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这里我们也只看一下<code>EZ_INIT_PARAM(0)</code>是如何展开的，<code>EZ_INIT_PARAM(1)</code>的展开和它是类似的。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define _EZ_INIT_PARAM_FIRST(index)                          EZ_ORDINAL_CAP_AT(index):(EZ_CHARS_AT(index))EZ_ORDINAL_AT(index)
#define _EZ_INIT_PARAM(index)                                EZ_ORDINAL_AT(index):(EZ_CHARS_AT(index))EZ_ORDINAL_AT(index)
#define EZ_INIT_PARAM(index)                                 EZ_IF_EQ(0, index)(_EZ_INIT_PARAM_FIRST(index))(_EZ_INIT_PARAM(index))
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>EZ_INIT_PARAM(0)</code>首先被展开为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_IF_EQ(0,0)(_EZ_INIT_PARAM_FIRST(0))(_EZ_INIT_PARAM(0))
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>_EZ_INIT_PARAM_FIRST(0)</code>会被展开为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>First:(A)first
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>而<code>_EZ_INIT_PARAM(0)</code>会被展开为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>first:(A)first
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>所以</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_IF_EQ(0,0)(_EZ_INIT_PARAM_FIRST(0))(_EZ_INIT_PARAM(0))
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>也就是</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_IF_EQ(0,0)(First:(A)first)(first:(A)first)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>EZ_IF_EQ(0,0)</code>也就是<code>EZ_IF_EQ0(0)</code>，也就是<code>EZ_IF_EQ0_0</code>，
根据</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define EZ_IF_EQ0_0(...)                                     __VA_ARGS__ EZ_CONSUME_
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>EZ_IF_EQ(0,0)(First:(A)first)(first:(A)first)</code>就是</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>First:(A)first EZ_CONSUME_(first:(A)first)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>最终就是<code>First:(A)first</code>。即<code>EZ_INIT_PARAM(0)</code>最终展开的结果就是<code>First:(A)first</code>。同理，<code>EZ_INIT_PARAM(1)</code>最终展开的结果就是<code>Second:(B)second</code>。
因此，</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>- (instancetype)EZ_CONCAT(initWith, EZ_FOR_SPACE(i, EZ_INIT_PARAM));   
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>展开后的结果就是</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>- (instancetype)initWithFirst:(A)first Second:(B)second;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>回到一开始的类定义</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define EZ_TUPLE_DEF(i)                                                                                                         \
@interface EZ_CONCAT(EZTuple, i)&lt;EZ_FOR_COMMA(i, EZ_GENERIC_TYPE)&gt; :EZTupleBase                                                     \
                                                                                                                               \
EZ_FOR_RECURSIVE(i, EZ_PROPERTY_DEF, ;);                                                                                         \
                                                                                                                               \
@property (nonatomic, strong) EZ_CHARS_AT(EZ_DEC(i)) last;                                                                       \
                                                                                                                               \
- (instancetype)EZ_CONCAT(initWith, EZ_FOR_SPACE(i, EZ_INIT_PARAM));                                                              \
                                                                                                                               \
@end
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>当 i = 2的时候，上面这段宏就会被展开为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@interface EZTuple2&lt;__covariant A: id, __covariant B: id)&gt; :EZTupleBase

@property (nonatomic, strong) A first;
@property (nonatomic, strong) B second;
@property (nonatomic, strong) B last;

- (instancetype)initWithFirst:(A)first Second:(B)second;

@end
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>我们在前面分析过，<code>EZ_TUPLE_CLASSES_DEF</code>会被展开为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>EZ_TUPLE_DEF(1) ; EZ_TUPLE_DEF(2) ; ... EZ_TUPLE_DEF(18) ; EZ_TUPLE_DEF(19) ; EZ_TUPLE_DEF(20)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>所以在预编译时，这些宏就会被展开成<code>EZTuple1</code>、<code>EZTuple2</code>……<code>EZTuple20</code>等类的定义。也就是说，<code>EasyTuple</code>通过这个宏为我们一口气定义了20个元祖类。这样的好处是显而易见的：如果不使用宏的话，那么为了创建这么多个类，我们就要手动去书写很多重复的代码；而使用宏的话，则能够通过宏的巧妙组合在预编译的时候自动生成代码。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>宏是一门非常非常强大的技术，但是之前我一直不知道它有这么多高级的玩法和用法，看了<code>EasyTuple</code>的源代码，真是让人大开眼界。其实<code>EasyTuple</code>中还有一些上文中没有提到的宏的用法，限于篇幅这里就不一一展开分析了，不过万变不离其宗，只需要像剥洋葱一样一层一层地进行定义的替换，再加一点点耐心和细心，那么再复杂的宏也不在话下。</p> <h2 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料：</h2> <ol><li><a href="https://halfrost.com/reactivecocoa_macro/" target="_blank" rel="noopener noreferrer">ReactiveCocoa 中奇妙无比的“宏”魔法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://blog.sunnyxx.com/2014/03/06/rac_1_macros/" target="_blank" rel="noopener noreferrer">Reactive Cocoa Tutorial [1] = 神奇的Macros<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol></div> <!----> <div class="content__content-bottom"></div> <footer class="page-meta"><div class="edit-link"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon edit-icon"><path d="M117.953 696.992 64.306 959.696l265.931-49.336 450.204-452.505-212.284-213.376-450.204 452.513zm496.384-296.326L219.039 797.993l-46.108-46.34L568.233 354.33l46.104 46.335zm345.357-122.99-114.45 115.04-212.288-213.377 114.45-115.035 212.288 213.371zm0 0" fill="currentColor"></path></svg> <a href="https://github.com/tamarous/blog/edit/master/docs/iOS/easytuple_source_probe.md" target="_blank" rel="noopener noreferrer">Edit this page</a></div> <div class="meta-item update-time"><span class="label">Last update:</span> <span class="info">February 24, 2024 15:04</span></div> <!----></footer> <!----> <!----> <!----> <div class="content__page-bottom"></div></main> <!----></div><div class="global-ui"><!----><!----><div id="pwa-install"><!----> <div id="install-modal-wrapper" style="display:none;"><div class="background"></div> <div class="install-modal"><div class="header"><button aria-label="Close" class="close-button"><svg width="23" height="22" xmlns="http://www.w3.org/2000/svg" class="icon close-icon"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.12.358a1.224 1.224 0 011.729 0l8.92 8.914L20.686.358a1.224 1.224 0 011.73 1.728L13.497 11l8.92 8.913a1.222 1.222 0 11-1.73 1.729l-8.919-8.913-8.92 8.913a1.224 1.224 0 01-1.729-1.729L10.04 11l-8.92-8.914a1.222 1.222 0 010-1.728z" fill="currentColor"></path></svg></button> <div class="logo"><!----> <div class="title"><h1></h1> <p class="desc">This app can be installed on your PC or mobile device.  This will allow this web app to look and behave like any other installed app.  You will find it in your app lists and be able to pin it to your home screen, start menus or task bars.  This installed web app will also be able to safely interact with other apps and your operating system. </p></div></div></div> <div class="content"><div class="highlight"><!----> <!----></div> <div class="description"><h3>Description</h3> <p></p></div></div> <div class="button-wrapper"><button class="install-button">
        Install <span></span></button> <button class="cancel-button">
        Cancel
      </button></div></div></div></div><div tabindex="-1" role="dialog" aria-hidden="true" class="pswp"><div class="pswp__bg"></div> <div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div></div> <div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button class="pswp__button pswp__button--close"></button> <button class="pswp__button pswp__button--share"></button> <button class="pswp__button pswp__button--fs"></button> <button class="pswp__button pswp__button--zoom"></button> <div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button class="pswp__button pswp__button--arrow--left"></button> <button class="pswp__button pswp__button--arrow--right"></button> <div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div></div></div>
    <script src="/blog/assets/js/app.a5fc5e5c.js" defer></script><script src="/blog/assets/js/vendors~layout-Layout.7e998ec2.js" defer></script><script src="/blog/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.4f318220.js" defer></script><script src="/blog/assets/js/page-EasyTuple源代码分析.2cf181b1.js" defer></script><script src="/blog/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.335ce4c4.js" defer></script>
  </body>
</html>
