<!doctype html>
<html lang="en-US" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.20" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.73" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <title>Aspects 源码分析 | Tamarous' blog</title><meta name="description" content="">
    <link rel="stylesheet" href="/blog/assets/css/styles.2f3457ba.css">
    <link rel="preload" href="/blog/assets/js/runtime~app.0e81bbbf.js" as="script"><link rel="preload" href="/blog/assets/css/styles.2f3457ba.css" as="style"><link rel="preload" href="/blog/assets/js/9826.a28e70bc.js" as="script"><link rel="preload" href="/blog/assets/js/app.45e041b4.js" as="script">
    <link rel="prefetch" href="/blog/assets/js/4543.db21e138.js" as="script"><link rel="prefetch" href="/blog/assets/js/3867.135c07f4.js" as="script"><link rel="prefetch" href="/blog/assets/js/5642.d4e3079d.js" as="script"><link rel="prefetch" href="/blog/assets/js/9684.36c9dfd9.js" as="script"><link rel="prefetch" href="/blog/assets/js/iOS_kscrash_monitor.html.29d2661d.js" as="script"><link rel="prefetch" href="/blog/assets/js/6258.299cacea.js" as="script"><link rel="prefetch" href="/blog/assets/js/Backend_golang_newbee_getting_better.html.8696e0b2.js" as="script"><link rel="prefetch" href="/blog/assets/js/5859.782de9c0.js" as="script"><link rel="prefetch" href="/blog/assets/js/4552.3421d4af.js" as="script"><link rel="prefetch" href="/blog/assets/js/iOS_easytuple_source_probe.html.49eee5fd.js" as="script"><link rel="prefetch" href="/blog/assets/js/5805.abe477a8.js" as="script"><link rel="prefetch" href="/blog/assets/js/1890.399757fe.js" as="script"><link rel="prefetch" href="/blog/assets/js/iOS_aspects_source_probe.html.aff637ee.js" as="script"><link rel="prefetch" href="/blog/assets/js/8300.db4e9dba.js" as="script"><link rel="prefetch" href="/blog/assets/js/iOS_sdwebimage_cache.html.3d87419c.js" as="script"><link rel="prefetch" href="/blog/assets/js/9497.685f33e6.js" as="script"><link rel="prefetch" href="/blog/assets/js/iOS_stinger_source_probe.html.43af33d5.js" as="script"><link rel="prefetch" href="/blog/assets/js/iOS_ios_exception_handling.html.85731177.js" as="script"><link rel="prefetch" href="/blog/assets/js/866.877af9b5.js" as="script"><link rel="prefetch" href="/blog/assets/js/8112.3e8a2e5b.js" as="script"><link rel="prefetch" href="/blog/assets/js/1700.c3ca9790.js" as="script"><link rel="prefetch" href="/blog/assets/js/7601.7053345b.js" as="script"><link rel="prefetch" href="/blog/assets/js/5118.7a025bf9.js" as="script"><link rel="prefetch" href="/blog/assets/js/6850.da3de4d6.js" as="script"><link rel="prefetch" href="/blog/assets/js/9605.050537c5.js" as="script"><link rel="prefetch" href="/blog/assets/js/Backend_gopool.html.f06c7e6b.js" as="script"><link rel="prefetch" href="/blog/assets/js/6675.7c532e0e.js" as="script"><link rel="prefetch" href="/blog/assets/js/6772.fc35ef33.js" as="script"><link rel="prefetch" href="/blog/assets/js/5153.15bfe516.js" as="script"><link rel="prefetch" href="/blog/assets/js/8605.edb3efbf.js" as="script"><link rel="prefetch" href="/blog/assets/js/iOS_dyld_shared_cache.html.f06d2114.js" as="script"><link rel="prefetch" href="/blog/assets/js/iOS_masonry_source_probe.html.1d218a2e.js" as="script"><link rel="prefetch" href="/blog/assets/js/2277.737f1127.js" as="script"><link rel="prefetch" href="/blog/assets/js/48.ec8dd276.js" as="script"><link rel="prefetch" href="/blog/assets/js/3668.aeb97ab9.js" as="script"><link rel="prefetch" href="/blog/assets/js/1454.bc727b68.js" as="script"><link rel="prefetch" href="/blog/assets/js/6934.9efad61f.js" as="script"><link rel="prefetch" href="/blog/assets/js/2909.f8e7de24.js" as="script"><link rel="prefetch" href="/blog/assets/js/1587.4e965713.js" as="script"><link rel="prefetch" href="/blog/assets/js/iOS_index.html.d9f22b76.js" as="script"><link rel="prefetch" href="/blog/assets/js/Backend_index.html.5dcff062.js" as="script"><link rel="prefetch" href="/blog/assets/js/index.html.c33f3cfd.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_基础知识_index.html.4bd538e5.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_技术原理_index.html.8573cecf.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_源码分析_index.html.6271cb07.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_稳定性_index.html.48ff18b3.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_backend_index.html.32a96c29.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_ios_index.html.a64fc2cc.js" as="script"><link rel="prefetch" href="/blog/assets/js/3092.e0fe3b9a.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_index.html.8f678229.js" as="script"><link rel="prefetch" href="/blog/assets/js/timeline_index.html.187973aa.js" as="script"><link rel="prefetch" href="/blog/assets/js/article_index.html.708ae602.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_index.html.195946eb.js" as="script"><link rel="prefetch" href="/blog/assets/js/star_index.html.9229234c.js" as="script"><link rel="prefetch" href="/blog/assets/js/404.html.956448a4.js" as="script"><link rel="prefetch" href="/blog/assets/js/8088.ee029265.js" as="script"><link rel="prefetch" href="/blog/assets/js/1250.a8a06209.js" as="script"><link rel="prefetch" href="/blog/assets/js/5284.e7a0004f.js" as="script"><link rel="prefetch" href="/blog/assets/js/7322.e2e32153.js" as="script"><link rel="prefetch" href="/blog/assets/js/5720.8a9f600f.js" as="script"><link rel="prefetch" href="/blog/assets/js/834.92828c75.js" as="script"><link rel="prefetch" href="/blog/assets/js/1439.2a99a211.js" as="script"><link rel="prefetch" href="/blog/assets/js/6817.5a343664.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">Skip to main content</a><!--]--><!--[--><div class="theme-container external-link-icon has-toc" vp-container><!--[--><header id="navbar" class="vp-navbar" vp-navbar><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><a class="route-link vp-brand" href="/blog/" aria-label="Take me home"><!----><!----><span class="vp-site-name">Tamarous&#39; blog</span></a><!--]--></div><div class="vp-navbar-center"><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/blog/" aria-label="Home" iconsizing="height"><!---->Home<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link route-link-active auto-link" href="/blog/iOS/" aria-label="iOS" iconsizing="height"><!---->iOS<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/blog/Backend/" aria-label="Backend" iconsizing="height"><!---->Backend<!----></a></div></nav><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!----><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-color-mode-switch" id="color-mode-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" name="auto" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" name="dark" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" name="light" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/blog/" aria-label="/" iconsizing="both"><!---->/<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">iOS 知识总结</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/blog/iOS/" aria-label="iOS 知识总结" iconsizing="both"><!---->iOS 知识总结<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/blog/iOS/aspects_source_probe.html" aria-label="Aspects 源码分析" iconsizing="both"><!---->Aspects 源码分析<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/blog/iOS/easytuple_source_probe.html" aria-label="EasyTuple 源代码分析" iconsizing="both"><!---->EasyTuple 源代码分析<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/blog/iOS/ios_exception_handling.html" aria-label="iOS 异常捕获原理" iconsizing="both"><!---->iOS 异常捕获原理<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/blog/iOS/kscrash_monitor.html" aria-label="KSCrash 实现原理 - 监控系统实现" iconsizing="both"><!---->KSCrash 实现原理 - 监控系统实现<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/blog/iOS/masonry_source_probe.html" aria-label="Masonry 源代码剖析" iconsizing="both"><!---->Masonry 源代码剖析<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/blog/iOS/sdwebimage_cache.html" aria-label="SDWebImage 源代码剖析-缓存策略" iconsizing="both"><!---->SDWebImage 源代码剖析-缓存策略<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/blog/iOS/stinger_source_probe.html" aria-label="Stinger 源码分析" iconsizing="both"><!---->Stinger 源码分析<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/blog/iOS/dyld_shared_cache.html" aria-label="如何分析 iOS 系统库的实现" iconsizing="both"><!---->如何分析 iOS 系统库的实现<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">后端精进之路</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->Aspects 源码分析</h1><!----><hr></div><!----><!----><div class="theme-hope-content" vp-content><h1 id="aspects-源码分析" tabindex="-1"><a class="header-anchor" href="#aspects-源码分析"><span>Aspects 源码分析</span></a></h1><p><a href="https://github.com/steipete/Aspects" target="_blank" rel="noopener noreferrer">Aspects</a>是一个非常知名的用于 AOP 的 Objective-C 库，可以对类方法或者实例方法进行 Hook，虽然它的作者不推荐在生产环境下使用这个组件，但是了解 Aspects 的原理，对于我们更好地掌握 Objective-C 这门语言还是很有好处的，因此本文就来简要地分析下 Aspects 的实现细节。</p><h2 id="nsobject-分类" tabindex="-1"><a class="header-anchor" href="#nsobject-分类"><span>NSObject 分类</span></a></h2><p>这个库里的代码不多，只有 <code>Aspects.h</code> 和 <code>Aspects.m</code> 两个文件。头文件里定义了一个 NSObject 的分类，给所有 NSObject 的子类添加了两个方法，分别用于对类方法和对类实例方法进行 Hook:</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>+ (id&lt;AspectToken&gt;)aspect_hookSelector:(SEL)selector</span></span>
<span class="line"><span>                           withOptions:(AspectOptions)options</span></span>
<span class="line"><span>                            usingBlock:(id)block</span></span>
<span class="line"><span>                                 error:(NSError **)error;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>- (id&lt;AspectToken&gt;)aspect_hookSelector:(SEL)selector</span></span>
<span class="line"><span>                           withOptions:(AspectOptions)options</span></span>
<span class="line"><span>                            usingBlock:(id)block</span></span>
<span class="line"><span>                                 error:(NSError **)error;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>options 指定了 AOP 切面执行的时机：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>typedef NS_OPTIONS(NSUInteger, AspectOptions) {</span></span>
<span class="line"><span>    AspectPositionAfter   = 0,            /// 在原始方法执行后生效（默认）        </span></span>
<span class="line"><span>    AspectPositionInstead = 1,            /// 替换原始方法</span></span>
<span class="line"><span>    AspectPositionBefore  = 2,            /// 在原始方法执行前生效</span></span>
<span class="line"><span>    AspectOptionAutomaticRemoval = 1 &lt;&lt; 3 /// 只执行一次</span></span>
<span class="line"><span>};</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>进入</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>- (id&lt;AspectToken&gt;)aspect_hookSelector:(SEL)selector</span></span>
<span class="line"><span>                      withOptions:(AspectOptions)options</span></span>
<span class="line"><span>                       usingBlock:(id)block</span></span>
<span class="line"><span>                            error:(NSError **)error {</span></span>
<span class="line"><span>    return aspect_add(self, selector, options, block, error);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>它调用了 <code>aspect_add</code> 这个静态函数：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>static id aspect_add(id self, SEL selector, AspectOptions options, id block, NSError **error) {</span></span>
<span class="line"><span>    NSCParameterAssert(self);</span></span>
<span class="line"><span>    NSCParameterAssert(selector);</span></span>
<span class="line"><span>    NSCParameterAssert(block);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    __block AspectIdentifier *identifier = nil;</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    // 1.</span></span>
<span class="line"><span>    aspect_performLocked(^{</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>        // 2. </span></span>
<span class="line"><span>        if (aspect_isSelectorAllowedAndTrack(self, selector, options, error)) {</span></span>
<span class="line"><span>            // 3</span></span>
<span class="line"><span>            AspectsContainer *aspectContainer = aspect_getContainerForObject(self, selector);</span></span>
<span class="line"><span>            // 4. </span></span>
<span class="line"><span>            identifier = [AspectIdentifier identifierWithSelector:selector object:self options:options block:block error:error];</span></span>
<span class="line"><span>            if (identifier) {</span></span>
<span class="line"><span>                // 5. </span></span>
<span class="line"><span>                [aspectContainer addAspect:identifier withOptions:options];</span></span>
<span class="line"><span></span></span>
<span class="line"><span>                // 6.  </span></span>
<span class="line"><span>                // Modify the class to allow message interception.</span></span>
<span class="line"><span>                aspect_prepareClassAndHookSelector(self, selector, error);</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    });</span></span>
<span class="line"><span>    return identifier;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="aspect-performlocked" tabindex="-1"><a class="header-anchor" href="#aspect-performlocked"><span>aspect_performLocked</span></a></h2><p><code>aspect_performLocked</code> 这个方法在执行作为参数的 block 前会进行加锁操作，而在 block 执行完后进行解锁：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>static void aspect_performLocked(dispatch_block_t block) {</span></span>
<span class="line"><span>    static OSSpinLock aspect_lock = OS_SPINLOCK_INIT;</span></span>
<span class="line"><span>    OSSpinLockLock(&amp;aspect_lock);</span></span>
<span class="line"><span>    block();</span></span>
<span class="line"><span>    OSSpinLockUnlock(&amp;aspect_lock);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="aspect-isselectorallowedandtrack" tabindex="-1"><a class="header-anchor" href="#aspect-isselectorallowedandtrack"><span>aspect_isSelectorAllowedAndTrack</span></a></h2><p>调用 <code>aspect_isSelectorAllowedAndTrack(self, selector, options, error)</code> 这个方法：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>static BOOL aspect_isSelectorAllowedAndTrack(NSObject *self, SEL selector, AspectOptions options, NSError **error) {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // `retain`，`release`，`autorelease`和`forwardInvocation`都是不允许被 hook ，它们会被加入黑名单中</span></span>
<span class="line"><span>    static NSSet *disallowedSelectorList;</span></span>
<span class="line"><span>    static dispatch_once_t pred;</span></span>
<span class="line"><span>    dispatch_once(&amp;pred, ^{</span></span>
<span class="line"><span>        disallowedSelectorList = [NSSet setWithObjects:@&quot;retain&quot;, @&quot;release&quot;, @&quot;autorelease&quot;, @&quot;forwardInvocation:&quot;, nil];</span></span>
<span class="line"><span>    });</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // 如果要 Hook 的方法是以上黑名单中的四个方法中的一个，会打印出错误信息并且返回 NO</span></span>
<span class="line"><span>    NSString *selectorName = NSStringFromSelector(selector);</span></span>
<span class="line"><span>    if ([disallowedSelectorList containsObject:selectorName]) {</span></span>
<span class="line"><span>        NSString *errorDescription = [NSString stringWithFormat:@&quot;Selector %@ is blacklisted.&quot;, selectorName];</span></span>
<span class="line"><span>        AspectError(AspectErrorSelectorBlacklisted, errorDescription);</span></span>
<span class="line"><span>        return NO;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // 如果 Hook 的是 dealloc 方法，并且 Hook 时机不是在 dealloc 方法执行之前，也会打印出错误信息，并且返回 NO</span></span>
<span class="line"><span>    AspectOptions position = options&amp;AspectPositionFilter;</span></span>
<span class="line"><span>    if ([selectorName isEqualToString:@&quot;dealloc&quot;] &amp;&amp; position != AspectPositionBefore) {</span></span>
<span class="line"><span>        NSString *errorDesc = @&quot;AspectPositionBefore is the only valid position when hooking dealloc.&quot;;</span></span>
<span class="line"><span>        AspectError(AspectErrorSelectorDeallocPosition, errorDesc);</span></span>
<span class="line"><span>        return NO;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span> </span></span>
<span class="line"><span> // 如果被 Hook 的类本身不能响应被 Hook 的方法，那么这里也会报错并且返回 NO</span></span>
<span class="line"><span>    if (![self respondsToSelector:selector] &amp;&amp; ![self.class instancesRespondToSelector:selector]) {</span></span>
<span class="line"><span>        NSString *errorDesc = [NSString stringWithFormat:@&quot;Unable to find selector -[%@ %@].&quot;, NSStringFromClass(self.class), selectorName];</span></span>
<span class="line"><span>        AspectError(AspectErrorDoesNotRespondToSelector, errorDesc);</span></span>
<span class="line"><span>        return NO;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // Search for the current class and the class hierarchy IF we are modifying a class object</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    if (class_isMetaClass(object_getClass(self))) {</span></span>
<span class="line"><span>        // 如果 self 所属的类是一个元类</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>        Class klass = [self class];</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        // aspect_getSwizzledClassesDict会返回一个全局唯一的`swizzledClassesDict`，以 Class 为键，以`AspectTracker`实例为值，下文中会介绍这个 dictionary 内的键值对是怎么添加的</span></span>
<span class="line"><span>        NSMutableDictionary *swizzledClassesDict = aspect_getSwizzledClassesDict();</span></span>
<span class="line"><span>        Class currentClass = [self class];</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        AspectTracker *tracker = swizzledClassesDict[currentClass];</span></span>
<span class="line"><span>        if ([tracker subclassHasHookedSelectorName:selectorName]) {</span></span>
<span class="line"><span>            // 如果self 所属类的子类已经 Hook 了 selectorName 代表的 SEL，那么在这里就会打印出错误信息并且返回 NO</span></span>
<span class="line"><span>            NSSet *subclassTracker = [tracker subclassTrackersHookingSelectorName:selectorName];</span></span>
<span class="line"><span>            NSSet *subclassNames = [subclassTracker valueForKey:@&quot;trackedClassName&quot;];</span></span>
<span class="line"><span>            NSString *errorDescription = [NSString stringWithFormat:@&quot;Error: %@ already hooked subclasses: %@. A method can only be hooked once per class hierarchy.&quot;, selectorName, subclassNames];</span></span>
<span class="line"><span>            AspectError(AspectErrorSelectorAlreadyHookedInClassHierarchy, errorDescription);</span></span>
<span class="line"><span>            return NO;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // 从 self 所属类的继承链上进行查找</span></span>
<span class="line"><span>        do {</span></span>
<span class="line"><span>            tracker = swizzledClassesDict[currentClass];</span></span>
<span class="line"><span>            // 如果继承链上的某个类的被交换的方法列表中有当前这个 SEL</span></span>
<span class="line"><span>            if ([tracker.selectorNames containsObject:selectorName]) {</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>                // 继承链上的这个类就是被 Hook 的那个类，说明之前已经 Hook 过它了，因此这里直接返回 YES</span></span>
<span class="line"><span>                if (klass == currentClass) {</span></span>
<span class="line"><span>                    // Already modified and topmost!</span></span>
<span class="line"><span>                    return YES;</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                // 继承链上的这个类不是被 Hook 的那个类，而是它的父类，那么这个方法已经被 Hook 过了，我们就不能再次进行 Hook 了，所以这里需要打印出一条错误信息，并且返回 NO</span></span>
<span class="line"><span>                NSString *errorDescription = [NSString stringWithFormat:@&quot;Error: %@ already hooked in %@. A method can only be hooked once per class hierarchy.&quot;, selectorName, NSStringFromClass(currentClass)];</span></span>
<span class="line"><span>                AspectError(AspectErrorSelectorAlreadyHookedInClassHierarchy, errorDescription);</span></span>
<span class="line"><span>                return NO;</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        } while ((currentClass = class_getSuperclass(currentClass)));</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // Add the selector as being modified.</span></span>
<span class="line"><span>        currentClass = klass;</span></span>
<span class="line"><span>        AspectTracker *subclassTracker = nil;</span></span>
<span class="line"><span>        do {</span></span>
<span class="line"><span>            tracker = swizzledClassesDict[currentClass];</span></span>
<span class="line"><span>            if (!tracker) {</span></span>
<span class="line"><span>                // 为 self 所属的这个类创建对应的 AspectTracker</span></span>
<span class="line"><span>                tracker = [[AspectTracker alloc] initWithTrackedClass:currentClass];</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                // 以 self 所属的类为键，以tracker 为值，添加到swizzledClassesDict中</span></span>
<span class="line"><span>                swizzledClassesDict[(id&lt;NSCopying&gt;)currentClass] = tracker;</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>            if (subclassTracker) {</span></span>
<span class="line"><span>                [tracker addSubclassTracker:subclassTracker hookingSelectorName:selectorName];</span></span>
<span class="line"><span>            } else {</span></span>
<span class="line"><span>                [tracker.selectorNames addObject:selectorName];</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            // All superclasses get marked as having a subclass that is modified.</span></span>
<span class="line"><span>            subclassTracker = tracker;</span></span>
<span class="line"><span>        }while ((currentClass = class_getSuperclass(currentClass)));</span></span>
<span class="line"><span>	} else {</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	   // 如果 self 所属的类不是元类，那么直接返回 YES</span></span>
<span class="line"><span>		return YES;</span></span>
<span class="line"><span>	}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return YES;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="aspect-getcontainerforobject" tabindex="-1"><a class="header-anchor" href="#aspect-getcontainerforobject"><span>aspect_getContainerForObject</span></a></h2><p>以 self 和 selector 为参数，调用 <code>aspect_getContainerForObject</code> 函数，创建并返回一个 <code>AspectsContainer</code>：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>AspectsContainer *aspectContainer = aspect_getContainerForObject(self, selector);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>static AspectsContainer *aspect_getContainerForObject(NSObject *self, SEL selector) {</span></span>
<span class="line"><span>    NSCParameterAssert(self);</span></span>
<span class="line"><span>    SEL aliasSelector = aspect_aliasForSelector(selector);</span></span>
<span class="line"><span>    AspectsContainer *aspectContainer = objc_getAssociatedObject(self, aliasSelector);</span></span>
<span class="line"><span>    if (!aspectContainer) {</span></span>
<span class="line"><span>        aspectContainer = [AspectsContainer new];</span></span>
<span class="line"><span>        objc_setAssociatedObject(self, aliasSelector, aspectContainer, OBJC_ASSOCIATION_RETAIN);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    return aspectContainer;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>AspectsContainer</code> 和 selector 是通过关联对象关联在一起的，因此这个方法里就是通过 selector 取出对应的 <code>AspectsContainer</code> 实例。</p><h2 id="identifierwithselector-object-options-block-error" tabindex="-1"><a class="header-anchor" href="#identifierwithselector-object-options-block-error"><span>identifierWithSelector:object:options:block:error:</span></a></h2><p>创建出一个 <code>AspectsIdentifier</code> 实例：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>+ (instancetype)identifierWithSelector:(SEL)selector object:(id)object options:(AspectOptions)options block:(id)block error:(NSError **)error {</span></span>
<span class="line"><span>    NSCParameterAssert(block);</span></span>
<span class="line"><span>    NSCParameterAssert(selector);</span></span>
<span class="line"><span>    NSMethodSignature *blockSignature = aspect_blockMethodSignature(block, error); // TODO: check signature compatibility, etc.</span></span>
<span class="line"><span>    if (!aspect_isCompatibleBlockSignature(blockSignature, object, selector, error)) {</span></span>
<span class="line"><span>        return nil;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    AspectIdentifier *identifier = nil;</span></span>
<span class="line"><span>    if (blockSignature) {</span></span>
<span class="line"><span>        identifier = [AspectIdentifier new];</span></span>
<span class="line"><span>        identifier.selector = selector;</span></span>
<span class="line"><span>        identifier.block = block;</span></span>
<span class="line"><span>        identifier.blockSignature = blockSignature;</span></span>
<span class="line"><span>        identifier.options = options;</span></span>
<span class="line"><span>        identifier.object = object; // weak</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    return identifier;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="addaspect-withoptions" tabindex="-1"><a class="header-anchor" href="#addaspect-withoptions"><span>addAspect:withOptions:</span></a></h2><p>将上一步中创建的 <code>AspectIdentifier</code> 实例添加到第3步创建的 <code>AspectsContainer</code> 中：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>- (void)addAspect:(AspectIdentifier *)aspect withOptions:(AspectOptions)options {</span></span>
<span class="line"><span>    NSParameterAssert(aspect);</span></span>
<span class="line"><span>    NSUInteger position = options&amp;AspectPositionFilter;</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    // 根据options的设置，AspectIdentifier实例会被添加到AspectsContainer对应的数组里</span></span>
<span class="line"><span>    switch (position) {</span></span>
<span class="line"><span>        case AspectPositionBefore:  self.beforeAspects  = [(self.beforeAspects ?:@[]) arrayByAddingObject:aspect]; break;</span></span>
<span class="line"><span>        case AspectPositionInstead: self.insteadAspects = [(self.insteadAspects?:@[]) arrayByAddingObject:aspect]; break;</span></span>
<span class="line"><span>        case AspectPositionAfter:   self.afterAspects   = [(self.afterAspects  ?:@[]) arrayByAddingObject:aspect]; break;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="aspect-prepareclassandhookselector" tabindex="-1"><a class="header-anchor" href="#aspect-prepareclassandhookselector"><span>aspect_prepareClassAndHookSelector</span></a></h2><p>第6步是整个方法 Hook 的核心：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>static void aspect_prepareClassAndHookSelector(NSObject *self, SEL selector, NSError **error) {</span></span>
<span class="line"><span>    NSCParameterAssert(selector);</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    // 6-1 </span></span>
<span class="line"><span>    Class klass = aspect_hookClass(self, error);</span></span>
<span class="line"><span>    Method targetMethod = class_getInstanceMethod(klass, selector);</span></span>
<span class="line"><span>    IMP targetMethodIMP = method_getImplementation(targetMethod);</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    // 6-2 </span></span>
<span class="line"><span>    if (!aspect_isMsgForwardIMP(targetMethodIMP)) {</span></span>
<span class="line"><span>        // Make a method alias for the existing method implementation, it not already copied.</span></span>
<span class="line"><span>        const char *typeEncoding = method_getTypeEncoding(targetMethod);</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        // 6-3 </span></span>
<span class="line"><span>        SEL aliasSelector = aspect_aliasForSelector(selector);</span></span>
<span class="line"><span>        if (![klass instancesRespondToSelector:aliasSelector]) {</span></span>
<span class="line"><span>            // 如果第6-1步中创建出来的类不能响应第6-3步中新创建的 SEL，那么就通过class_addMethod 来给新创建出来的类添加一个方法，这个方法的 SEL 就是新创建的 SEL，IMP 和类型编码则是要被替换的方法的 IMP 和类型编码</span></span>
<span class="line"><span>            __unused BOOL addedAlias = class_addMethod(klass, aliasSelector, method_getImplementation(targetMethod), typeEncoding);</span></span>
<span class="line"><span>            NSCAssert(addedAlias, @&quot;Original implementation for %@ is already copied to %@ on %@&quot;, NSStringFromSelector(selector), NSStringFromSelector(aliasSelector), klass);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // 6-4 </span></span>
<span class="line"><span>        class_replaceMethod(klass, selector, aspect_getMsgForwardIMP(self, selector), typeEncoding);</span></span>
<span class="line"><span>        AspectLog(@&quot;Aspects: Installed hook for -[%@ %@].&quot;, klass, NSStringFromSelector(selector));</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个方法也比较复杂，因此我们将它分成四个小步骤来分析。</p><p>第6-1步，调用 <code>aspect_hookClass</code>：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>static Class aspect_hookClass(NSObject *self, NSError **error) {</span></span>
<span class="line"><span>    NSCParameterAssert(self);</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>   // 这里是比较容易混淆的地方</span></span>
<span class="line"><span>   // .class 方法，当 self 是一个 instance 的时候，返回 self 的类对象;</span></span>
<span class="line"><span>   // 当 self 是一个类对象的时候，返回它自身</span></span>
<span class="line"><span>   // object_getClass 方法则是获取 self 的 isa 指针指向的对象，如果self 是一个</span></span>
<span class="line"><span>   // instance，那么返回一个类对象;如果 self 是一个类对象，则返回一个元类</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>	Class statedClass = self.class;</span></span>
<span class="line"><span>	Class baseClass = object_getClass(self);</span></span>
<span class="line"><span>	NSString *className = NSStringFromClass(baseClass);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // Already subclassed</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>	if ([className hasSuffix:AspectsSubclassSuffix]) {</span></span>
<span class="line"><span>	   // AspectsSubclassSuffix是个 static 字符串常量，也就是_Aspects_</span></span>
<span class="line"><span>		return baseClass;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>	}else if (class_isMetaClass(baseClass)) {</span></span>
<span class="line"><span>        return aspect_swizzleClassInPlace((Class)self);</span></span>
<span class="line"><span>    }else if (statedClass != baseClass) {</span></span>
<span class="line"><span>        return aspect_swizzleClassInPlace(baseClass);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // 在原来的类名后加上_Aspects_后缀</span></span>
<span class="line"><span>	const char *subclassName = [className stringByAppendingString:AspectsSubclassSuffix].UTF8String;</span></span>
<span class="line"><span>	Class subclass = objc_getClass(subclassName);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>	if (subclass == nil) {</span></span>
<span class="line"><span>	   // 创建出一个新的 Class 出来，基本步骤有下面几个：</span></span>
<span class="line"><span>	   // 1. 通过objc_allocateClassPair来创建一个新的子类</span></span>
<span class="line"><span>	   // 2. 通过class_addMethod, class_addIvar来向新的子类添加方法和实例变量</span></span>
<span class="line"><span>	   // 3. 通过objc_registerClassPair来向运行时系统注册这个新类</span></span>
<span class="line"><span>	   // 完成以上3步后就可以使用这个新建的类了</span></span>
<span class="line"><span>	   </span></span>
<span class="line"><span>	   // subclass是 baseClass 的子类，类名是subclassName</span></span>
<span class="line"><span>		subclass = objc_allocateClassPair(baseClass, subclassName, 0);</span></span>
<span class="line"><span>		if (subclass == nil) {</span></span>
<span class="line"><span>            NSString *errrorDesc = [NSString stringWithFormat:@&quot;objc_allocateClassPair failed to allocate class %s.&quot;, subclassName];</span></span>
<span class="line"><span>            AspectError(AspectErrorFailedToAllocateClassPair, errrorDesc);</span></span>
<span class="line"><span>            return nil;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>      // 将新创建出来的类的forwardInvocation:方法替换成__ASPECTS_ARE_BEING_CALLED__方法，详见下面的注释</span></span>
<span class="line"><span>		aspect_swizzleForwardInvocation(subclass);</span></span>
<span class="line"><span>		// 替换subclass 的class 方法</span></span>
<span class="line"><span>		aspect_hookedGetClass(subclass, statedClass);</span></span>
<span class="line"><span>		// 替换subclass 的元类的class 方法</span></span>
<span class="line"><span>		aspect_hookedGetClass(object_getClass(subclass), statedClass);</span></span>
<span class="line"><span>		// 注册新创建出来的子类，现在可以使用了</span></span>
<span class="line"><span>		objc_registerClassPair(subclass);</span></span>
<span class="line"><span>	}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // 将 self 所属类的类型改为我们刚刚创建出来的带有_Aspects_后缀的类</span></span>
<span class="line"><span>    // 这里可以通过在 Xcode 中打断点来进行验证</span></span>
<span class="line"><span>	object_setClass(self, subclass);</span></span>
<span class="line"><span>	// 返回这个子类</span></span>
<span class="line"><span>	return subclass;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>static void aspect_swizzleForwardInvocation(Class klass) {</span></span>
<span class="line"><span>    NSCParameterAssert(klass);</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    // class_replaceMethod的第一个参数是要进行方法替换的 Class，第二个参数是被替换方法的 SEL，第三个参数是进行替换的方法的 IMP，第四个参数是类型编码，返回值是被替换的方法原来的 IMP。</span></span>
<span class="line"><span>    // 如果 Class 中没有要被替换的SEL，那么这个方法和class_addMethod 就是一样的</span></span>
<span class="line"><span>    IMP originalImplementation = class_replaceMethod(klass, @selector(forwardInvocation:), (IMP)__ASPECTS_ARE_BEING_CALLED__, &quot;v@:@&quot;);</span></span>
<span class="line"><span>    if (originalImplementation) {</span></span>
<span class="line"><span>        // 向 Class 中添加一个新的方法AspectsForwardInvocationSelectorName，也就是__aspects_forwardInvocation:，而它的IMP就是原来的forwardInvocation:的 IMP</span></span>
<span class="line"><span>        class_addMethod(klass, NSSelectorFromString(AspectsForwardInvocationSelectorName), originalImplementation, &quot;v@:@&quot;);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    AspectLog(@&quot;Aspects: %@ is now aspect aware.&quot;, NSStringFromClass(klass));</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>static void aspect_hookedGetClass(Class class, Class statedClass) {</span></span>
<span class="line"><span>    NSCParameterAssert(class);</span></span>
<span class="line"><span>    NSCParameterAssert(statedClass);</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>   // 获得class 原来的 class 方法</span></span>
<span class="line"><span>	Method method = class_getInstanceMethod(class, @selector(class));</span></span>
<span class="line"><span>	// 创建一个新的 IMP</span></span>
<span class="line"><span>	IMP newIMP = imp_implementationWithBlock(^(id self) {</span></span>
<span class="line"><span>		return statedClass;</span></span>
<span class="line"><span>	});</span></span>
<span class="line"><span>	// 将class 的实现用我们新创建的 IMP 来替换</span></span>
<span class="line"><span>	class_replaceMethod(class, @selector(class), newIMP, method_getTypeEncoding(method));</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第6-2步，调用了 <code>aspect_isMsgForwardIMP</code> 来判断我们要替换的 SEL 的 IMP 是不是 <code>_objc_msgForward</code>，如果不是才会进行第6-3、6-4步的操作</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>static BOOL aspect_isMsgForwardIMP(IMP impl) {</span></span>
<span class="line"><span>    return impl == _objc_msgForward</span></span>
<span class="line"><span>#if !defined(__arm64__)</span></span>
<span class="line"><span>    || impl == (IMP)_objc_msgForward_stret</span></span>
<span class="line"><span>#endif</span></span>
<span class="line"><span>    ;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第6-3步，创建出一个新的 selector，这个新的 selector 是由被替换的 selector 的字符串加上一个特定前缀字符串生成的，然后将它添加到上面新创建的类中：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>static SEL aspect_aliasForSelector(SEL selector) {</span></span>
<span class="line"><span>    NSCParameterAssert(selector);</span></span>
<span class="line"><span>	return NSSelectorFromString([AspectsMessagePrefix stringByAppendingFormat:@&quot;_%@&quot;, NSStringFromSelector(selector)]);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第6-4步，将 selector 对应的实现 IMP 替换为 <code>_objc_msgForward</code>：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>class_replaceMethod(klass, selector, aspect_getMsgForwardIMP(self, selector), typeEncoding);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>static IMP aspect_getMsgForwardIMP(NSObject *self, SEL selector) {</span></span>
<span class="line"><span>    IMP msgForwardIMP = _objc_msgForward;</span></span>
<span class="line"><span>#if !defined(__arm64__)</span></span>
<span class="line"><span>    // As an ugly internal runtime implementation detail in the 32bit runtime, we need to determine of the method we hook returns a struct or anything larger than id.</span></span>
<span class="line"><span>    // https://developer.apple.com/library/mac/documentation/DeveloperTools/Conceptual/LowLevelABI/000-Introduction/introduction.html</span></span>
<span class="line"><span>    // https://github.com/ReactiveCocoa/ReactiveCocoa/issues/783</span></span>
<span class="line"><span>    // http://infocenter.arm.com/help/topic/com.arm.doc.ihi0042e/IHI0042E_aapcs.pdf (Section 5.4)</span></span>
<span class="line"><span>    Method method = class_getInstanceMethod(self.class, selector);</span></span>
<span class="line"><span>    const char *encoding = method_getTypeEncoding(method);</span></span>
<span class="line"><span>    BOOL methodReturnsStructValue = encoding[0] == _C_STRUCT_B;</span></span>
<span class="line"><span>    if (methodReturnsStructValue) {</span></span>
<span class="line"><span>        @try {</span></span>
<span class="line"><span>            NSUInteger valueSize = 0;</span></span>
<span class="line"><span>            NSGetSizeAndAlignment(encoding, &amp;valueSize, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            if (valueSize == 1 || valueSize == 2 || valueSize == 4 || valueSize == 8) {</span></span>
<span class="line"><span>                methodReturnsStructValue = NO;</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        } @catch (__unused NSException *e) {}</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    if (methodReturnsStructValue) {</span></span>
<span class="line"><span>        msgForwardIMP = (IMP)_objc_msgForward_stret;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>#endif</span></span>
<span class="line"><span>    return msgForwardIMP;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>所以我们可以总结下第6步这个方法做了什么事情：</p><ol><li><p>创建了一个新的类，然后将这个新类的 <code>forwardInvocation:</code> 实现替换为了 <code>__ASPECTS_ARE_BEING_CALLED__</code>，并且将这个新类的类对象和元类的 class 修改为原来的类，最后将 self 所属的类修改为新类。</p></li><li><p>将 selector 对应的 IMP 实现替换为 <code>_objc_msgForward</code> 或 <code>_objc_msgForward_stret</code>。</p></li></ol><p>以上介绍的1~6步，完成了 Hook 的动作。</p><h2 id="aspects-are-being-called" tabindex="-1"><a class="header-anchor" href="#aspects-are-being-called"><span><strong>ASPECTS_ARE_BEING_CALLED</strong></span></a></h2><p>在被 Hook 的对象执行被替换的方法时，就会转而执行 <code>__ASPECTS_ARE_BEING_CALLED__</code> 这个方法。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>static void __ASPECTS_ARE_BEING_CALLED__(__unsafe_unretained NSObject *self, SEL selector, NSInvocation *invocation) {</span></span>
<span class="line"><span>    NSCParameterAssert(self);</span></span>
<span class="line"><span>    NSCParameterAssert(invocation);</span></span>
<span class="line"><span>    SEL originalSelector = invocation.selector;</span></span>
<span class="line"><span>    // 给invocation.selector 的 name 添加了aspects_前缀</span></span>
<span class="line"><span>	SEL aliasSelector = aspect_aliasForSelector(invocation.selector);</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>    invocation.selector = aliasSelector;</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    // AspectsContainer 和 SEL 是在第3步中通过关联对象技术关联到一起的</span></span>
<span class="line"><span>    AspectsContainer *objectContainer = objc_getAssociatedObject(self, aliasSelector);</span></span>
<span class="line"><span>    AspectsContainer *classContainer = aspect_getContainerForClass(object_getClass(self), aliasSelector);</span></span>
<span class="line"><span>    AspectInfo *info = [[AspectInfo alloc] initWithInstance:self invocation:invocation];</span></span>
<span class="line"><span>    NSArray *aspectsToRemove = nil;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // 在第5步中，根据 options 的设置，AspectIdentifier 会被加入到container 的 beforeAspects、insteadAspects或afterAspects中</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    // 先执行 Hook 时机为调用原方法之前的方法</span></span>
<span class="line"><span>    aspect_invoke(classContainer.beforeAspects, info);</span></span>
<span class="line"><span>    aspect_invoke(objectContainer.beforeAspects, info);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    BOOL respondsToAlias = YES;</span></span>
<span class="line"><span>    if (objectContainer.insteadAspects.count || classContainer.insteadAspects.count) {</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>        //如果 option 为替代原方法，那么这里执行替代方法，原方法不执行</span></span>
<span class="line"><span>        aspect_invoke(classContainer.insteadAspects, info);</span></span>
<span class="line"><span>        aspect_invoke(objectContainer.insteadAspects, info);</span></span>
<span class="line"><span>    }else {</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>        // 如果 option 不是替代原方法，那么在这里去执行原来的方法</span></span>
<span class="line"><span>        Class klass = object_getClass(invocation.target);</span></span>
<span class="line"><span>        do {</span></span>
<span class="line"><span>            // 我们在第6-3步中向新创建出的类通过class_addMethod添加了aliasSelector</span></span>
<span class="line"><span>            if ((respondsToAlias = [klass instancesRespondToSelector:aliasSelector])) {</span></span>
<span class="line"><span>                [invocation invoke];</span></span>
<span class="line"><span>                break;</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        }while (!respondsToAlias &amp;&amp; (klass = class_getSuperclass(klass)));</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // 原方法已经执行完了，在这里执行 Hook 时机为调用原方法之后的方法</span></span>
<span class="line"><span>    aspect_invoke(classContainer.afterAspects, info);</span></span>
<span class="line"><span>    aspect_invoke(objectContainer.afterAspects, info);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // 如果没有安装任何钩子函数（也就是没有进行方法 Hook），那么就调用原来的方法</span></span>
<span class="line"><span>    if (!respondsToAlias) {</span></span>
<span class="line"><span>        invocation.selector = originalSelector;</span></span>
<span class="line"><span>        SEL originalForwardInvocationSEL = NSSelectorFromString(AspectsForwardInvocationSelectorName);</span></span>
<span class="line"><span>        if ([self respondsToSelector:originalForwardInvocationSEL]) {</span></span>
<span class="line"><span>            ((void( *)(id, SEL, NSInvocation *))objc_msgSend)(self, originalForwardInvocationSEL, invocation);</span></span>
<span class="line"><span>        }else {</span></span>
<span class="line"><span>            [self doesNotRecognizeSelector:invocation.selector];</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    [aspectsToRemove makeObjectsPerformSelector:@selector(remove)];</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><p>总结下 Aspects Hook 方法的基本原理：</p><ol><li><p>将 selector 对应的 IMP 修改为 <code>_objc_msgForward</code> 或 <code>_objc_msgForward_stret</code>。这样在调用被 Hook 的 selector 时，会直接进入消息转发流程。</p></li><li><p>将 <code>forwardInvocation</code> 对应的 IMP 修改为 <code>__ASPECTS_ARE_BEING_CALLED__</code>。</p></li><li><p>在 <code>__ASPECTS_ARE_BEING_CALLED__</code> 中，调用原始实现并根据设置的 Hook 时机来执行额外的逻辑。</p></li></ol></div><!----><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/tamarous/blog/edit/master/docs/iOS/aspects_source_probe.md" aria-label="Edit this page" rel="noopener noreferrer" target="_blank" iconsizing="both"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page<!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">Last update: </span><span class="vp-meta-info" data-allow-mismatch="text">3/8/2025, 7:17:44 AM</span></div><div class="contributors"><span class="vp-meta-label">Contributors: </span><!--[--><!--[--><span class="vp-meta-info" title="email: hiwangzewei@qq.com">Tamarous</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link route-link-active auto-link prev" href="/blog/iOS/" aria-label="iOS 知识总结" iconsizing="both"><div class="hint"><span class="arrow start"></span>Prev</div><div class="link"><!---->iOS 知识总结</div></a><a class="route-link auto-link next" href="/blog/iOS/easytuple_source_probe.html" aria-label="EasyTuple 源代码分析" iconsizing="both"><div class="hint">Next<span class="arrow end"></span></div><div class="link">EasyTuple 源代码分析<!----></div></a></nav><!----><!----><!--]--></main><!--]--><!----></div><!--]--><!--]--><!--[--><!----><!--[--><!--]--><!--]--><!--]--></div>
    <script src="/blog/assets/js/runtime~app.0e81bbbf.js" defer></script><script src="/blog/assets/js/9826.a28e70bc.js" defer></script><script src="/blog/assets/js/app.45e041b4.js" defer></script>
  </body>
</html>
