<!doctype html>
<html lang="en-US" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.20" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.73" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <title>如何分析 iOS 系统库的实现 | Tamarous' blog</title><meta name="description" content="">
    <link rel="stylesheet" href="/blog/assets/css/styles.2f3457ba.css">
    <link rel="preload" href="/blog/assets/js/runtime~app.ed3f62ac.js" as="script"><link rel="preload" href="/blog/assets/css/styles.2f3457ba.css" as="style"><link rel="preload" href="/blog/assets/js/9826.a28e70bc.js" as="script"><link rel="preload" href="/blog/assets/js/app.3a63b824.js" as="script">
    <link rel="prefetch" href="/blog/assets/js/4543.db21e138.js" as="script"><link rel="prefetch" href="/blog/assets/js/3867.135c07f4.js" as="script"><link rel="prefetch" href="/blog/assets/js/5642.d4e3079d.js" as="script"><link rel="prefetch" href="/blog/assets/js/9684.36c9dfd9.js" as="script"><link rel="prefetch" href="/blog/assets/js/iOS_kscrash_monitor.html.ad2e6b2f.js" as="script"><link rel="prefetch" href="/blog/assets/js/6258.299cacea.js" as="script"><link rel="prefetch" href="/blog/assets/js/iOS_sdwebimage_cache.html.398e9458.js" as="script"><link rel="prefetch" href="/blog/assets/js/iOS_react_native_message_new.html.8743fb44.js" as="script"><link rel="prefetch" href="/blog/assets/js/Backend_golang_newbee_getting_better.html.f02fa40a.js" as="script"><link rel="prefetch" href="/blog/assets/js/5859.782de9c0.js" as="script"><link rel="prefetch" href="/blog/assets/js/4552.3421d4af.js" as="script"><link rel="prefetch" href="/blog/assets/js/iOS_easytuple_source_probe.html.b858f258.js" as="script"><link rel="prefetch" href="/blog/assets/js/5805.abe477a8.js" as="script"><link rel="prefetch" href="/blog/assets/js/1890.399757fe.js" as="script"><link rel="prefetch" href="/blog/assets/js/iOS_react_native_message_old.html.3ea118cf.js" as="script"><link rel="prefetch" href="/blog/assets/js/iOS_aspects_source_probe.html.f2e7129f.js" as="script"><link rel="prefetch" href="/blog/assets/js/8300.db4e9dba.js" as="script"><link rel="prefetch" href="/blog/assets/js/9497.685f33e6.js" as="script"><link rel="prefetch" href="/blog/assets/js/iOS_stinger_source_probe.html.380c5468.js" as="script"><link rel="prefetch" href="/blog/assets/js/iOS_masonry_source_probe.html.a966a2c8.js" as="script"><link rel="prefetch" href="/blog/assets/js/iOS_react_native_new_arch.html.3a33b017.js" as="script"><link rel="prefetch" href="/blog/assets/js/iOS_ios_exception_handling.html.48526634.js" as="script"><link rel="prefetch" href="/blog/assets/js/866.877af9b5.js" as="script"><link rel="prefetch" href="/blog/assets/js/8112.3e8a2e5b.js" as="script"><link rel="prefetch" href="/blog/assets/js/1700.c3ca9790.js" as="script"><link rel="prefetch" href="/blog/assets/js/7601.7053345b.js" as="script"><link rel="prefetch" href="/blog/assets/js/5118.7a025bf9.js" as="script"><link rel="prefetch" href="/blog/assets/js/6850.da3de4d6.js" as="script"><link rel="prefetch" href="/blog/assets/js/9605.050537c5.js" as="script"><link rel="prefetch" href="/blog/assets/js/Backend_gopool.html.33b7f292.js" as="script"><link rel="prefetch" href="/blog/assets/js/6675.7c532e0e.js" as="script"><link rel="prefetch" href="/blog/assets/js/6772.fc35ef33.js" as="script"><link rel="prefetch" href="/blog/assets/js/5153.15bfe516.js" as="script"><link rel="prefetch" href="/blog/assets/js/8605.edb3efbf.js" as="script"><link rel="prefetch" href="/blog/assets/js/iOS_dyld_shared_cache.html.458f8f7b.js" as="script"><link rel="prefetch" href="/blog/assets/js/2277.737f1127.js" as="script"><link rel="prefetch" href="/blog/assets/js/48.ec8dd276.js" as="script"><link rel="prefetch" href="/blog/assets/js/3668.aeb97ab9.js" as="script"><link rel="prefetch" href="/blog/assets/js/1454.bc727b68.js" as="script"><link rel="prefetch" href="/blog/assets/js/6934.9efad61f.js" as="script"><link rel="prefetch" href="/blog/assets/js/2909.f8e7de24.js" as="script"><link rel="prefetch" href="/blog/assets/js/1587.4e965713.js" as="script"><link rel="prefetch" href="/blog/assets/js/iOS_index.html.fd3907d0.js" as="script"><link rel="prefetch" href="/blog/assets/js/Backend_index.html.9e738c04.js" as="script"><link rel="prefetch" href="/blog/assets/js/index.html.e50f244d.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_基础知识_index.html.4bd538e5.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_技术原理_index.html.8573cecf.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_源码分析_index.html.6271cb07.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_稳定性_index.html.48ff18b3.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_backend_index.html.32a96c29.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_ios_index.html.a64fc2cc.js" as="script"><link rel="prefetch" href="/blog/assets/js/3092.e0fe3b9a.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_index.html.8f678229.js" as="script"><link rel="prefetch" href="/blog/assets/js/timeline_index.html.187973aa.js" as="script"><link rel="prefetch" href="/blog/assets/js/article_index.html.708ae602.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_index.html.195946eb.js" as="script"><link rel="prefetch" href="/blog/assets/js/star_index.html.9229234c.js" as="script"><link rel="prefetch" href="/blog/assets/js/404.html.956448a4.js" as="script"><link rel="prefetch" href="/blog/assets/js/8088.ee029265.js" as="script"><link rel="prefetch" href="/blog/assets/js/1250.a8a06209.js" as="script"><link rel="prefetch" href="/blog/assets/js/5284.e7a0004f.js" as="script"><link rel="prefetch" href="/blog/assets/js/7322.e2e32153.js" as="script"><link rel="prefetch" href="/blog/assets/js/5720.8a9f600f.js" as="script"><link rel="prefetch" href="/blog/assets/js/834.92828c75.js" as="script"><link rel="prefetch" href="/blog/assets/js/1439.2a99a211.js" as="script"><link rel="prefetch" href="/blog/assets/js/6817.5a343664.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">Skip to main content</a><!--]--><!--[--><div class="theme-container external-link-icon has-toc" vp-container><!--[--><header id="navbar" class="vp-navbar" vp-navbar><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><a class="route-link vp-brand" href="/blog/" aria-label="Take me home"><!----><!----><span class="vp-site-name">Tamarous&#39; blog</span></a><!--]--></div><div class="vp-navbar-center"><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/blog/" aria-label="Home" iconsizing="height"><!---->Home<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link route-link-active auto-link" href="/blog/iOS/" aria-label="iOS" iconsizing="height"><!---->iOS<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/blog/Backend/" aria-label="Backend" iconsizing="height"><!---->Backend<!----></a></div></nav><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!----><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-color-mode-switch" id="color-mode-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" name="auto" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" name="dark" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" name="light" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/blog/" aria-label="/" iconsizing="both"><!---->/<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">iOS 知识总结</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/blog/iOS/" aria-label="iOS 知识总结" iconsizing="both"><!---->iOS 知识总结<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/blog/iOS/aspects_source_probe.html" aria-label="Aspects 源码分析" iconsizing="both"><!---->Aspects 源码分析<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/blog/iOS/easytuple_source_probe.html" aria-label="EasyTuple 源代码分析" iconsizing="both"><!---->EasyTuple 源代码分析<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/blog/iOS/ios_exception_handling.html" aria-label="iOS 异常捕获原理" iconsizing="both"><!---->iOS 异常捕获原理<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/blog/iOS/kscrash_monitor.html" aria-label="KSCrash 实现原理 - 监控系统实现" iconsizing="both"><!---->KSCrash 实现原理 - 监控系统实现<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/blog/iOS/masonry_source_probe.html" aria-label="Masonry 源码解析：优雅的自动布局方案" iconsizing="both"><!---->Masonry 源码解析：优雅的自动布局方案<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/blog/iOS/react_native_new_arch.html" aria-label="React Native 新架构学习" iconsizing="both"><!---->React Native 新架构学习<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/blog/iOS/react_native_message_new.html" aria-label="React Native 通信机制详解 - 新架构" iconsizing="both"><!---->React Native 通信机制详解 - 新架构<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/blog/iOS/react_native_message_old.html" aria-label="React Native 通信机制详解 - 旧架构" iconsizing="both"><!---->React Native 通信机制详解 - 旧架构<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/blog/iOS/sdwebimage_cache.html" aria-label="SDWebImage 源代码剖析 - 缓存策略" iconsizing="both"><!---->SDWebImage 源代码剖析 - 缓存策略<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/blog/iOS/stinger_source_probe.html" aria-label="Stinger 源码分析" iconsizing="both"><!---->Stinger 源码分析<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/blog/iOS/dyld_shared_cache.html" aria-label="如何分析 iOS 系统库的实现" iconsizing="both"><!---->如何分析 iOS 系统库的实现<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">后端精进之路</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->如何分析 iOS 系统库的实现</h1><!----><hr></div><!----><!----><div class="theme-hope-content" vp-content><h1 id="如何分析-ios-系统库的实现" tabindex="-1"><a class="header-anchor" href="#如何分析-ios-系统库的实现"><span>如何分析 iOS 系统库的实现</span></a></h1><h2 id="背景" tabindex="-1"><a class="header-anchor" href="#背景"><span>背景</span></a></h2><p>在 iOS 应用的 crash 治理过程中，有相当一大部分问题最终的堆栈是在系统库之中的，因此为了解决这些问题，就需要通过逆向手段来分析系统库的内在逻辑，找到 crash 发生的原因。本文介绍如何利用 <code>dyld_shared_cache</code> 和 <a href="https://www.hopperapp.com/" target="_blank" rel="noopener noreferrer">Hopper</a> 进行分析。</p><h2 id="获取系统库二进制文件" tabindex="-1"><a class="header-anchor" href="#获取系统库二进制文件"><span>获取系统库二进制文件</span></a></h2><h3 id="从真机上获取系统库" tabindex="-1"><a class="header-anchor" href="#从真机上获取系统库"><span>从真机上获取系统库</span></a></h3><p>进行逆向分析的第一步，是获取系统库的二进制文件。如果你有一台 iPhone 设备，并且你要分析的 crash 就发生在这个设备或者这个设备对应的系统版本上，那么获取系统库二进制文件就非常简单，只需将设备连接到 Mac 上，然后在 Xcode 中将它选中作为 Build Target，Xcode 就会从 iPhone 中拷贝出所需的文件。</p><p><img src="https://tamarous-blog-1256169911.cos.ap-chengdu.myqcloud.com/2021/12/15/16395763851488.jpg" alt="16395763851488"></p><p>这些文件会被拷贝到在 <code>~/Library/Developer/Xcode/iOS DeviceSupport/</code> 目录下，按照设备系统版本分门别类存储，如图所示：</p><p><img src="https://tamarous-blog-1256169911.cos.ap-chengdu.myqcloud.com/2021/12/15/16395771725307.jpg" alt="16395771725307"></p><h3 id="获取-dyld-shared-cache" tabindex="-1"><a class="header-anchor" href="#获取-dyld-shared-cache"><span>获取 dyld_shared_cache</span></a></h3><p>但是如果你手边没有问题发生系统的设备，比如线上突发了一个老系统的 crash ，那么这时我们就需要通过 <code>dyld_shared_cache</code> 来进行提取了。</p><p>在 iOS 3.1 后，为了加快应用的启动速度，dyld 将所有系统框架的二进制都打包到了一个大的缓存文件中，在系统启动之后就会进行加载，这个文件就称为 <code>dyld_shared_cache</code>。</p><h4 id="从-ipsw-中获取" tabindex="-1"><a class="header-anchor" href="#从-ipsw-中获取"><span>从 ipsw 中获取</span></a></h4><p><code>dyld_shared_cache</code> 能够从 ipsw 文件中获得。在 <a href="https://ipsw.me/" target="_blank" rel="noopener noreferrer">ipsw.me</a> 上可以下载各种 iOS 设备及各种 iOS 系统 的 ipsw 文件。下载之后，将该文件的后缀名改为 .zip，然后进行解压。在解压后的文件夹里，双击其中文件体积最大的 dmg 文件，然后进入 <code>/System/Library/Caches/com.apple.dyld/</code>，就可以将 <code>dyld_shared_cache</code> 复制导出了。</p><p><img src="https://tamarous-blog-1256169911.cos.ap-chengdu.myqcloud.com/2021/12/04/16386267613890.jpg" alt="16386267613890"></p><h3 id="还原-dyld-shared-cache" tabindex="-1"><a class="header-anchor" href="#还原-dyld-shared-cache"><span>还原 dyld_shared_cache</span></a></h3><p>在导出后，还需要一些工具来将系统库从二进制文件中还原出来。苹果官方就提供了一个可用的工具：<a href="https://opensource.apple.com/source/dyld/dyld-433.5/launch-cache/" target="_blank" rel="noopener noreferrer">dsc_extractor</a>，不过这个工具是位于 dyld 源码中的，需要一些额外设置才能编译出来。</p><p>首先我们先从苹果开源网站上下载 dyld 的<a href="https://opensource.apple.com/tarballs/dyld/" target="_blank" rel="noopener noreferrer">代码</a>，我这里选择的是较旧的 <code>dyld-519.2.2</code>，之所以不选最新的版本，是由于较新的版本在编译时，会有<code>CodeSigningTypes.h</code> 和 <code>Diagnostics.h</code> 两个头文件找不到的错误。下载解压后，进入 <code>launch-cache</code> 目录，修改 <code>dsc_extractor.cpp</code> main 函数之前的 <code>if 0</code> 为 <code>if 1</code>，然后再用 clang 进行编译：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>clang++ -o dsc_extractor ./dsc_extractor.cpp dsc_iterator.cpp</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>编译出可执行文件后，我们就可以使用此可执行文件来从 <code>dyld_shared_cache</code> 中导出系统库：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>./dsc_extractor dyld_shared_cache_arm64e ./frameworks</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="https://tamarous-blog-1256169911.cos.ap-chengdu.myqcloud.com/2021/12/04/16386332421419.jpg" alt="16386332421419"></p><p>如果上述过程显得过于繁琐，<a href="https://github.com/dreampiggy/dsc_extractor/blob/master/bin/dsc_extractor" target="_blank" rel="noopener noreferrer">GitHub</a> 上也有人提供了编译好的 dsc_extractor 可供直接下载使用。</p><p>除了上述苹果官方提供的工具外，<a href="https://github.com/arandomdev/DyldExtractor" target="_blank" rel="noopener noreferrer">DyldExtractor</a> 也是一个不错的工具：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>python3 -m pip install dyldextractor</span></span>
<span class="line"><span>dyldex_all dyld_shared_cache_arm64e</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>在获取到系统库的二进制之后，就可以使用如 Hopper 及 IDA 这样的工具来进行逆向分析了。</p><h2 id="使用-hopper-进行分析" tabindex="-1"><a class="header-anchor" href="#使用-hopper-进行分析"><span>使用 Hopper 进行分析</span></a></h2><p>Hopper 是一个知名的反汇编软件，功能非常强大，尤其是对于 Objective-C 的反汇编专门进行了优化，能够从二进制中生成较为易读的伪代码，因此对于分析 iOS 系统库执行过程来说，是一件神兵利器。Hopper 是一个收费软件，不付费的话每次可以免费使用 30 分钟，对于一般的分析问题来说也够用了。推荐大家尽量支持正版。</p><p>下面用一个真实的线上案例来介绍下 Hopper 的使用。系统堆栈如下：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>Thread 0 name:  com.apple.main-thread</span></span>
<span class="line"><span>Thread 0: Crashed:</span></span>
<span class="line"><span>0   libobjc.A.dylib                 0x000000018ac37530 _objc_msgSend (in libobjc.A.dylib) + 16</span></span>
<span class="line"><span>1   UIKitCore                       0x00000001b80b6058 -[UIKeyboardImpl _keyboardBehaviorState] (in UIKitCore) + 436</span></span>
<span class="line"><span>2   UIKitCore                       0x00000001b80b63c4 -[UIKeyboardImpl updatedKeyBehaviors] (in UIKitCore) + 32</span></span>
<span class="line"><span>3   UIKitCore                       0x00000001b80b64f8 -[UIKeyboardImpl _updateKeyboardConfigurations] (in UIKitCore) + 172</span></span>
<span class="line"><span>4   UIKitCore                       0x00000001b809240c -[UIKeyboardImpl dealloc] (in UIKitCore) + 356</span></span>
<span class="line"><span>5   UIKitCore                       0x00000001b80c2ae8 -[UIKeyboardInputManagerMux setResponseDelegate:] (in UIKitCore) + 64</span></span>
<span class="line"><span>6   UIKitCore                       0x00000001b80a881c -[UIKeyboardImpl setInputManagerFromCurrentInputMode] (in UIKitCore) + 96</span></span>
<span class="line"><span>7   UIKitCore                       0x00000001b8097d4c -[UIKeyboardImpl setInputModeFromPreferences] (in UIKitCore) + 360</span></span>
<span class="line"><span>8   UIKitCore                       0x00000001b8091d3c -[UIKeyboardImpl initWithFrame:] (in UIKitCore) + 840</span></span>
<span class="line"><span>9   UIKitCore                       0x00000001b808f950 +[UIKeyboardImpl sharedInstance] (in UIKitCore) + 72</span></span>
<span class="line"><span>10  UIKitCore                       0x00000001b8083c50 -[UIKeyboard activate] (in UIKitCore) + 248</span></span>
<span class="line"><span>11  UIKitCore                       0x00000001b80fa98c -[UIKeyboardAutomatic activate] (in UIKitCore) + 124</span></span>
<span class="line"><span>12  UIKitCore                       0x00000001b80fa514 -[UIKeyboardAutomatic willResume:] (in UIKitCore) + 260</span></span>
<span class="line"><span>13  CoreFoundation                  0x000000018b9b8218 ___CFNOTIFICATIONCENTER_IS_CALLING_OUT_TO_AN_OBSERVER__ (in CoreFoundation) + 16</span></span>
<span class="line"><span>14  CoreFoundation                  0x000000018b9b81e4 ____CFXRegistrationPost_block_invoke (in CoreFoundation) + 60</span></span>
<span class="line"><span>15  CoreFoundation                  0x000000018b9b76d8 __CFXRegistrationPost (in CoreFoundation) + 388</span></span>
<span class="line"><span>16  CoreFoundation                  0x000000018b9b7384 ____CFXNotificationPost_block_invoke (in CoreFoundation) + 92</span></span>
<span class="line"><span>17  CoreFoundation                  0x000000018b930c50 -[_CFXNotificationRegistrar find:object:observer:enumerator:] (in CoreFoundation) + 1492</span></span>
<span class="line"><span>18  CoreFoundation                  0x000000018b9b6e34 __CFXNotificationPost (in CoreFoundation) + 692</span></span>
<span class="line"><span>19  Foundation                      0x000000018c3a01a0 -[NSNotificationCenter postNotificationName:object:userInfo:] (in Foundation) + 64</span></span>
<span class="line"><span>20  UIKitCore                       0x00000001b827cf7c -[UIApplication _sendWillEnterForegroundCallbacks] (in UIKitCore) + 228</span></span>
<span class="line"><span>21  UIKitCore                       0x00000001b7b27be0 -[__UICanvasLifecycleMonitor_Compatability activateEventsOnly:withContext:completion:] (in UIKitCore) + 2032</span></span>
<span class="line"><span>22  UIKitCore                       0x00000001b7b25b60 ___82-[_UIApplicationCanvas _transitionLifecycleStateWithTransitionContext:completion:]_block_invoke (in UIKitCore) + 740</span></span>
<span class="line"><span>23  UIKitCore                       0x00000001b7b25828 -[_UIApplicationCanvas _transitionLifecycleStateWithTransitionContext:completion:] (in UIKitCore) + 424</span></span>
<span class="line"><span>24  UIKitCore                       0x00000001b7b2a368 ___125-[_UICanvasLifecycleSettingsDiffAction performActionsForCanvas:withUpdatedScene:settingsDiff:fromSettings:transitionContext:]_block_invoke (in UIKitCore) + 216</span></span>
<span class="line"><span>25  UIKitCore                       0x00000001b7b2b14c __performActionsWithDelayForTransitionContext (in UIKitCore) + 108</span></span>
<span class="line"><span>26  UIKitCore                       0x00000001b7b2a220 -[_UICanvasLifecycleSettingsDiffAction performActionsForCanvas:withUpdatedScene:settingsDiff:fromSettings:transitionContext:] (in UIKitCore) + 240</span></span>
<span class="line"><span>27  UIKitCore                       0x00000001b7b2ef20 -[_UICanvas scene:didUpdateWithDiff:transitionContext:completion:] (in UIKitCore) + 356</span></span>
<span class="line"><span>28  UIKitCore                       0x00000001b7e5f2ac -[UIApplicationSceneClientAgent scene:handleEvent:withCompletion:] (in UIKitCore) + 460</span></span>
<span class="line"><span>29  FrontBoardServices              0x000000018e3c55d4 ___80-[FBSSceneImpl updater:didUpdateSettings:withDiff:transitionContext:completion:]_block_invoke_3 (in FrontBoardServices) + 220</span></span>
<span class="line"><span>30  libdispatch.dylib               0x000000018b4857d0 __dispatch_client_callout (in libdispatch.dylib) + 12</span></span>
<span class="line"><span>31  libdispatch.dylib               0x000000018b42a5d8 __dispatch_block_invoke_direct$VARIANT$mp (in libdispatch.dylib) + 220</span></span>
<span class="line"><span>32  FrontBoardServices              0x000000018e3ff03c ___FBSSERIALQUEUE_IS_CALLING_OUT_TO_A_BLOCK__ (in FrontBoardServices) + 36</span></span>
<span class="line"><span>33  FrontBoardServices              0x000000018e3fecd8 -[FBSSerialQueue _performNext] (in FrontBoardServices) + 404</span></span>
<span class="line"><span>34  FrontBoardServices              0x000000018e3ff290 -[FBSSerialQueue _performNextFromRunLoopSource] (in FrontBoardServices) + 48</span></span>
<span class="line"><span>35  CoreFoundation                  0x000000018b9d8f18 ___CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__ (in CoreFoundation) + 20</span></span>
<span class="line"><span>36  CoreFoundation                  0x000000018b9d8e98 ___CFRunLoopDoSource0 (in CoreFoundation) + 84</span></span>
<span class="line"><span>37  CoreFoundation                  0x000000018b9d8780 ___CFRunLoopDoSources0 (in CoreFoundation) + 172</span></span>
<span class="line"><span>38  CoreFoundation                  0x000000018b9d36bc ___CFRunLoopRun (in CoreFoundation) + 1000</span></span>
<span class="line"><span>39  CoreFoundation                  0x000000018b9d2fb0 _CFRunLoopRunSpecific (in CoreFoundation) + 432</span></span>
<span class="line"><span>40  GraphicsServices                0x000000018dbd5798 _GSEventRunModal (in GraphicsServices) + 100</span></span>
<span class="line"><span>41  UIKitCore                       0x00000001b8265c34 _UIApplicationMain (in UIKitCore) + 208</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从堆栈上来看，crash 发生在给 <code>UIKeyboardImpl</code> 的实例发送 <code>_keyboardBehaviorState</code> 消息时，用户设备是 iPhone 6，对应系统版本为 12.5.5。</p><p>按照前文方法，通过 ipsw 提取出 12.5.5 系统的 <code>UIKitCore.dylib</code>，然后将其拖入 Hopper。在拖入时，会询问需要以什么文件格式打开，一般来说以默认设置打开就好。然后在左侧面板搜索栏中，输入<code>-[UIKeyboardImpl _keyboardBehaviorState]</code>，会跳转到这个方法对应的汇编代码：</p><p><img src="https://tamarous-blog-1256169911.cos.ap-chengdu.myqcloud.com/2021/12/15/16395806199187.jpg" alt="16395806199187"> 可以看到，这个方法的汇编实现是非常复杂的，在自动生成的注释中，有很多个 <code>objc_msgSend</code>，说明这个方法内部也有很多其他的方法调用。那么内部是对给哪个对象发送消息时 crash 的呢？</p><p>此处，我们就需要结合用户的 crash 日志来进行分析。从我们的 APM 系统上可以下载到这个用户的原始日志，以及符号解析后的日志，这两份日志都可以用来进行更为细致的分析。</p><p>原始日志如下：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>Thread 0 name:  com.apple.main-thread</span></span>
<span class="line"><span>Thread 0 Crashed:</span></span>
<span class="line"><span>0   libobjc.A.dylib                 0x000000018ac37530 0x18ac1a000 + 120112 ((null)) + 0)</span></span>
<span class="line"><span>1   UIKitCore                       0x00000001b80b605c 0x1b79a9000 + 7393372 ((null)) + 0)</span></span>
<span class="line"><span>2   UIKitCore                       0x00000001b80b63c8 0x1b79a9000 + 7394248 ((null)) + 0)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从原始日志中，我们可以直接得到调用 objc_msgSend 的位置在<code> -[UIKeyboardImpl _keyboardBehaviorState]</code> 中的偏移量为 <code>7393372</code>。</p><p>或者从符号解析后的日志中：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>Thread 0 name:  com.apple.main-thread</span></span>
<span class="line"><span>Thread 0: Crashed:</span></span>
<span class="line"><span>0   libobjc.A.dylib                 0x000000018ac37530 _objc_msgSend (in libobjc.A.dylib) + 16</span></span>
<span class="line"><span>1   UIKitCore                       0x00000001b80b6058 -[UIKeyboardImpl _keyboardBehaviorState] (in UIKitCore) + 436</span></span>
<span class="line"><span>2   UIKitCore                       0x00000001b80b63c4 -[UIKeyboardImpl updatedKeyBehaviors] (in UIKitCore) + 32</span></span>
<span class="line"><span>3   UIKitCore                       0x00000001b80b64f8 -[UIKeyboardImpl _updateKeyboardConfigurations] (in UIKitCore) + 172</span></span>
<span class="line"><span>4   UIKitCore                       0x00000001b809240c -[UIKeyboardImpl dealloc] (in UIKitCore) + 356</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>Binary Images:</span></span>
<span class="line"><span>       0x1b79a9000 -        0x1b8a8dfff  UIKitCore arm64 &lt;005cfa346e6a3f36ba96e3db92f09362&gt; /System/Library/PrivateFrameworks/UIKitCore.framework/UIKitCore</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以计算出偏移地址为</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>0x00000001b80b6058 - 0x1b79a9000 = 0x70D058 = 7393368</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>得到了偏移量之后，在 Hopper 中点击 <code>Navigate -&gt; Go To File Offset</code>，在弹出的输入框中输入上述偏移量，就可以跳转到 crash 发生时的具体行数，如图中蓝色行所示：</p><p><img src="https://tamarous-blog-1256169911.cos.ap-chengdu.myqcloud.com/2021/12/16/16395840700261.jpg" alt="16395840700261"></p><p>点击 Hopper 右上角按钮，</p><p><img src="https://tamarous-blog-1256169911.cos.ap-chengdu.myqcloud.com/2021/12/16/16395841682241.jpg" alt="16395841682241"></p><p>即可将这段汇编代码转换为伪代码：</p><p><img src="https://tamarous-blog-1256169911.cos.ap-chengdu.myqcloud.com/2021/12/16/16395843037293.jpg" alt="16395843037293"></p><p>从图中我们可以看到，是在向 <code>UIKeyboardImpl</code> 的 <code>m_candidateResultSet</code> 实例变量发送 <code>hasCandidates</code> 消息时崩溃了。因此我们需要继续去分析这个实例变量的赋值及使用场景，看看是不是存在野指针的可能性，其分析过程也是类似的。</p><p>以上即为使用 Hopper 来分析系统库内部实现的思路。</p></div><!----><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/tamarous/blog/edit/master/docs/iOS/dyld_shared_cache.md" aria-label="Edit this page" rel="noopener noreferrer" target="_blank" iconsizing="both"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page<!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">Last update: </span><span class="vp-meta-info" data-allow-mismatch="text">3/16/2025, 8:28:28 AM</span></div><div class="contributors"><span class="vp-meta-label">Contributors: </span><!--[--><!--[--><span class="vp-meta-info" title="email: hiwangzewei@qq.com">Tamarous</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/blog/iOS/stinger_source_probe.html" aria-label="Stinger 源码分析" iconsizing="both"><div class="hint"><span class="arrow start"></span>Prev</div><div class="link"><!---->Stinger 源码分析</div></a><!----></nav><!----><!----><!--]--></main><!--]--><!----></div><!--]--><!--]--><!--[--><!----><!--[--><!--]--><!--]--><!--]--></div>
    <script src="/blog/assets/js/runtime~app.ed3f62ac.js" defer></script><script src="/blog/assets/js/9826.a28e70bc.js" defer></script><script src="/blog/assets/js/app.3a63b824.js" defer></script>
  </body>
</html>
